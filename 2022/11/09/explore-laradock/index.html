<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Laradock 学习笔记 | ZYF.IM BLOG</title>
<meta name=keywords content="php,docker"><meta name=description content='Laradock 简介
Laradock 是一个基于 Docker 的完整 PHP 开发环境，专为 PHP 开发者（特别是 Laravel 开发者）设计。它提供了一套预配置的 Docker 容器，包含开发中常用的服务，如 Nginx、MySQL、Redis、PHP-FPM 等。
主要优势

开箱即用：预配置的开发环境，无需繁琐设置
一致性：确保开发、测试和生产环境的一致性
灵活性：支持多种 PHP 版本和扩展
模块化：可以根据需要启用或禁用特定服务
跨平台：在 Windows、macOS 和 Linux 上表现一致

基本架构
Laradock 采用模块化设计，每个服务都运行在独立的容器中，通过 Docker 网络连接：

Workspace：包含开发工具的容器
PHP-FPM：PHP 解释器
Nginx/Apache：Web 服务器
MySQL/PostgreSQL/MongoDB：数据库
Redis/Memcached：缓存
其他辅助服务（邮件服务器、消息队列等）

Dockerfile
DEBIAN_FRONTEND
ENV DEBIAN_FRONTEND=noninteractive
DEBIAN_FRONTEND 环境变量用于告知操作系统应该从哪儿获得用户输入。
设置为 &ldquo;noninteractive&rdquo; 可以实现自动安装而无需用户交互，对于 CI/CD 流程和 Docker 构建特别有用。这在运行 apt-get 命令时尤为重要，因为它会自动选择默认选项并以最快速度完成构建。
最佳实践是在 RUN 命令中设置该变量，而不是使用 ENV 进行全局设置，因为全局设置会影响容器运行时的交互体验：
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y ...
基于角色的用户配置
# 创建非 root 用户防止文件在宿主机上创建时具有 root 权限
ARG PUID=1000
ENV PUID ${PUID}
ARG PGID=1000
ENV PGID ${PGID}

RUN set -xe; \
    groupadd -g ${PGID} laradock && \
    useradd -l -u ${PUID} -g laradock -m laradock -G docker_env && \
    usermod -p "*" laradock -s /bin/bash
这段配置创建了一个非 root 用户 laradock，解决了容器和宿主机之间文件权限问题：'><meta name=author content="Me, LLM"><link rel=canonical href=https://zyf.im/2022/11/09/explore-laradock/><link crossorigin=anonymous href=/assets/css/stylesheet.eb010ba19da259e1633d31a246087e3b0656d556c30406763ea24160333d238f.css integrity="sha256-6wELoZ2iWeFjPTGiRgh+OwZW1VbDBAZ2PqJBYDM9I48=" rel="preload stylesheet" as=style><link rel=icon href=https://zyf.im/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zyf.im/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zyf.im/favicon-32x32.png><link rel=apple-touch-icon href=https://zyf.im/apple-touch-icon.png><link rel=mask-icon href=https://zyf.im/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zyf.im/2022/11/09/explore-laradock/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6DVZ6E58DG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6DVZ6E58DG")}</script><meta property="og:url" content="https://zyf.im/2022/11/09/explore-laradock/"><meta property="og:site_name" content="ZYF.IM BLOG"><meta property="og:title" content="Laradock 学习笔记"><meta property="og:description" content='Laradock 简介 Laradock 是一个基于 Docker 的完整 PHP 开发环境，专为 PHP 开发者（特别是 Laravel 开发者）设计。它提供了一套预配置的 Docker 容器，包含开发中常用的服务，如 Nginx、MySQL、Redis、PHP-FPM 等。
主要优势 开箱即用：预配置的开发环境，无需繁琐设置 一致性：确保开发、测试和生产环境的一致性 灵活性：支持多种 PHP 版本和扩展 模块化：可以根据需要启用或禁用特定服务 跨平台：在 Windows、macOS 和 Linux 上表现一致 基本架构 Laradock 采用模块化设计，每个服务都运行在独立的容器中，通过 Docker 网络连接：
Workspace：包含开发工具的容器 PHP-FPM：PHP 解释器 Nginx/Apache：Web 服务器 MySQL/PostgreSQL/MongoDB：数据库 Redis/Memcached：缓存 其他辅助服务（邮件服务器、消息队列等） Dockerfile DEBIAN_FRONTEND ENV DEBIAN_FRONTEND=noninteractive DEBIAN_FRONTEND 环境变量用于告知操作系统应该从哪儿获得用户输入。
设置为 “noninteractive” 可以实现自动安装而无需用户交互，对于 CI/CD 流程和 Docker 构建特别有用。这在运行 apt-get 命令时尤为重要，因为它会自动选择默认选项并以最快速度完成构建。
最佳实践是在 RUN 命令中设置该变量，而不是使用 ENV 进行全局设置，因为全局设置会影响容器运行时的交互体验：
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y ... 基于角色的用户配置 # 创建非 root 用户防止文件在宿主机上创建时具有 root 权限 ARG PUID=1000 ENV PUID ${PUID} ARG PGID=1000 ENV PGID ${PGID} RUN set -xe; \ groupadd -g ${PGID} laradock && \ useradd -l -u ${PUID} -g laradock -m laradock -G docker_env && \ usermod -p "*" laradock -s /bin/bash 这段配置创建了一个非 root 用户 laradock，解决了容器和宿主机之间文件权限问题：'><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-09T22:24:01+00:00"><meta property="article:modified_time" content="2022-11-09T22:24:01+00:00"><meta property="article:tag" content="Php"><meta property="article:tag" content="Docker"><meta property="og:image" content="https://images.unsplash.com/photo-1663428520845-056989f8a664?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=960&amp;q=80"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1663428520845-056989f8a664?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=960&amp;q=80"><meta name=twitter:title content="Laradock 学习笔记"><meta name=twitter:description content='Laradock 简介
Laradock 是一个基于 Docker 的完整 PHP 开发环境，专为 PHP 开发者（特别是 Laravel 开发者）设计。它提供了一套预配置的 Docker 容器，包含开发中常用的服务，如 Nginx、MySQL、Redis、PHP-FPM 等。
主要优势

开箱即用：预配置的开发环境，无需繁琐设置
一致性：确保开发、测试和生产环境的一致性
灵活性：支持多种 PHP 版本和扩展
模块化：可以根据需要启用或禁用特定服务
跨平台：在 Windows、macOS 和 Linux 上表现一致

基本架构
Laradock 采用模块化设计，每个服务都运行在独立的容器中，通过 Docker 网络连接：

Workspace：包含开发工具的容器
PHP-FPM：PHP 解释器
Nginx/Apache：Web 服务器
MySQL/PostgreSQL/MongoDB：数据库
Redis/Memcached：缓存
其他辅助服务（邮件服务器、消息队列等）

Dockerfile
DEBIAN_FRONTEND
ENV DEBIAN_FRONTEND=noninteractive
DEBIAN_FRONTEND 环境变量用于告知操作系统应该从哪儿获得用户输入。
设置为 &ldquo;noninteractive&rdquo; 可以实现自动安装而无需用户交互，对于 CI/CD 流程和 Docker 构建特别有用。这在运行 apt-get 命令时尤为重要，因为它会自动选择默认选项并以最快速度完成构建。
最佳实践是在 RUN 命令中设置该变量，而不是使用 ENV 进行全局设置，因为全局设置会影响容器运行时的交互体验：
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y ...
基于角色的用户配置
# 创建非 root 用户防止文件在宿主机上创建时具有 root 权限
ARG PUID=1000
ENV PUID ${PUID}
ARG PGID=1000
ENV PGID ${PGID}

RUN set -xe; \
    groupadd -g ${PGID} laradock && \
    useradd -l -u ${PUID} -g laradock -m laradock -G docker_env && \
    usermod -p "*" laradock -s /bin/bash
这段配置创建了一个非 root 用户 laradock，解决了容器和宿主机之间文件权限问题：'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zyf.im/posts/"},{"@type":"ListItem","position":2,"name":"Laradock 学习笔记","item":"https://zyf.im/2022/11/09/explore-laradock/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Laradock 学习笔记","name":"Laradock 学习笔记","description":"Laradock 简介 Laradock 是一个基于 Docker 的完整 PHP 开发环境，专为 PHP 开发者（特别是 Laravel 开发者）设计。它提供了一套预配置的 Docker 容器，包含开发中常用的服务，如 Nginx、MySQL、Redis、PHP-FPM 等。\n主要优势 开箱即用：预配置的开发环境，无需繁琐设置 一致性：确保开发、测试和生产环境的一致性 灵活性：支持多种 PHP 版本和扩展 模块化：可以根据需要启用或禁用特定服务 跨平台：在 Windows、macOS 和 Linux 上表现一致 基本架构 Laradock 采用模块化设计，每个服务都运行在独立的容器中，通过 Docker 网络连接：\nWorkspace：包含开发工具的容器 PHP-FPM：PHP 解释器 Nginx/Apache：Web 服务器 MySQL/PostgreSQL/MongoDB：数据库 Redis/Memcached：缓存 其他辅助服务（邮件服务器、消息队列等） Dockerfile DEBIAN_FRONTEND ENV DEBIAN_FRONTEND=noninteractive DEBIAN_FRONTEND 环境变量用于告知操作系统应该从哪儿获得用户输入。\n设置为 \u0026ldquo;noninteractive\u0026rdquo; 可以实现自动安装而无需用户交互，对于 CI/CD 流程和 Docker 构建特别有用。这在运行 apt-get 命令时尤为重要，因为它会自动选择默认选项并以最快速度完成构建。\n最佳实践是在 RUN 命令中设置该变量，而不是使用 ENV 进行全局设置，因为全局设置会影响容器运行时的交互体验：\nRUN DEBIAN_FRONTEND=noninteractive apt-get update \u0026amp;\u0026amp; apt-get install -y ... 基于角色的用户配置 # 创建非 root 用户防止文件在宿主机上创建时具有 root 权限 ARG PUID=1000 ENV PUID ${PUID} ARG PGID=1000 ENV PGID ${PGID} RUN set -xe; \\ groupadd -g ${PGID} laradock \u0026amp;\u0026amp; \\ useradd -l -u ${PUID} -g laradock -m laradock -G docker_env \u0026amp;\u0026amp; \\ usermod -p \u0026#34;*\u0026#34; laradock -s /bin/bash 这段配置创建了一个非 root 用户 laradock，解决了容器和宿主机之间文件权限问题：\n","keywords":["php","docker"],"articleBody":"Laradock 简介 Laradock 是一个基于 Docker 的完整 PHP 开发环境，专为 PHP 开发者（特别是 Laravel 开发者）设计。它提供了一套预配置的 Docker 容器，包含开发中常用的服务，如 Nginx、MySQL、Redis、PHP-FPM 等。\n主要优势 开箱即用：预配置的开发环境，无需繁琐设置 一致性：确保开发、测试和生产环境的一致性 灵活性：支持多种 PHP 版本和扩展 模块化：可以根据需要启用或禁用特定服务 跨平台：在 Windows、macOS 和 Linux 上表现一致 基本架构 Laradock 采用模块化设计，每个服务都运行在独立的容器中，通过 Docker 网络连接：\nWorkspace：包含开发工具的容器 PHP-FPM：PHP 解释器 Nginx/Apache：Web 服务器 MySQL/PostgreSQL/MongoDB：数据库 Redis/Memcached：缓存 其他辅助服务（邮件服务器、消息队列等） Dockerfile DEBIAN_FRONTEND ENV DEBIAN_FRONTEND=noninteractive DEBIAN_FRONTEND 环境变量用于告知操作系统应该从哪儿获得用户输入。\n设置为 “noninteractive” 可以实现自动安装而无需用户交互，对于 CI/CD 流程和 Docker 构建特别有用。这在运行 apt-get 命令时尤为重要，因为它会自动选择默认选项并以最快速度完成构建。\n最佳实践是在 RUN 命令中设置该变量，而不是使用 ENV 进行全局设置，因为全局设置会影响容器运行时的交互体验：\nRUN DEBIAN_FRONTEND=noninteractive apt-get update \u0026\u0026 apt-get install -y ... 基于角色的用户配置 # 创建非 root 用户防止文件在宿主机上创建时具有 root 权限 ARG PUID=1000 ENV PUID ${PUID} ARG PGID=1000 ENV PGID ${PGID} RUN set -xe; \\ groupadd -g ${PGID} laradock \u0026\u0026 \\ useradd -l -u ${PUID} -g laradock -m laradock -G docker_env \u0026\u0026 \\ usermod -p \"*\" laradock -s /bin/bash 这段配置创建了一个非 root 用户 laradock，解决了容器和宿主机之间文件权限问题：\n可配置的 UID/GID：通过 ARG 和 ENV 指令使用户 ID 和组 ID 可配置 权限一致性：将容器内用户的 UID/GID 与宿主机用户匹配，确保文件权限一致 改善开发体验：设置 bash 作为默认 shell，并且不需要密码 实际使用中，可以通过 .env 文件配置这些值：\nPUID=1000 PGID=1000 通过 id -u 和 id -g 命令可以获取当前用户的 UID 和 GID。\nPHP 扩展安装示例 Swoole 安装 Swoole 是一个高性能的 PHP 异步网络通信引擎。安装 Swoole 时，可以使用 PECL：\n# php7.1 echo '' | pecl -q install --configureoptions 'enable-openssl=\"yes\" enable-mysqlnd=\"yes\" enable-swoole-curl=\"yes\"' swoole-4.5.11; 这个命令通过 PECL 安装 Swoole 4.5.11，并启用了 OpenSSL、MySQL Native Driver 和 cURL 支持。安装后可以通过以下命令验证 OpenSSL 支持：\nphp -r \"new swoole_server('0.0.0.0', 443, SWOOLE_PROCESS, SWOOLE_SOCK_TCP | SWOOLE_SSL);\" 如果没有错误输出，说明 OpenSSL 支持已正确启用。\nPHP 版本智能检测 RUN if [ $(php -r \"echo PHP_MAJOR_VERSION;\") = \"8\" ] || { [ $(php -r \"echo PHP_MAJOR_VERSION;\") = \"7\" ] \u0026\u0026 { [ $(php -r \"echo PHP_MINOR_VERSION;\") = \"4\" ] || [ $(php -r \"echo PHP_MINOR_VERSION;\") = \"3\" ] ;} ;}; then \\ # PHP 8.x 或 PHP 7.3/7.4 的配置 pecl install xdebug-3.1.6; \\ else \\ if [ $(php -r \"echo PHP_MAJOR_VERSION;\") = \"5\" ]; then \\ # PHP 5.x 的配置 pecl install xdebug-2.5.5; \\ else \\ # 其他 PHP 7.x 版本的配置 if [ $(php -r \"echo PHP_MINOR_VERSION;\") = \"0\" ]; then \\ pecl install xdebug-2.9.0; \\ else \\ pecl install xdebug-2.9.8; \\ fi \\ fi \\ fi Laradock 的 Dockerfile 中大量使用 PHP 版本检测，确保安装与当前 PHP 版本兼容的扩展和工具：\n使用 php -r 内联执行 PHP 命令获取版本信息 通过嵌套条件语句处理不同的 PHP 版本需求 支持多种 PHP 版本（从 5.x 到 8.x）使用同一个 Dockerfile 这种方法使得一个 Dockerfile 可以适应多个 PHP 版本，极大简化了维护工作。\nComposer 双版本安装 # 更新 composer ARG COMPOSER_VERSION=2 ENV COMPOSER_VERSION ${COMPOSER_VERSION} RUN set -eux; \\ if [ \"$COMPOSER_VERSION\" = \"1\" ] || [ \"$COMPOSER_VERSION\" = \"2\" ] || [ \"$COMPOSER_VERSION\" = \"2.2\" ]; then \\ composer self-update --${COMPOSER_VERSION}; \\ else \\ composer self-update ${COMPOSER_VERSION}; \\ fi Laradock 支持灵活选择 Composer 版本：\n允许通过环境变量切换 Composer 1.x、2.x 或特定版本 适应不同项目的兼容性需求 方便在旧项目和新项目之间切换 实用场景：某些旧项目可能与 Composer 2.x 不兼容，而新项目需要更新的 Composer 功能。\ndocker-compose.yml 配置技巧 主机名解析 extra_hosts: - \"dockerhost:${DOCKER_HOST_IP}\" 这个配置会在容器的 /etc/hosts 文件中添加一条记录：\n10.0.75.1 dockerhost 这样，容器内的应用可以通过 dockerhost 域名访问宿主机，无需使用动态 IP 地址。\n模块化服务架构 Laradock 的 docker-compose.yml 文件采用高度模块化的设计：\nservices: workspace: build: context: ./workspace args: - PHP_VERSION=${PHP_VERSION} volumes: - ${APP_CODE_PATH_HOST}:${APP_CODE_PATH_CONTAINER} networks: - frontend - backend php-fpm: build: context: ./php-fpm args: - PHP_VERSION=${PHP_VERSION} volumes: - ${APP_CODE_PATH_HOST}:${APP_CODE_PATH_CONTAINER} depends_on: - workspace networks: - backend 主要特点：\n每个服务独立配置：可以只启动需要的服务 明确的依赖关系：使用 depends_on 确保正确的启动顺序 统一的环境变量：从 .env 文件加载配置 网络配置 networks: frontend: driver: bridge backend: driver: bridge Laradock 采用前后端分离的网络设计：\n前端网络：连接 Web 服务器和负载均衡器 后端网络：连接应用服务（PHP-FPM）和数据库 安全隔离：数据库等服务不直接暴露给前端 这种设计增强了安全性，防止外部直接访问敏感服务。\n卷管理策略 volumes: mysql: driver: ${VOLUMES_DRIVER} redis: driver: ${VOLUMES_DRIVER} postgres: driver: ${VOLUMES_DRIVER} Laradock 使用命名卷而非绑定挂载来提高性能和可移植性：\n集中式数据路径：使用 ${DATA_PATH_HOST} 管理所有持久化数据 可配置驱动：支持本地存储或网络存储 性能优化：命名卷在某些平台（特别是 Windows 和 macOS）上性能更好 实际使用示例：\n# 查看卷列表 docker volume ls # 备份数据卷 docker run --rm -v laradock_mysql:/source -v $(pwd):/backup alpine tar -czvf /backup/mysql_backup.tar.gz -C /source . 资源限制配置 php-fpm: ulimits: nproc: 65535 nofile: soft: 20000 hard: 40000 mem_limit: 1024m Laradock 支持为服务配置资源限制：\n进程数限制：控制可创建的进程数 文件描述符限制：影响并发连接能力 内存限制：防止单个容器消耗过多资源 这些设置对于生产环境特别重要，可以防止单个服务耗尽系统资源。\n端口映射策略 mysql: ports: - \"${MYSQL_PORT}:3306\" Laradock 采用可配置的端口映射策略：\n所有端口都可配置：通过环境变量定义外部端口 避免默认暴露端口：增强安全性 灵活处理端口冲突：可以在不同项目使用不同端口 端口冲突是多项目开发中常见的问题，这种设计可以轻松避免。\nPHP 扩展管理 常用开发扩展 Xdebug ARG INSTALL_XDEBUG=false RUN if [ ${INSTALL_XDEBUG} = true ]; then \\ # 安装 Xdebug 并配置 pecl install xdebug \u0026\u0026 \\ docker-php-ext-enable xdebug \\ fi Xdebug 是 PHP 的调试和分析工具。在 Laradock 中，可以通过环境变量控制是否安装：\nWORKSPACE_INSTALL_XDEBUG=true PHP_FPM_INSTALL_XDEBUG=true 实际使用配置（php.ini）：\n[xdebug] xdebug.mode=debug xdebug.client_host=host.docker.internal xdebug.client_port=9003 xdebug.start_with_request=yes PCOV PCOV 是一个轻量级代码覆盖率驱动，比 Xdebug 更快：\n专注于代码覆盖率分析 与 PHPUnit 完全兼容 性能影响比 Xdebug 小 在 Laravel 项目中使用示例：\nphp -dpcov.enabled=1 vendor/bin/phpunit --coverage-html coverage Taint Taint 是由 PHP 核心开发者鸟哥（惠新宸）开发的 PHP 扩展，用于检测 XSS 代码：\n自动检测可能的 XSS 漏洞 低运行时开销 适合在开发环境中使用 数据库相关扩展 OCI8 ARG INSTALL_OCI8=false ARG ORACLE_INSTANT_CLIENT_MIRROR=https://github.com/the-paulus/oracle-instantclient/raw/master/ ARG ORACLE_INSTANT_CLIENT_ARCH=x86_64 ARG ORACLE_INSTANT_CLIENT_MAJOR=18 ARG ORACLE_INSTANT_CLIENT_MINOR=3 RUN if [ ${INSTALL_OCI8} = true ]; then \\ # 安装 Oracle Instantclient 和 PHP OCI8 扩展 ... fi OCI8 用于连接 Oracle 数据库，通过 Oracle Call Interface 提供完整的功能：\n支持 Oracle 的所有数据类型 处理大型对象（LOB） 支持绑定变量和存储过程 示例代码：\n$conn = oci_connect('username', 'password', 'localhost/XE'); $stmt = oci_parse($conn, 'SELECT * FROM employees'); oci_execute($stmt); while ($row = oci_fetch_array($stmt, OCI_ASSOC+OCI_RETURN_NULLS)) { var_dump($row); } Redis Laradock 支持两种 Redis 扩展：\nPhpRedis：C 扩展，性能更好 Predis：纯 PHP 实现，更灵活 PhpRedis 安装示例：\nARG INSTALL_PHPREDIS=false RUN if [ ${INSTALL_PHPREDIS} = true ]; then \\ pecl install redis \u0026\u0026 \\ docker-php-ext-enable redis \\ fi 性能优化扩展 OPcache OPcache 通过将 PHP 脚本预编译的字节码存储在共享内存中来提高性能，减少加载和解析的开销：\n[opcache] opcache.enable=1 opcache.memory_consumption=128 opcache.interned_strings_buffer=8 opcache.max_accelerated_files=4000 opcache.validate_timestamps=0 opcache.save_comments=1 opcache.fast_shutdown=0 在生产环境中，可以设置 validate_timestamps=0 来防止 OPcache 检查文件变化，进一步提高性能。\nAPCu APCu 是一个用户数据缓存系统，可以在 PHP 进程中存储 key-value 数据：\napcu_store('my_key', 'my_value', 3600); // 存储数据，过期时间为 1 小时 $value = apcu_fetch('my_key'); // 读取数据 与 OPcache 不同，APCu 专注于用户数据缓存，而非代码缓存。\n实用工具与配置 软件源和镜像 # 将应用源从 deb.debian.org 更改为阿里云源 sed -i 's/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/' /etc/apt/sources.list \u0026\u0026 \\ sed -i 's/security.debian.org/mirrors.tuna.tsinghua.edu.cn/' /etc/apt/sources.list \u0026\u0026 \\ sed -i 's/security-cdn.debian.org/mirrors.tuna.tsinghua.edu.cn/' /etc/apt/sources.list \\ 在国内环境使用 Laradock 时，配置国内镜像源可以大幅提升构建速度：\n系统源：使用 TUNA 或阿里云源 Composer：配置 Packagist 中国镜像 NPM：配置淘宝 NPM 镜像 可以在 .env 文件中设置：\nWORKSPACE_NPM_REGISTRY=https://registry.npm.taobao.org/ WORKSPACE_COMPOSER_REPO_PACKAGIST=https://mirrors.aliyun.com/composer/ Node.js 配置 ARG INSTALL_NODE=false ARG NODE_VERSION=node ARG INSTALL_NPM_GULP=false ARG INSTALL_NPM_BOWER=false ARG INSTALL_NPM_VUE_CLI=false ARG INSTALL_NPM_ANGULAR_CLI=false ARG NPM_REGISTRY RUN if [ ${INSTALL_NODE} = true ]; then \\ # 安装 nvm 和 Node.js ... fi Laradock 的 Node.js 配置非常灵活：\n使用 NVM 管理 Node.js 版本 支持配置 NPM 镜像源 可选安装常用前端工具（Vue CLI、Angular CLI 等） 支持 Yarn 和 PNPM 等现代包管理器 使用案例：\nWORKSPACE_INSTALL_NODE=true WORKSPACE_NODE_VERSION=16 WORKSPACE_NPM_REGISTRY=https://registry.npm.taobao.org/ WORKSPACE_INSTALL_NPM_VUE_CLI=true 常用命令工具 update-alternatives update-alternatives 用于管理 Linux 系统中的命令替代版本：\n# 设置默认 PHP 版本 update-alternatives --set php /usr/bin/php7.4 Laradock 使用这个命令管理多个 PHP 版本。\ndocker-php-ext-disable # 禁用不需要的扩展（不需要重新编译） docker-php-ext-disable xdebug pcov Laradock 特有的实用脚本，允许：\n在生产环境中禁用性能密集型扩展 保留扩展文件但不加载，避免重新编译 需要时快速重新启用扩展 这对于开发/生产环境切换非常有用，可以保持相同的镜像但有不同的扩展启用状态。\n常用操作指南 基本使用流程 # 克隆 Laradock 仓库 git clone https://github.com/laradock/laradock.git # 复制环境配置文件 cp .env.example .env # 编辑配置文件，设置项目路径等 vim .env # 构建并启动容器 docker compose up -d nginx mysql redis 常用维护命令 # 构建特定服务 docker compose build workspace php-fpm # 进入容器 docker compose exec workspace bash # 查看日志 docker compose logs nginx # 停止所有容器 docker compose down 故障排除 端口冲突：修改 .env 文件中的端口映射\nNGINX_HOST_HTTP_PORT=8080 MYSQL_PORT=33060 权限问题：确保 PUID/PGID 设置正确\nPUID=$(id -u) PGID=$(id -g) 内存不足：增加 Docker 分配的资源，或减少启用的服务\ndocker compose up -d nginx php-fpm mysql 高级功能 多项目环境 Laradock 支持同时运行多个项目：\n. ├── laradock/ │ ├── docker-compose.yml │ └── .env ├── project1/ ├── project2/ └── project3/ 配置示例：\nAPP_CODE_PATH_HOST=../:/var/www NGINX_SITES_PATH=./nginx/sites/ 然后为每个项目创建 Nginx 配置文件：\n# ./nginx/sites/project1.conf server { server_name project1.test; root /var/www/project1/public; # ... } 多架构支持 # 支持 ARM 和 x86 架构 FROM --platform=${TARGETPLATFORM} php:${PHP_VERSION}-fpm-alpine ARG TARGETPLATFORM ARG BUILDPLATFORM Laradock 现代版本支持：\n使用 Docker BuildKit 进行多架构构建 在 ARM 设备（M1/M2 Mac、树莓派）上本地开发 通过 GitHub Actions 实现跨平台自动构建 使用多架构镜像的命令：\n# 显示支持的架构 docker manifest inspect laradock/workspace:latest # 构建多架构镜像 docker buildx build --platform linux/amd64,linux/arm64 -t myname/myapp:latest . CI/CD 集成 Laradock 可以与各种 CI/CD 工具集成：\n# .gitlab-ci.yml 示例 stages: - build - test - deploy build: stage: build script: - cd laradock - docker compose build php-fpm workspace test: stage: test script: - cd laradock - docker compose up -d php-fpm mysql - docker compose exec workspace php artisan test 可以使用 Docker Compose 的 --profile 参数为不同环境创建配置：\n# 开发环境 docker compose --profile dev up -d # 测试环境 docker compose --profile test up -d 最佳实践 优化构建速度 使用 BuildKit：\nDOCKER_BUILDKIT=1 docker compose build 创建层缓存：\n# 先复制依赖文件，安装依赖，然后再复制应用代码 COPY composer.json composer.lock ./ RUN composer install --no-scripts --no-autoloader COPY . . RUN composer dump-autoload --optimize 多阶段构建：\nFROM php:7.4-fpm AS builder # 安装构建依赖... FROM php:7.4-fpm # 只复制需要的文件 COPY --from=builder /var/www/vendor /var/www/vendor 安全最佳实践 避免使用 root 用户：\nUSER laradock 限制容器能力：\nsecurity_opt: - no-new-privileges:true 使用健康检查：\nhealthcheck: test: [\"CMD\", \"php\", \"-v\"] interval: 30s timeout: 10s retries: 3 定期更新基础镜像：\ndocker compose pull docker compose build --pull References Laradock 官方文档 Laradock GitHub 仓库 Docker 官方文档 PHP 官方文档 Laradock - A PHP Developer’s best friend. | dev.to 如何优化 Docker 镜像构建 Docker Compose 参考 ","wordCount":"1220","inLanguage":"en","image":"https://images.unsplash.com/photo-1663428520845-056989f8a664?ixlib=rb-4.0.3\u0026ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8\u0026auto=format\u0026fit=crop\u0026w=960\u0026q=80","datePublished":"2022-11-09T22:24:01Z","dateModified":"2022-11-09T22:24:01Z","author":[{"@type":"Person","name":"Me"},{"@type":"Person","name":"LLM"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://zyf.im/2022/11/09/explore-laradock/"},"publisher":{"@type":"Organization","name":"ZYF.IM BLOG","logo":{"@type":"ImageObject","url":"https://zyf.im/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zyf.im/ accesskey=h title="ZYF.IM (Alt + H)"><img src=https://zyf.im/apple-touch-icon.png alt aria-label=logo height=35>ZYF.IM</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zyf.im/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://zyf.im/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zyf.im/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://zyf.im/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zyf.im/>Home</a>&nbsp;»&nbsp;<a href=https://zyf.im/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Laradock 学习笔记</h1><div class=post-meta><span title='2022-11-09 22:24:01 +0000 UTC'>November 9, 2022</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1220 words&nbsp;·&nbsp;Me, LLM</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#laradock-简介>Laradock 简介</a><ul><li><a href=#主要优势>主要优势</a></li><li><a href=#基本架构>基本架构</a></li></ul></li><li><a href=#dockerfile>Dockerfile</a><ul><li><a href=#debian_frontend>DEBIAN_FRONTEND</a></li><li><a href=#基于角色的用户配置>基于角色的用户配置</a></li><li><a href=#php-扩展安装示例>PHP 扩展安装示例</a></li></ul></li><li><a href=#docker-composeyml-配置技巧>docker-compose.yml 配置技巧</a><ul><li><a href=#主机名解析>主机名解析</a></li><li><a href=#模块化服务架构>模块化服务架构</a></li><li><a href=#网络配置>网络配置</a></li><li><a href=#卷管理策略>卷管理策略</a></li><li><a href=#资源限制配置>资源限制配置</a></li><li><a href=#端口映射策略>端口映射策略</a></li></ul></li><li><a href=#php-扩展管理>PHP 扩展管理</a><ul><li><a href=#常用开发扩展>常用开发扩展</a></li><li><a href=#数据库相关扩展>数据库相关扩展</a></li><li><a href=#性能优化扩展>性能优化扩展</a></li></ul></li><li><a href=#实用工具与配置>实用工具与配置</a><ul><li><a href=#软件源和镜像>软件源和镜像</a></li><li><a href=#nodejs-配置>Node.js 配置</a></li><li><a href=#常用命令工具>常用命令工具</a></li></ul></li><li><a href=#常用操作指南>常用操作指南</a><ul><li><a href=#基本使用流程>基本使用流程</a></li><li><a href=#常用维护命令>常用维护命令</a></li><li><a href=#故障排除>故障排除</a></li></ul></li><li><a href=#高级功能>高级功能</a><ul><li><a href=#多项目环境>多项目环境</a></li><li><a href=#多架构支持>多架构支持</a></li><li><a href=#cicd-集成>CI/CD 集成</a></li></ul></li><li><a href=#最佳实践>最佳实践</a><ul><li><a href=#优化构建速度>优化构建速度</a></li><li><a href=#安全最佳实践>安全最佳实践</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=laradock-简介>Laradock 简介<a hidden class=anchor aria-hidden=true href=#laradock-简介>#</a></h2><p>Laradock 是一个基于 Docker 的完整 PHP 开发环境，专为 PHP 开发者（特别是 Laravel 开发者）设计。它提供了一套预配置的 Docker 容器，包含开发中常用的服务，如 Nginx、MySQL、Redis、PHP-FPM 等。</p><h3 id=主要优势>主要优势<a hidden class=anchor aria-hidden=true href=#主要优势>#</a></h3><ul><li><strong>开箱即用</strong>：预配置的开发环境，无需繁琐设置</li><li><strong>一致性</strong>：确保开发、测试和生产环境的一致性</li><li><strong>灵活性</strong>：支持多种 PHP 版本和扩展</li><li><strong>模块化</strong>：可以根据需要启用或禁用特定服务</li><li><strong>跨平台</strong>：在 Windows、macOS 和 Linux 上表现一致</li></ul><h3 id=基本架构>基本架构<a hidden class=anchor aria-hidden=true href=#基本架构>#</a></h3><p>Laradock 采用模块化设计，每个服务都运行在独立的容器中，通过 Docker 网络连接：</p><ul><li><strong>Workspace</strong>：包含开发工具的容器</li><li><strong>PHP-FPM</strong>：PHP 解释器</li><li><strong>Nginx/Apache</strong>：Web 服务器</li><li><strong>MySQL/PostgreSQL/MongoDB</strong>：数据库</li><li><strong>Redis/Memcached</strong>：缓存</li><li>其他辅助服务（邮件服务器、消息队列等）</li></ul><h2 id=dockerfile>Dockerfile<a hidden class=anchor aria-hidden=true href=#dockerfile>#</a></h2><h3 id=debian_frontend>DEBIAN_FRONTEND<a hidden class=anchor aria-hidden=true href=#debian_frontend>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>DEBIAN_FRONTEND</span><span class=o>=</span>noninteractive
</span></span></code></pre></div><p>DEBIAN_FRONTEND 环境变量用于告知操作系统应该从哪儿获得用户输入。</p><p>设置为 &ldquo;noninteractive&rdquo; 可以实现自动安装而无需用户交互，对于 CI/CD 流程和 Docker 构建特别有用。这在运行 apt-get 命令时尤为重要，因为它会自动选择默认选项并以最快速度完成构建。</p><p>最佳实践是在 RUN 命令中设置该变量，而不是使用 ENV 进行全局设置，因为全局设置会影响容器运行时的交互体验：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>RUN</span> <span class=nv>DEBIAN_FRONTEND</span><span class=o>=</span>noninteractive apt-get update <span class=o>&amp;&amp;</span> apt-get install -y ...<span class=err>
</span></span></span></code></pre></div><h3 id=基于角色的用户配置>基于角色的用户配置<a hidden class=anchor aria-hidden=true href=#基于角色的用户配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 创建非 root 用户防止文件在宿主机上创建时具有 root 权限</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>PUID</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=k>ENV</span> PUID <span class=si>${</span><span class=nv>PUID</span><span class=si>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>PGID</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=k>ENV</span> PGID <span class=si>${</span><span class=nv>PGID</span><span class=si>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>set</span> -xe<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    groupadd -g <span class=si>${</span><span class=nv>PGID</span><span class=si>}</span> laradock <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    useradd -l -u <span class=si>${</span><span class=nv>PUID</span><span class=si>}</span> -g laradock -m laradock -G docker_env <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    usermod -p <span class=s2>&#34;*&#34;</span> laradock -s /bin/bash<span class=err>
</span></span></span></code></pre></div><p>这段配置创建了一个非 root 用户 <code>laradock</code>，解决了容器和宿主机之间文件权限问题：</p><ul><li><strong>可配置的 UID/GID</strong>：通过 ARG 和 ENV 指令使用户 ID 和组 ID 可配置</li><li><strong>权限一致性</strong>：将容器内用户的 UID/GID 与宿主机用户匹配，确保文件权限一致</li><li><strong>改善开发体验</strong>：设置 bash 作为默认 shell，并且不需要密码</li></ul><p>实际使用中，可以通过 <code>.env</code> 文件配置这些值：</p><pre tabindex=0><code class=language-dotenv data-lang=dotenv>PUID=1000
PGID=1000
</code></pre><p>通过 <code>id -u</code> 和 <code>id -g</code> 命令可以获取当前用户的 UID 和 GID。</p><h3 id=php-扩展安装示例>PHP 扩展安装示例<a hidden class=anchor aria-hidden=true href=#php-扩展安装示例>#</a></h3><h4 id=swoole-安装>Swoole 安装<a hidden class=anchor aria-hidden=true href=#swoole-安装>#</a></h4><p><a href=https://wiki.swoole.com/>Swoole</a> 是一个高性能的 PHP 异步网络通信引擎。安装 Swoole 时，可以使用 PECL：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># php7.1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>echo</span> <span class=s1>&#39;&#39;</span> <span class=p>|</span> pecl -q install --configureoptions <span class=s1>&#39;enable-openssl=&#34;yes&#34; enable-mysqlnd=&#34;yes&#34; enable-swoole-curl=&#34;yes&#34;&#39;</span> swoole-4.5.11<span class=p>;</span><span class=err>
</span></span></span></code></pre></div><p>这个命令通过 PECL 安装 Swoole 4.5.11，并启用了 OpenSSL、MySQL Native Driver 和 cURL 支持。安装后可以通过以下命令验证 OpenSSL 支持：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>php -r <span class=s2>&#34;new swoole_server(&#39;0.0.0.0&#39;, 443, SWOOLE_PROCESS, SWOOLE_SOCK_TCP | SWOOLE_SSL);&#34;</span>
</span></span></code></pre></div><p>如果没有错误输出，说明 OpenSSL 支持已正确启用。</p><h4 id=php-版本智能检测>PHP 版本智能检测<a hidden class=anchor aria-hidden=true href=#php-版本智能检测>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>RUN</span> <span class=k>if</span> <span class=o>[</span> <span class=k>$(</span>php -r <span class=s2>&#34;echo PHP_MAJOR_VERSION;&#34;</span><span class=k>)</span> <span class=o>=</span> <span class=s2>&#34;8&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>{</span> <span class=o>[</span> <span class=k>$(</span>php -r <span class=s2>&#34;echo PHP_MAJOR_VERSION;&#34;</span><span class=k>)</span> <span class=o>=</span> <span class=s2>&#34;7&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>{</span> <span class=o>[</span> <span class=k>$(</span>php -r <span class=s2>&#34;echo PHP_MINOR_VERSION;&#34;</span><span class=k>)</span> <span class=o>=</span> <span class=s2>&#34;4&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=k>$(</span>php -r <span class=s2>&#34;echo PHP_MINOR_VERSION;&#34;</span><span class=k>)</span> <span class=o>=</span> <span class=s2>&#34;3&#34;</span> <span class=o>]</span> <span class=p>;</span><span class=o>}</span> <span class=p>;</span><span class=o>}</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=c1># PHP 8.x 或 PHP 7.3/7.4 的配置</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    pecl install xdebug-3.1.6<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=k>else</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>if</span> <span class=o>[</span> <span class=k>$(</span>php -r <span class=s2>&#34;echo PHP_MAJOR_VERSION;&#34;</span><span class=k>)</span> <span class=o>=</span> <span class=s2>&#34;5&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=c1># PHP 5.x 的配置</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        pecl install xdebug-2.5.5<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>else</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=c1># 其他 PHP 7.x 版本的配置</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=k>if</span> <span class=o>[</span> <span class=k>$(</span>php -r <span class=s2>&#34;echo PHP_MINOR_VERSION;&#34;</span><span class=k>)</span> <span class=o>=</span> <span class=s2>&#34;0&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>            pecl install xdebug-2.9.0<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=k>else</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>            pecl install xdebug-2.9.8<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=k>fi</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>fi</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=k>fi</span><span class=err>
</span></span></span></code></pre></div><p>Laradock 的 Dockerfile 中大量使用 PHP 版本检测，确保安装与当前 PHP 版本兼容的扩展和工具：</p><ol><li>使用 <code>php -r</code> 内联执行 PHP 命令获取版本信息</li><li>通过嵌套条件语句处理不同的 PHP 版本需求</li><li>支持多种 PHP 版本（从 5.x 到 8.x）使用同一个 Dockerfile</li></ol><p>这种方法使得一个 Dockerfile 可以适应多个 PHP 版本，极大简化了维护工作。</p><h4 id=composer-双版本安装>Composer 双版本安装<a hidden class=anchor aria-hidden=true href=#composer-双版本安装>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 更新 composer</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>COMPOSER_VERSION</span><span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl><span class=k>ENV</span> COMPOSER_VERSION <span class=si>${</span><span class=nv>COMPOSER_VERSION</span><span class=si>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>set</span> -eux<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$COMPOSER_VERSION</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;1&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$COMPOSER_VERSION</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;2&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$COMPOSER_VERSION</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;2.2&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        composer self-update --<span class=si>${</span><span class=nv>COMPOSER_VERSION</span><span class=si>}</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>else</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        composer self-update <span class=si>${</span><span class=nv>COMPOSER_VERSION</span><span class=si>}</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>fi</span><span class=err>
</span></span></span></code></pre></div><p>Laradock 支持灵活选择 Composer 版本：</p><ul><li>允许通过环境变量切换 Composer 1.x、2.x 或特定版本</li><li>适应不同项目的兼容性需求</li><li>方便在旧项目和新项目之间切换</li></ul><p>实用场景：某些旧项目可能与 Composer 2.x 不兼容，而新项目需要更新的 Composer 功能。</p><h2 id=docker-composeyml-配置技巧>docker-compose.yml 配置技巧<a hidden class=anchor aria-hidden=true href=#docker-composeyml-配置技巧>#</a></h2><h3 id=主机名解析>主机名解析<a hidden class=anchor aria-hidden=true href=#主机名解析>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>extra_hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;dockerhost:${DOCKER_HOST_IP}&#34;</span><span class=w>
</span></span></span></code></pre></div><p>这个配置会在容器的 <code>/etc/hosts</code> 文件中添加一条记录：</p><pre tabindex=0><code>10.0.75.1 dockerhost
</code></pre><p>这样，容器内的应用可以通过 <code>dockerhost</code> 域名访问宿主机，无需使用动态 IP 地址。</p><h3 id=模块化服务架构>模块化服务架构<a hidden class=anchor aria-hidden=true href=#模块化服务架构>#</a></h3><p>Laradock 的 docker-compose.yml 文件采用高度模块化的设计：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>workspace</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>./workspace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>PHP_VERSION=${PHP_VERSION}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${APP_CODE_PATH_HOST}:${APP_CODE_PATH_CONTAINER}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>php-fpm</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>./php-fpm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>PHP_VERSION=${PHP_VERSION}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${APP_CODE_PATH_HOST}:${APP_CODE_PATH_CONTAINER}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>workspace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>backend</span><span class=w>
</span></span></span></code></pre></div><p>主要特点：</p><ul><li><strong>每个服务独立配置</strong>：可以只启动需要的服务</li><li><strong>明确的依赖关系</strong>：使用 <code>depends_on</code> 确保正确的启动顺序</li><li><strong>统一的环境变量</strong>：从 <code>.env</code> 文件加载配置</li></ul><h3 id=网络配置>网络配置<a hidden class=anchor aria-hidden=true href=#网络配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>frontend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>bridge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>bridge</span><span class=w>
</span></span></span></code></pre></div><p>Laradock 采用前后端分离的网络设计：</p><ul><li><strong>前端网络</strong>：连接 Web 服务器和负载均衡器</li><li><strong>后端网络</strong>：连接应用服务（PHP-FPM）和数据库</li><li><strong>安全隔离</strong>：数据库等服务不直接暴露给前端</li></ul><p>这种设计增强了安全性，防止外部直接访问敏感服务。</p><h3 id=卷管理策略>卷管理策略<a hidden class=anchor aria-hidden=true href=#卷管理策略>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mysql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>${VOLUMES_DRIVER}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>${VOLUMES_DRIVER}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>${VOLUMES_DRIVER}</span><span class=w>
</span></span></span></code></pre></div><p>Laradock 使用命名卷而非绑定挂载来提高性能和可移植性：</p><ul><li><strong>集中式数据路径</strong>：使用 <code>${DATA_PATH_HOST}</code> 管理所有持久化数据</li><li><strong>可配置驱动</strong>：支持本地存储或网络存储</li><li><strong>性能优化</strong>：命名卷在某些平台（特别是 Windows 和 macOS）上性能更好</li></ul><p>实际使用示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看卷列表</span>
</span></span><span class=line><span class=cl>docker volume ls
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份数据卷</span>
</span></span><span class=line><span class=cl>docker run --rm -v laradock_mysql:/source -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>:/backup alpine tar -czvf /backup/mysql_backup.tar.gz -C /source .
</span></span></code></pre></div><h3 id=资源限制配置>资源限制配置<a hidden class=anchor aria-hidden=true href=#资源限制配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>php-fpm</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ulimits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nproc</span><span class=p>:</span><span class=w> </span><span class=m>65535</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nofile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>soft</span><span class=p>:</span><span class=w> </span><span class=m>20000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hard</span><span class=p>:</span><span class=w> </span><span class=m>40000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mem_limit</span><span class=p>:</span><span class=w> </span><span class=l>1024m</span><span class=w>
</span></span></span></code></pre></div><p>Laradock 支持为服务配置资源限制：</p><ul><li><strong>进程数限制</strong>：控制可创建的进程数</li><li><strong>文件描述符限制</strong>：影响并发连接能力</li><li><strong>内存限制</strong>：防止单个容器消耗过多资源</li></ul><p>这些设置对于生产环境特别重要，可以防止单个服务耗尽系统资源。</p><h3 id=端口映射策略>端口映射策略<a hidden class=anchor aria-hidden=true href=#端口映射策略>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>mysql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;${MYSQL_PORT}:3306&#34;</span><span class=w>
</span></span></span></code></pre></div><p>Laradock 采用可配置的端口映射策略：</p><ul><li><strong>所有端口都可配置</strong>：通过环境变量定义外部端口</li><li><strong>避免默认暴露端口</strong>：增强安全性</li><li><strong>灵活处理端口冲突</strong>：可以在不同项目使用不同端口</li></ul><p>端口冲突是多项目开发中常见的问题，这种设计可以轻松避免。</p><h2 id=php-扩展管理>PHP 扩展管理<a hidden class=anchor aria-hidden=true href=#php-扩展管理>#</a></h2><h3 id=常用开发扩展>常用开发扩展<a hidden class=anchor aria-hidden=true href=#常用开发扩展>#</a></h3><h4 id=xdebug>Xdebug<a hidden class=anchor aria-hidden=true href=#xdebug>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>INSTALL_XDEBUG</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>RUN</span> <span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>INSTALL_XDEBUG</span><span class=si>}</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=c1># 安装 Xdebug 并配置</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  pecl install xdebug <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  docker-php-ext-enable xdebug <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=k>fi</span><span class=err>
</span></span></span></code></pre></div><p><a href=https://xdebug.org/>Xdebug</a> 是 PHP 的调试和分析工具。在 Laradock 中，可以通过环境变量控制是否安装：</p><pre tabindex=0><code class=language-dotenv data-lang=dotenv>WORKSPACE_INSTALL_XDEBUG=true
PHP_FPM_INSTALL_XDEBUG=true
</code></pre><p>实际使用配置（php.ini）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[xdebug]</span>
</span></span><span class=line><span class=cl><span class=na>xdebug.mode</span><span class=o>=</span><span class=s>debug</span>
</span></span><span class=line><span class=cl><span class=na>xdebug.client_host</span><span class=o>=</span><span class=s>host.docker.internal</span>
</span></span><span class=line><span class=cl><span class=na>xdebug.client_port</span><span class=o>=</span><span class=s>9003</span>
</span></span><span class=line><span class=cl><span class=na>xdebug.start_with_request</span><span class=o>=</span><span class=s>yes</span>
</span></span></code></pre></div><h4 id=pcov>PCOV<a hidden class=anchor aria-hidden=true href=#pcov>#</a></h4><p><a href=https://github.com/krakjoe/pcov>PCOV</a> 是一个轻量级代码覆盖率驱动，比 Xdebug 更快：</p><ul><li>专注于代码覆盖率分析</li><li>与 PHPUnit 完全兼容</li><li>性能影响比 Xdebug 小</li></ul><p>在 Laravel 项目中使用示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>php -dpcov.enabled<span class=o>=</span><span class=m>1</span> vendor/bin/phpunit --coverage-html coverage
</span></span></code></pre></div><h4 id=taint>Taint<a hidden class=anchor aria-hidden=true href=#taint>#</a></h4><p><a href=https://github.com/laruence/taint>Taint</a> 是由 PHP 核心开发者鸟哥（惠新宸）开发的 PHP 扩展，用于检测 XSS 代码：</p><ul><li>自动检测可能的 XSS 漏洞</li><li>低运行时开销</li><li>适合在开发环境中使用</li></ul><h3 id=数据库相关扩展>数据库相关扩展<a hidden class=anchor aria-hidden=true href=#数据库相关扩展>#</a></h3><h4 id=oci8>OCI8<a hidden class=anchor aria-hidden=true href=#oci8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>INSTALL_OCI8</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>ORACLE_INSTANT_CLIENT_MIRROR</span><span class=o>=</span>https://github.com/the-paulus/oracle-instantclient/raw/master/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>ORACLE_INSTANT_CLIENT_ARCH</span><span class=o>=</span>x86_64
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>ORACLE_INSTANT_CLIENT_MAJOR</span><span class=o>=</span><span class=m>18</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>ORACLE_INSTANT_CLIENT_MINOR</span><span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>RUN</span> <span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>INSTALL_OCI8</span><span class=si>}</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=c1># 安装 Oracle Instantclient 和 PHP OCI8 扩展</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    ...<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>fi</span><span class=err>
</span></span></span></code></pre></div><p><a href=https://www.php.net/manual/en/book.oci8.php>OCI8</a> 用于连接 Oracle 数据库，通过 Oracle Call Interface 提供完整的功能：</p><ul><li>支持 Oracle 的所有数据类型</li><li>处理大型对象（LOB）</li><li>支持绑定变量和存储过程</li></ul><p>示例代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$conn</span> <span class=o>=</span> <span class=nx>oci_connect</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s1>&#39;password&#39;</span><span class=p>,</span> <span class=s1>&#39;localhost/XE&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$stmt</span> <span class=o>=</span> <span class=nx>oci_parse</span><span class=p>(</span><span class=nv>$conn</span><span class=p>,</span> <span class=s1>&#39;SELECT * FROM employees&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>oci_execute</span><span class=p>(</span><span class=nv>$stmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=nv>$row</span> <span class=o>=</span> <span class=nx>oci_fetch_array</span><span class=p>(</span><span class=nv>$stmt</span><span class=p>,</span> <span class=nx>OCI_ASSOC</span><span class=o>+</span><span class=nx>OCI_RETURN_NULLS</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$row</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=redis>Redis<a hidden class=anchor aria-hidden=true href=#redis>#</a></h4><p>Laradock 支持两种 Redis 扩展：</p><ol><li><strong>PhpRedis</strong>：C 扩展，性能更好</li><li><strong>Predis</strong>：纯 PHP 实现，更灵活</li></ol><p>PhpRedis 安装示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>INSTALL_PHPREDIS</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>RUN</span> <span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>INSTALL_PHPREDIS</span><span class=si>}</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    pecl install redis <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    docker-php-ext-enable redis <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=k>fi</span><span class=err>
</span></span></span></code></pre></div><h3 id=性能优化扩展>性能优化扩展<a hidden class=anchor aria-hidden=true href=#性能优化扩展>#</a></h3><h4 id=opcache>OPcache<a hidden class=anchor aria-hidden=true href=#opcache>#</a></h4><p>OPcache 通过将 PHP 脚本预编译的字节码存储在共享内存中来提高性能，减少加载和解析的开销：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[opcache]</span>
</span></span><span class=line><span class=cl><span class=na>opcache.enable</span><span class=o>=</span><span class=s>1</span>
</span></span><span class=line><span class=cl><span class=na>opcache.memory_consumption</span><span class=o>=</span><span class=s>128</span>
</span></span><span class=line><span class=cl><span class=na>opcache.interned_strings_buffer</span><span class=o>=</span><span class=s>8</span>
</span></span><span class=line><span class=cl><span class=na>opcache.max_accelerated_files</span><span class=o>=</span><span class=s>4000</span>
</span></span><span class=line><span class=cl><span class=na>opcache.validate_timestamps</span><span class=o>=</span><span class=s>0</span>
</span></span><span class=line><span class=cl><span class=na>opcache.save_comments</span><span class=o>=</span><span class=s>1</span>
</span></span><span class=line><span class=cl><span class=na>opcache.fast_shutdown</span><span class=o>=</span><span class=s>0</span>
</span></span></code></pre></div><p>在生产环境中，可以设置 <code>validate_timestamps=0</code> 来防止 OPcache 检查文件变化，进一步提高性能。</p><h4 id=apcu>APCu<a hidden class=anchor aria-hidden=true href=#apcu>#</a></h4><p>APCu 是一个用户数据缓存系统，可以在 PHP 进程中存储 key-value 数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>apcu_store</span><span class=p>(</span><span class=s1>&#39;my_key&#39;</span><span class=p>,</span> <span class=s1>&#39;my_value&#39;</span><span class=p>,</span> <span class=mi>3600</span><span class=p>);</span> <span class=c1>// 存储数据，过期时间为 1 小时
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$value</span> <span class=o>=</span> <span class=nx>apcu_fetch</span><span class=p>(</span><span class=s1>&#39;my_key&#39;</span><span class=p>);</span> <span class=c1>// 读取数据
</span></span></span></code></pre></div><p>与 OPcache 不同，APCu 专注于用户数据缓存，而非代码缓存。</p><h2 id=实用工具与配置>实用工具与配置<a hidden class=anchor aria-hidden=true href=#实用工具与配置>#</a></h2><h3 id=软件源和镜像>软件源和镜像<a hidden class=anchor aria-hidden=true href=#软件源和镜像>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 将应用源从 deb.debian.org 更改为阿里云源</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>sed -i <span class=s1>&#39;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/&#39;</span> /etc/apt/sources.list <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sed -i <span class=s1>&#39;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/&#39;</span> /etc/apt/sources.list <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sed -i <span class=s1>&#39;s/security-cdn.debian.org/mirrors.tuna.tsinghua.edu.cn/&#39;</span> /etc/apt/sources.list <span class=err>\
</span></span></span></code></pre></div><p>在国内环境使用 Laradock 时，配置国内镜像源可以大幅提升构建速度：</p><ol><li><strong>系统源</strong>：使用 TUNA 或阿里云源</li><li><strong>Composer</strong>：配置 Packagist 中国镜像</li><li><strong>NPM</strong>：配置淘宝 NPM 镜像</li></ol><p>可以在 <code>.env</code> 文件中设置：</p><pre tabindex=0><code class=language-dotenv data-lang=dotenv>WORKSPACE_NPM_REGISTRY=https://registry.npm.taobao.org/
WORKSPACE_COMPOSER_REPO_PACKAGIST=https://mirrors.aliyun.com/composer/
</code></pre><h3 id=nodejs-配置>Node.js 配置<a hidden class=anchor aria-hidden=true href=#nodejs-配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>INSTALL_NODE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>NODE_VERSION</span><span class=o>=</span>node
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>INSTALL_NPM_GULP</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>INSTALL_NPM_BOWER</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>INSTALL_NPM_VUE_CLI</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>INSTALL_NPM_ANGULAR_CLI</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> NPM_REGISTRY<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>INSTALL_NODE</span><span class=si>}</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=c1># 安装 nvm 和 Node.js</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    ...<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>fi</span><span class=err>
</span></span></span></code></pre></div><p>Laradock 的 Node.js 配置非常灵活：</p><ul><li>使用 NVM 管理 Node.js 版本</li><li>支持配置 NPM 镜像源</li><li>可选安装常用前端工具（Vue CLI、Angular CLI 等）</li><li>支持 Yarn 和 PNPM 等现代包管理器</li></ul><p>使用案例：</p><pre tabindex=0><code class=language-dotenv data-lang=dotenv>WORKSPACE_INSTALL_NODE=true
WORKSPACE_NODE_VERSION=16
WORKSPACE_NPM_REGISTRY=https://registry.npm.taobao.org/
WORKSPACE_INSTALL_NPM_VUE_CLI=true
</code></pre><h3 id=常用命令工具>常用命令工具<a hidden class=anchor aria-hidden=true href=#常用命令工具>#</a></h3><h4 id=update-alternatives>update-alternatives<a hidden class=anchor aria-hidden=true href=#update-alternatives>#</a></h4><p><code>update-alternatives</code> 用于管理 Linux 系统中的命令替代版本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 设置默认 PHP 版本</span>
</span></span><span class=line><span class=cl>update-alternatives --set php /usr/bin/php7.4
</span></span></code></pre></div><p>Laradock 使用这个命令管理多个 PHP 版本。</p><h4 id=docker-php-ext-disable>docker-php-ext-disable<a hidden class=anchor aria-hidden=true href=#docker-php-ext-disable>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 禁用不需要的扩展（不需要重新编译）</span>
</span></span><span class=line><span class=cl>docker-php-ext-disable xdebug pcov
</span></span></code></pre></div><p>Laradock 特有的实用脚本，允许：</p><ul><li>在生产环境中禁用性能密集型扩展</li><li>保留扩展文件但不加载，避免重新编译</li><li>需要时快速重新启用扩展</li></ul><p>这对于开发/生产环境切换非常有用，可以保持相同的镜像但有不同的扩展启用状态。</p><h2 id=常用操作指南>常用操作指南<a hidden class=anchor aria-hidden=true href=#常用操作指南>#</a></h2><h3 id=基本使用流程>基本使用流程<a hidden class=anchor aria-hidden=true href=#基本使用流程>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 克隆 Laradock 仓库</span>
</span></span><span class=line><span class=cl>git clone https://github.com/laradock/laradock.git
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 复制环境配置文件</span>
</span></span><span class=line><span class=cl>cp .env.example .env
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编辑配置文件，设置项目路径等</span>
</span></span><span class=line><span class=cl>vim .env
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建并启动容器</span>
</span></span><span class=line><span class=cl>docker compose up -d nginx mysql redis
</span></span></code></pre></div><h3 id=常用维护命令>常用维护命令<a hidden class=anchor aria-hidden=true href=#常用维护命令>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 构建特定服务</span>
</span></span><span class=line><span class=cl>docker compose build workspace php-fpm
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入容器</span>
</span></span><span class=line><span class=cl>docker compose <span class=nb>exec</span> workspace bash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看日志</span>
</span></span><span class=line><span class=cl>docker compose logs nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 停止所有容器</span>
</span></span><span class=line><span class=cl>docker compose down
</span></span></code></pre></div><h3 id=故障排除>故障排除<a hidden class=anchor aria-hidden=true href=#故障排除>#</a></h3><ol><li><p><strong>端口冲突</strong>：修改 <code>.env</code> 文件中的端口映射</p><pre tabindex=0><code>NGINX_HOST_HTTP_PORT=8080
MYSQL_PORT=33060
</code></pre></li><li><p><strong>权限问题</strong>：确保 PUID/PGID 设置正确</p><pre tabindex=0><code>PUID=$(id -u)
PGID=$(id -g)
</code></pre></li><li><p><strong>内存不足</strong>：增加 Docker 分配的资源，或减少启用的服务</p><pre tabindex=0><code>docker compose up -d nginx php-fpm mysql
</code></pre></li></ol><h2 id=高级功能>高级功能<a hidden class=anchor aria-hidden=true href=#高级功能>#</a></h2><h3 id=多项目环境>多项目环境<a hidden class=anchor aria-hidden=true href=#多项目环境>#</a></h3><p>Laradock 支持同时运行多个项目：</p><pre tabindex=0><code>.
├── laradock/
│   ├── docker-compose.yml
│   └── .env
├── project1/
├── project2/
└── project3/
</code></pre><p>配置示例：</p><pre tabindex=0><code class=language-dotenv data-lang=dotenv>APP_CODE_PATH_HOST=../:/var/www
NGINX_SITES_PATH=./nginx/sites/
</code></pre><p>然后为每个项目创建 Nginx 配置文件：</p><pre tabindex=0><code># ./nginx/sites/project1.conf
server {
    server_name project1.test;
    root /var/www/project1/public;
    # ...
}
</code></pre><h3 id=多架构支持>多架构支持<a hidden class=anchor aria-hidden=true href=#多架构支持>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 支持 ARM 和 x86 架构</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> --platform=${TARGETPLATFORM} php:${PHP_VERSION}-fpm-alpine</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> TARGETPLATFORM<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> BUILDPLATFORM<span class=err>
</span></span></span></code></pre></div><p>Laradock 现代版本支持：</p><ul><li>使用 Docker BuildKit 进行多架构构建</li><li>在 ARM 设备（M1/M2 Mac、树莓派）上本地开发</li><li>通过 GitHub Actions 实现跨平台自动构建</li></ul><p>使用多架构镜像的命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 显示支持的架构</span>
</span></span><span class=line><span class=cl>docker manifest inspect laradock/workspace:latest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建多架构镜像</span>
</span></span><span class=line><span class=cl>docker buildx build --platform linux/amd64,linux/arm64 -t myname/myapp:latest .
</span></span></code></pre></div><h3 id=cicd-集成>CI/CD 集成<a hidden class=anchor aria-hidden=true href=#cicd-集成>#</a></h3><p>Laradock 可以与各种 CI/CD 工具集成：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># .gitlab-ci.yml 示例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>stages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>deploy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>cd laradock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker compose build php-fpm workspace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>test</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>cd laradock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker compose up -d php-fpm mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker compose exec workspace php artisan test</span><span class=w>
</span></span></span></code></pre></div><p>可以使用 Docker Compose 的 <code>--profile</code> 参数为不同环境创建配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 开发环境</span>
</span></span><span class=line><span class=cl>docker compose --profile dev up -d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试环境</span>
</span></span><span class=line><span class=cl>docker compose --profile <span class=nb>test</span> up -d
</span></span></code></pre></div><h2 id=最佳实践>最佳实践<a hidden class=anchor aria-hidden=true href=#最佳实践>#</a></h2><h3 id=优化构建速度>优化构建速度<a hidden class=anchor aria-hidden=true href=#优化构建速度>#</a></h3><ol><li><p><strong>使用 BuildKit</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>DOCKER_BUILDKIT</span><span class=o>=</span><span class=m>1</span> docker compose build
</span></span></code></pre></div></li><li><p><strong>创建层缓存</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 先复制依赖文件，安装依赖，然后再复制应用代码</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> composer.json composer.lock ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> composer install --no-scripts --no-autoloader<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> composer dump-autoload --optimize<span class=err>
</span></span></span></code></pre></div></li><li><p><strong>多阶段构建</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> php:7.4-fpm AS builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 安装构建依赖...</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> php:7.4-fpm</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 只复制需要的文件</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /var/www/vendor /var/www/vendor<span class=err>
</span></span></span></code></pre></div></li></ol><h3 id=安全最佳实践>安全最佳实践<a hidden class=anchor aria-hidden=true href=#安全最佳实践>#</a></h3><ol><li><p><strong>避免使用 root 用户</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>USER</span><span class=s> laradock</span><span class=err>
</span></span></span></code></pre></div></li><li><p><strong>限制容器能力</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>security_opt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=kc>no</span>-<span class=l>new-privileges:true</span><span class=w>
</span></span></span></code></pre></div></li><li><p><strong>使用健康检查</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;CMD&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;php&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-v&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></div></li><li><p><strong>定期更新基础镜像</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker compose pull
</span></span><span class=line><span class=cl>docker compose build --pull
</span></span></code></pre></div></li></ol><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://laradock.io/documentation/>Laradock 官方文档</a></li><li><a href=https://github.com/laradock/laradock>Laradock GitHub 仓库</a></li><li><a href=https://docs.docker.com/>Docker 官方文档</a></li><li><a href=https://www.php.net/manual/zh/>PHP 官方文档</a></li><li><a href=https://dev.to/dendihandian/laradock-a-php-developer-s-best-friend-33ef>Laradock - A PHP Developer&rsquo;s best friend. | dev.to</a></li><li><a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/>如何优化 Docker 镜像构建</a></li><li><a href=https://docs.docker.com/compose/reference/>Docker Compose 参考</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://zyf.im/tags/php/>Php</a></li><li><a href=https://zyf.im/tags/docker/>Docker</a></li></ul><nav class=paginav><a class=prev href=https://zyf.im/2022/11/17/docker-code-snippet/><span class=title>« Prev</span><br><span>Docker Code Snippet</span>
</a><a class=next href=https://zyf.im/2022/10/01/git-code-snippet/><span class=title>Next »</span><br><span>Git Code Snippet</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://zyf.im/>ZYF.IM BLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>