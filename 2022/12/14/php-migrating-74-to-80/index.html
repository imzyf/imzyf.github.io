<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>PHP Migrating 7.4 to 8.0 | ZYF.IM BLOG</title><meta name=keywords content="php"><meta name=description content='
实验环境：https://onlinephp.io/
https://www.php.net/releases/8.0/en.php
https://www.php.net/manual/en/migration80.php
https://php.watch/versions/8.0
https://github.com/symfony/polyfill/tree/1.x/src/Php80


PHP 8.0 contains many new features and optimizations including named arguments, union types, attributes, constructor property promotion, match expression, nullsafe operator, JIT, and improvements in the type system, error handling, and consistency.
New Features 8.0
// Named Parameters 命名参数
// https://www.php.net/manual/zh/functions.arguments.php#functions.named-arguments
// array_fill(int $start_index, int $count, mixed $value): array
var_dump(array_fill(value: 50, count: 3, start_index: 0));
// PHP80 [50, 50, 50]
// 注解（Attributes）
// https://www.php.net/manual/zh/language.attributes.php
// 定义注解 -> 使用注解 -> （通过反射）提取注释
// 注意以后用词：Attributes 注解，Properties 属性
#[\Attribute]
class JsonSerialize {
    public function __construct(public ?string $fieldName = null) {
        var_dump("JsonSerialize:$fieldName");
    }
}
class VersionedObject {
    #[JsonSerialize(&#39;json-foobar&#39;)]
    protected string $myValue = &#39;&#39;;
}
$object = new VersionedObject();
$reflection = new ReflectionObject($object);
foreach ($reflection->getProperties() as $reflectionProp) {
    foreach ($reflectionProp->getAttributes(JsonSerialize::class) as $jsonSerializeAttr) {
        var_dump($jsonSerializeAttr->getName());
        var_dump($jsonSerializeAttr->getArguments());
        var_dump($jsonSerializeAttr->getTarget());
        var_dump($jsonSerializeAttr->isRepeated());
        var_dump($jsonSerializeAttr->newInstance());
    }
}
// string(13) "JsonSerialize"
//
// array(1) {
//   [0]=>
//   string(11) "json-foobar"
// }
//
// int(8) Attribute::TARGET_PROPERTY
//
// bool(false)
//
// string(25) "JsonSerialize:json-foobar"
// object(JsonSerialize)#5 (1) {
//   ["fieldName"]=>
//   string(11) "json-foobar"
// }
// 构造器属性提升 Constructor Property Promotion
// 当构造器参数带访问控制（visibility modifier）时，PHP 会同时把它当作对象属性和构造器参数，并赋值到属性
class Point {
    public function __construct(protected int $x, protected int $y = 0) {}
}
var_dump(new Point(2,4));
// object(Point)#1 (2) {
//   ["x":protected]=>
//   int(2)
//   ["y":protected]=>
//   int(4)
// }
class Point2 {
    protected int $x;
    protected int $y;
    public function __construct(protected int $x, protected int $y = 0) {}
}
// 此类中已经定义了具有相同名称的字段
// Fatal error: Cannot redeclare Point::$x
// Union types 联合类型
// ?T is same T|null
//
// - 类型只能出现一次 int|string|INT 否则报错
// - 使用 mixed 会报错
// - bool 与 false or true 不能混用
// - object 与 class 不能混用
// - iterable 与 array Traversable 不能混用
// - 使用 self、parent 或 static 都会导致错误
public function parse_value(string|int|float): string|null {}
// match 表达式
// https://www.php.net/manual/en/control-structures.match.php
// match 表达式必须是详尽，则会抛出 UnhandledMatchError。
echo match (8.0) {
    &#39;8.0&#39; => "Oh no!",
    8.0 => "This matches",
};
// This matches
// Nullsafe Operator
$result = $repository?->getUser(5)?->name;
// Is equivalent to the following code block:
if (is_null($repository)) {
    $result = null;
} else {
    $user = $repository->getUser(5);
    if (is_null($user)) {
        $result = null;
    } else {
        $result = $user->name;
    }
}
// Argument Unpacking
echo str_replace(...[
    &#39;replace&#39; => &#39;Iron Man&#39;,
    &#39;search&#39; => &#39;Inevitable&#39;,
    &#39;subject&#39; => &#39;I am Inevitable&#39;,
]);
// Named Parameters with Variadic Parameters
function test($a, $b, ...$args) {
    var_dump($args);
}
test(28, 15, june: 6, september: 15, january: "01");
// array(3) {
//     ["june"]=> int(6)
//     ["september"]=> int(15)
//     ["january"]=> string(2) "01"
// }
// JIT Just-In-Time Compilation
// php -i | grep -i opcache
// php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing -i | grep -i jit

// opcache.enable=1
// opcache.enable_cli=1
// opcache.jit_buffer_size=256M

<?php
function fibonacci($n) {
    if ($n < 2) return $n;
    return fibonacci($n - 1) + fibonacci($n - 2);
}

$start = microtime(true);

fibonacci(42);

$end = microtime(true);
echo "Time taken: " . ($end - $start) . " seconds\n";

// php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing test.php
// The WeakMap class has been added, accepts objects as keys, similar SplObjectStorage
// https://www.php.net/manual/en/class.weakmap.php
// https://www.php.net/manual/en/class.splobjectstorage.php
// final class WeakMap implements ArrayAccess, Countable, IteratorAggregate
$wm = new WeakMap();
$o = new StdClass;
class A {
    public function __destruct() {
        echo "Dead!\n";
    }
}
$wm[$o] = new A;
var_dump(count($wm));
// int(1)
unset($o);
// Dead!
// 销毁
var_dump(count($wm));
// int(0)

// 对比 SplObjectStorage
$wm = new SplObjectStorage();
$o = new StdClass;
class A {
    public function __destruct() {
        echo "Dead!\n";
    }
}
$wm[$o] = new A;
var_dump(count($wm));
// int(1)
unset($o);
// 未销毁
var_dump(count($wm));
// int(1)
// 只要类型兼容，现在可以将任意数量的函数参数替换为可变参数 variadic argument
class A {
    public function method(int $many, string $parameters, $here) {}
}
class B extends A {
    public function method(...$everything) {}
}
// OK
class C extends A {
    public function method(int ...$everything) {}
}
// Fatal error: Declaration of C::method(int ...$everything)
// static 后期静态绑定，现在可以用作返回类型
class Test {
    public function create(): static {
        return new static();
    }
}
// get_class($obj) === $obj::class
class Test {}
$obj = new Test;
var_dump($obj::class);
var_dump(get_class($obj));
// new instanceof 可以与任意表达式一起使用
// new (expression)(...$args)
// $obj instanceof (expression)
class A{};
class B{};
new (1>2 ? "A" : "B")();
// 新增 Stringable 接口。如果 class 定义了 __toString()，则自动实现了此接口
// Traits can define abstract private methods
trait T {
    abstract private function a();
}
// Throw 可以作为一个表达式 as an expression
$value = $config[&#39;path&#39;] ?? throw new InvalidArgumentException(&#39;path required&#39;);
$fn = fn() => throw new Exception(&#39;Exception in arrow function&#39;);
// 参数列表中现在允许使用可选的尾随逗号
function functionWithLongSignature(
    Type1 $parameter1,
    Type2 $parameter2, // <-- This comma is now allowed.
) {}
// 允许 catch (Exception) 无需存储到变量
try {}
catch (Exception) {}
// 在父类上声明的私有方法不再对子类的方法强制执行任何继承规则（私有构造函数除外）
class ParentClass {
    private function method1() {}
    private function method2() {}
    private static function method3() {}
}
abstract class ChildClass extends ParentClass {
    public abstract function method1();
    public static function method2() {}
    public function method3() {}
}
// OK
// New string functions
str_contains(&#39;Foobar&#39;, &#39;Foo&#39;); // true
str_starts_with(&#39;PHP 8&#39;, &#39;PHP&#39;); // true
str_ends_with(&#39;Version8&#39;, &#39;8&#39;); // true
Backward Incompatible Changes 8.0
// 字符串与数字比较
// 0 == "not-a-number" is false
// 将数字转换为字符串，并使用字符串比较
var_dump(0 == "foo");
var_dump(42 == "42foo");
var_dump(0 == "");
// PHP80           PHP74
// bool(false)     true
// bool(false)     true
// bool(false)     true

var_dump("" < 0);
var_dump("" < -1);
var_dump("a" < 0);
var_dump("b" < -1);
var_dump("ab" > 0);
// PHP80           PHP74
// bool(true)      false
// bool(true)      false
// bool(false)     false
// bool(false)     false
// bool(true)      false
// is_callable() 在检查具有 classname 的 non-static 方法时将 false（必须检查对象实例）
class Test {
    public function method1() {}
}
var_dump(is_callable([Test::class, &#39;method1&#39;]));
var_dump(is_callable([new Test, &#39;method1&#39;]));
// PHP80           PHP74
// bool(false)     true
// bool(true)      true
// __autoload() function has been removed
// 删除了对 object 使用 array_key_exists() 的能力。isset() or property_exists() may be used instead
// isset($arr[&#39;key&#39;]) → false（当值为 null）- 只能在 null 安全时检查，无法区分 null 与 不存在
// array_key_exists(&#39;key&#39;, $arr) → true（即使值为 null）- 可以区分存在但值为 null 的情况
&ndash; EOF &ndash;'><meta name=author content="Me"><link rel=canonical href=https://zyf.im/2022/12/14/php-migrating-74-to-80/><link crossorigin=anonymous href=/assets/css/stylesheet.63618a0fd0c7dd946ad6f368012c097fc6e5a8464cefd289c140dd28c01ec58d.css integrity="sha256-Y2GKD9DH3ZRq1vNoASwJf8blqEZM79KJwUDdKMAexY0=" rel="preload stylesheet" as=style><link rel=icon href=https://zyf.im/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zyf.im/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zyf.im/favicon-32x32.png><link rel=apple-touch-icon href=https://zyf.im/apple-touch-icon.png><link rel=mask-icon href=https://zyf.im/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zyf.im/2022/12/14/php-migrating-74-to-80/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6DVZ6E58DG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6DVZ6E58DG")}</script><meta property="og:url" content="https://zyf.im/2022/12/14/php-migrating-74-to-80/"><meta property="og:site_name" content="ZYF.IM BLOG"><meta property="og:title" content="PHP Migrating 7.4 to 8.0"><meta property="og:description" content=' 实验环境：https://onlinephp.io/ https://www.php.net/releases/8.0/en.php https://www.php.net/manual/en/migration80.php https://php.watch/versions/8.0 https://github.com/symfony/polyfill/tree/1.x/src/Php80 PHP 8.0 contains many new features and optimizations including named arguments, union types, attributes, constructor property promotion, match expression, nullsafe operator, JIT, and improvements in the type system, error handling, and consistency.
New Features 8.0 // Named Parameters 命名参数 // https://www.php.net/manual/zh/functions.arguments.php#functions.named-arguments // array_fill(int $start_index, int $count, mixed $value): array var_dump(array_fill(value: 50, count: 3, start_index: 0)); // PHP80 [50, 50, 50] // 注解（Attributes） // https://www.php.net/manual/zh/language.attributes.php // 定义注解 -> 使用注解 -> （通过反射）提取注释 // 注意以后用词：Attributes 注解，Properties 属性 #[\Attribute] class JsonSerialize { public function __construct(public ?string $fieldName = null) { var_dump("JsonSerialize:$fieldName"); } } class VersionedObject { #[JsonSerialize(&#39;json-foobar&#39;)] protected string $myValue = &#39;&#39;; } $object = new VersionedObject(); $reflection = new ReflectionObject($object); foreach ($reflection->getProperties() as $reflectionProp) { foreach ($reflectionProp->getAttributes(JsonSerialize::class) as $jsonSerializeAttr) { var_dump($jsonSerializeAttr->getName()); var_dump($jsonSerializeAttr->getArguments()); var_dump($jsonSerializeAttr->getTarget()); var_dump($jsonSerializeAttr->isRepeated()); var_dump($jsonSerializeAttr->newInstance()); } } // string(13) "JsonSerialize" // // array(1) { // [0]=> // string(11) "json-foobar" // } // // int(8) Attribute::TARGET_PROPERTY // // bool(false) // // string(25) "JsonSerialize:json-foobar" // object(JsonSerialize)#5 (1) { // ["fieldName"]=> // string(11) "json-foobar" // } // 构造器属性提升 Constructor Property Promotion // 当构造器参数带访问控制（visibility modifier）时，PHP 会同时把它当作对象属性和构造器参数，并赋值到属性 class Point { public function __construct(protected int $x, protected int $y = 0) {} } var_dump(new Point(2,4)); // object(Point)#1 (2) { // ["x":protected]=> // int(2) // ["y":protected]=> // int(4) // } class Point2 { protected int $x; protected int $y; public function __construct(protected int $x, protected int $y = 0) {} } // 此类中已经定义了具有相同名称的字段 // Fatal error: Cannot redeclare Point::$x // Union types 联合类型 // ?T is same T|null // // - 类型只能出现一次 int|string|INT 否则报错 // - 使用 mixed 会报错 // - bool 与 false or true 不能混用 // - object 与 class 不能混用 // - iterable 与 array Traversable 不能混用 // - 使用 self、parent 或 static 都会导致错误 public function parse_value(string|int|float): string|null {} // match 表达式 // https://www.php.net/manual/en/control-structures.match.php // match 表达式必须是详尽，则会抛出 UnhandledMatchError。 echo match (8.0) { &#39;8.0&#39; => "Oh no!", 8.0 => "This matches", }; // This matches // Nullsafe Operator $result = $repository?->getUser(5)?->name; // Is equivalent to the following code block: if (is_null($repository)) { $result = null; } else { $user = $repository->getUser(5); if (is_null($user)) { $result = null; } else { $result = $user->name; } } // Argument Unpacking echo str_replace(...[ &#39;replace&#39; => &#39;Iron Man&#39;, &#39;search&#39; => &#39;Inevitable&#39;, &#39;subject&#39; => &#39;I am Inevitable&#39;, ]); // Named Parameters with Variadic Parameters function test($a, $b, ...$args) { var_dump($args); } test(28, 15, june: 6, september: 15, january: "01"); // array(3) { // ["june"]=> int(6) // ["september"]=> int(15) // ["january"]=> string(2) "01" // } // JIT Just-In-Time Compilation // php -i | grep -i opcache // php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing -i | grep -i jit // opcache.enable=1 // opcache.enable_cli=1 // opcache.jit_buffer_size=256M <?php function fibonacci($n) { if ($n < 2) return $n; return fibonacci($n - 1) + fibonacci($n - 2); } $start = microtime(true); fibonacci(42); $end = microtime(true); echo "Time taken: " . ($end - $start) . " seconds\n"; // php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing test.php // The WeakMap class has been added, accepts objects as keys, similar SplObjectStorage // https://www.php.net/manual/en/class.weakmap.php // https://www.php.net/manual/en/class.splobjectstorage.php // final class WeakMap implements ArrayAccess, Countable, IteratorAggregate $wm = new WeakMap(); $o = new StdClass; class A { public function __destruct() { echo "Dead!\n"; } } $wm[$o] = new A; var_dump(count($wm)); // int(1) unset($o); // Dead! // 销毁 var_dump(count($wm)); // int(0) // 对比 SplObjectStorage $wm = new SplObjectStorage(); $o = new StdClass; class A { public function __destruct() { echo "Dead!\n"; } } $wm[$o] = new A; var_dump(count($wm)); // int(1) unset($o); // 未销毁 var_dump(count($wm)); // int(1) // 只要类型兼容，现在可以将任意数量的函数参数替换为可变参数 variadic argument class A { public function method(int $many, string $parameters, $here) {} } class B extends A { public function method(...$everything) {} } // OK class C extends A { public function method(int ...$everything) {} } // Fatal error: Declaration of C::method(int ...$everything) // static 后期静态绑定，现在可以用作返回类型 class Test { public function create(): static { return new static(); } } // get_class($obj) === $obj::class class Test {} $obj = new Test; var_dump($obj::class); var_dump(get_class($obj)); // new instanceof 可以与任意表达式一起使用 // new (expression)(...$args) // $obj instanceof (expression) class A{}; class B{}; new (1>2 ? "A" : "B")(); // 新增 Stringable 接口。如果 class 定义了 __toString()，则自动实现了此接口 // Traits can define abstract private methods trait T { abstract private function a(); } // Throw 可以作为一个表达式 as an expression $value = $config[&#39;path&#39;] ?? throw new InvalidArgumentException(&#39;path required&#39;); $fn = fn() => throw new Exception(&#39;Exception in arrow function&#39;); // 参数列表中现在允许使用可选的尾随逗号 function functionWithLongSignature( Type1 $parameter1, Type2 $parameter2, // <-- This comma is now allowed. ) {} // 允许 catch (Exception) 无需存储到变量 try {} catch (Exception) {} // 在父类上声明的私有方法不再对子类的方法强制执行任何继承规则（私有构造函数除外） class ParentClass { private function method1() {} private function method2() {} private static function method3() {} } abstract class ChildClass extends ParentClass { public abstract function method1(); public static function method2() {} public function method3() {} } // OK // New string functions str_contains(&#39;Foobar&#39;, &#39;Foo&#39;); // true str_starts_with(&#39;PHP 8&#39;, &#39;PHP&#39;); // true str_ends_with(&#39;Version8&#39;, &#39;8&#39;); // true Backward Incompatible Changes 8.0 // 字符串与数字比较 // 0 == "not-a-number" is false // 将数字转换为字符串，并使用字符串比较 var_dump(0 == "foo"); var_dump(42 == "42foo"); var_dump(0 == ""); // PHP80 PHP74 // bool(false) true // bool(false) true // bool(false) true var_dump("" < 0); var_dump("" < -1); var_dump("a" < 0); var_dump("b" < -1); var_dump("ab" > 0); // PHP80 PHP74 // bool(true) false // bool(true) false // bool(false) false // bool(false) false // bool(true) false // is_callable() 在检查具有 classname 的 non-static 方法时将 false（必须检查对象实例） class Test { public function method1() {} } var_dump(is_callable([Test::class, &#39;method1&#39;])); var_dump(is_callable([new Test, &#39;method1&#39;])); // PHP80 PHP74 // bool(false) true // bool(true) true // __autoload() function has been removed // 删除了对 object 使用 array_key_exists() 的能力。isset() or property_exists() may be used instead // isset($arr[&#39;key&#39;]) → false（当值为 null）- 只能在 null 安全时检查，无法区分 null 与 不存在 // array_key_exists(&#39;key&#39;, $arr) → true（即使值为 null）- 可以区分存在但值为 null 的情况 – EOF –'><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-14T16:40:03+08:00"><meta property="article:modified_time" content="2022-12-14T16:40:03+08:00"><meta property="article:tag" content="Php"><meta property="og:image" content="https://images.unsplash.com/photo-1516915616915-048be9a5209d?q=80&amp;w=960&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1516915616915-048be9a5209d?q=80&amp;w=960&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3"><meta name=twitter:title content="PHP Migrating 7.4 to 8.0"><meta name=twitter:description content='
实验环境：https://onlinephp.io/
https://www.php.net/releases/8.0/en.php
https://www.php.net/manual/en/migration80.php
https://php.watch/versions/8.0
https://github.com/symfony/polyfill/tree/1.x/src/Php80


PHP 8.0 contains many new features and optimizations including named arguments, union types, attributes, constructor property promotion, match expression, nullsafe operator, JIT, and improvements in the type system, error handling, and consistency.
New Features 8.0
// Named Parameters 命名参数
// https://www.php.net/manual/zh/functions.arguments.php#functions.named-arguments
// array_fill(int $start_index, int $count, mixed $value): array
var_dump(array_fill(value: 50, count: 3, start_index: 0));
// PHP80 [50, 50, 50]
// 注解（Attributes）
// https://www.php.net/manual/zh/language.attributes.php
// 定义注解 -> 使用注解 -> （通过反射）提取注释
// 注意以后用词：Attributes 注解，Properties 属性
#[\Attribute]
class JsonSerialize {
    public function __construct(public ?string $fieldName = null) {
        var_dump("JsonSerialize:$fieldName");
    }
}
class VersionedObject {
    #[JsonSerialize(&#39;json-foobar&#39;)]
    protected string $myValue = &#39;&#39;;
}
$object = new VersionedObject();
$reflection = new ReflectionObject($object);
foreach ($reflection->getProperties() as $reflectionProp) {
    foreach ($reflectionProp->getAttributes(JsonSerialize::class) as $jsonSerializeAttr) {
        var_dump($jsonSerializeAttr->getName());
        var_dump($jsonSerializeAttr->getArguments());
        var_dump($jsonSerializeAttr->getTarget());
        var_dump($jsonSerializeAttr->isRepeated());
        var_dump($jsonSerializeAttr->newInstance());
    }
}
// string(13) "JsonSerialize"
//
// array(1) {
//   [0]=>
//   string(11) "json-foobar"
// }
//
// int(8) Attribute::TARGET_PROPERTY
//
// bool(false)
//
// string(25) "JsonSerialize:json-foobar"
// object(JsonSerialize)#5 (1) {
//   ["fieldName"]=>
//   string(11) "json-foobar"
// }
// 构造器属性提升 Constructor Property Promotion
// 当构造器参数带访问控制（visibility modifier）时，PHP 会同时把它当作对象属性和构造器参数，并赋值到属性
class Point {
    public function __construct(protected int $x, protected int $y = 0) {}
}
var_dump(new Point(2,4));
// object(Point)#1 (2) {
//   ["x":protected]=>
//   int(2)
//   ["y":protected]=>
//   int(4)
// }
class Point2 {
    protected int $x;
    protected int $y;
    public function __construct(protected int $x, protected int $y = 0) {}
}
// 此类中已经定义了具有相同名称的字段
// Fatal error: Cannot redeclare Point::$x
// Union types 联合类型
// ?T is same T|null
//
// - 类型只能出现一次 int|string|INT 否则报错
// - 使用 mixed 会报错
// - bool 与 false or true 不能混用
// - object 与 class 不能混用
// - iterable 与 array Traversable 不能混用
// - 使用 self、parent 或 static 都会导致错误
public function parse_value(string|int|float): string|null {}
// match 表达式
// https://www.php.net/manual/en/control-structures.match.php
// match 表达式必须是详尽，则会抛出 UnhandledMatchError。
echo match (8.0) {
    &#39;8.0&#39; => "Oh no!",
    8.0 => "This matches",
};
// This matches
// Nullsafe Operator
$result = $repository?->getUser(5)?->name;
// Is equivalent to the following code block:
if (is_null($repository)) {
    $result = null;
} else {
    $user = $repository->getUser(5);
    if (is_null($user)) {
        $result = null;
    } else {
        $result = $user->name;
    }
}
// Argument Unpacking
echo str_replace(...[
    &#39;replace&#39; => &#39;Iron Man&#39;,
    &#39;search&#39; => &#39;Inevitable&#39;,
    &#39;subject&#39; => &#39;I am Inevitable&#39;,
]);
// Named Parameters with Variadic Parameters
function test($a, $b, ...$args) {
    var_dump($args);
}
test(28, 15, june: 6, september: 15, january: "01");
// array(3) {
//     ["june"]=> int(6)
//     ["september"]=> int(15)
//     ["january"]=> string(2) "01"
// }
// JIT Just-In-Time Compilation
// php -i | grep -i opcache
// php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing -i | grep -i jit

// opcache.enable=1
// opcache.enable_cli=1
// opcache.jit_buffer_size=256M

<?php
function fibonacci($n) {
    if ($n < 2) return $n;
    return fibonacci($n - 1) + fibonacci($n - 2);
}

$start = microtime(true);

fibonacci(42);

$end = microtime(true);
echo "Time taken: " . ($end - $start) . " seconds\n";

// php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing test.php
// The WeakMap class has been added, accepts objects as keys, similar SplObjectStorage
// https://www.php.net/manual/en/class.weakmap.php
// https://www.php.net/manual/en/class.splobjectstorage.php
// final class WeakMap implements ArrayAccess, Countable, IteratorAggregate
$wm = new WeakMap();
$o = new StdClass;
class A {
    public function __destruct() {
        echo "Dead!\n";
    }
}
$wm[$o] = new A;
var_dump(count($wm));
// int(1)
unset($o);
// Dead!
// 销毁
var_dump(count($wm));
// int(0)

// 对比 SplObjectStorage
$wm = new SplObjectStorage();
$o = new StdClass;
class A {
    public function __destruct() {
        echo "Dead!\n";
    }
}
$wm[$o] = new A;
var_dump(count($wm));
// int(1)
unset($o);
// 未销毁
var_dump(count($wm));
// int(1)
// 只要类型兼容，现在可以将任意数量的函数参数替换为可变参数 variadic argument
class A {
    public function method(int $many, string $parameters, $here) {}
}
class B extends A {
    public function method(...$everything) {}
}
// OK
class C extends A {
    public function method(int ...$everything) {}
}
// Fatal error: Declaration of C::method(int ...$everything)
// static 后期静态绑定，现在可以用作返回类型
class Test {
    public function create(): static {
        return new static();
    }
}
// get_class($obj) === $obj::class
class Test {}
$obj = new Test;
var_dump($obj::class);
var_dump(get_class($obj));
// new instanceof 可以与任意表达式一起使用
// new (expression)(...$args)
// $obj instanceof (expression)
class A{};
class B{};
new (1>2 ? "A" : "B")();
// 新增 Stringable 接口。如果 class 定义了 __toString()，则自动实现了此接口
// Traits can define abstract private methods
trait T {
    abstract private function a();
}
// Throw 可以作为一个表达式 as an expression
$value = $config[&#39;path&#39;] ?? throw new InvalidArgumentException(&#39;path required&#39;);
$fn = fn() => throw new Exception(&#39;Exception in arrow function&#39;);
// 参数列表中现在允许使用可选的尾随逗号
function functionWithLongSignature(
    Type1 $parameter1,
    Type2 $parameter2, // <-- This comma is now allowed.
) {}
// 允许 catch (Exception) 无需存储到变量
try {}
catch (Exception) {}
// 在父类上声明的私有方法不再对子类的方法强制执行任何继承规则（私有构造函数除外）
class ParentClass {
    private function method1() {}
    private function method2() {}
    private static function method3() {}
}
abstract class ChildClass extends ParentClass {
    public abstract function method1();
    public static function method2() {}
    public function method3() {}
}
// OK
// New string functions
str_contains(&#39;Foobar&#39;, &#39;Foo&#39;); // true
str_starts_with(&#39;PHP 8&#39;, &#39;PHP&#39;); // true
str_ends_with(&#39;Version8&#39;, &#39;8&#39;); // true
Backward Incompatible Changes 8.0
// 字符串与数字比较
// 0 == "not-a-number" is false
// 将数字转换为字符串，并使用字符串比较
var_dump(0 == "foo");
var_dump(42 == "42foo");
var_dump(0 == "");
// PHP80           PHP74
// bool(false)     true
// bool(false)     true
// bool(false)     true

var_dump("" < 0);
var_dump("" < -1);
var_dump("a" < 0);
var_dump("b" < -1);
var_dump("ab" > 0);
// PHP80           PHP74
// bool(true)      false
// bool(true)      false
// bool(false)     false
// bool(false)     false
// bool(true)      false
// is_callable() 在检查具有 classname 的 non-static 方法时将 false（必须检查对象实例）
class Test {
    public function method1() {}
}
var_dump(is_callable([Test::class, &#39;method1&#39;]));
var_dump(is_callable([new Test, &#39;method1&#39;]));
// PHP80           PHP74
// bool(false)     true
// bool(true)      true
// __autoload() function has been removed
// 删除了对 object 使用 array_key_exists() 的能力。isset() or property_exists() may be used instead
// isset($arr[&#39;key&#39;]) → false（当值为 null）- 只能在 null 安全时检查，无法区分 null 与 不存在
// array_key_exists(&#39;key&#39;, $arr) → true（即使值为 null）- 可以区分存在但值为 null 的情况
&ndash; EOF &ndash;'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zyf.im/posts/"},{"@type":"ListItem","position":2,"name":"PHP Migrating 7.4 to 8.0","item":"https://zyf.im/2022/12/14/php-migrating-74-to-80/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"PHP Migrating 7.4 to 8.0","name":"PHP Migrating 7.4 to 8.0","description":" 实验环境：https://onlinephp.io/ https://www.php.net/releases/8.0/en.php https://www.php.net/manual/en/migration80.php https://php.watch/versions/8.0 https://github.com/symfony/polyfill/tree/1.x/src/Php80 PHP 8.0 contains many new features and optimizations including named arguments, union types, attributes, constructor property promotion, match expression, nullsafe operator, JIT, and improvements in the type system, error handling, and consistency.\nNew Features 8.0 // Named Parameters 命名参数 // https://www.php.net/manual/zh/functions.arguments.php#functions.named-arguments // array_fill(int $start_index, int $count, mixed $value): array var_dump(array_fill(value: 50, count: 3, start_index: 0)); // PHP80 [50, 50, 50] // 注解（Attributes） // https://www.php.net/manual/zh/language.attributes.php // 定义注解 -\u0026gt; 使用注解 -\u0026gt; （通过反射）提取注释 // 注意以后用词：Attributes 注解，Properties 属性 #[\\Attribute] class JsonSerialize { public function __construct(public ?string $fieldName = null) { var_dump(\u0026#34;JsonSerialize:$fieldName\u0026#34;); } } class VersionedObject { #[JsonSerialize(\u0026#39;json-foobar\u0026#39;)] protected string $myValue = \u0026#39;\u0026#39;; } $object = new VersionedObject(); $reflection = new ReflectionObject($object); foreach ($reflection-\u0026gt;getProperties() as $reflectionProp) { foreach ($reflectionProp-\u0026gt;getAttributes(JsonSerialize::class) as $jsonSerializeAttr) { var_dump($jsonSerializeAttr-\u0026gt;getName()); var_dump($jsonSerializeAttr-\u0026gt;getArguments()); var_dump($jsonSerializeAttr-\u0026gt;getTarget()); var_dump($jsonSerializeAttr-\u0026gt;isRepeated()); var_dump($jsonSerializeAttr-\u0026gt;newInstance()); } } // string(13) \u0026#34;JsonSerialize\u0026#34; // // array(1) { // [0]=\u0026gt; // string(11) \u0026#34;json-foobar\u0026#34; // } // // int(8) Attribute::TARGET_PROPERTY // // bool(false) // // string(25) \u0026#34;JsonSerialize:json-foobar\u0026#34; // object(JsonSerialize)#5 (1) { // [\u0026#34;fieldName\u0026#34;]=\u0026gt; // string(11) \u0026#34;json-foobar\u0026#34; // } // 构造器属性提升 Constructor Property Promotion // 当构造器参数带访问控制（visibility modifier）时，PHP 会同时把它当作对象属性和构造器参数，并赋值到属性 class Point { public function __construct(protected int $x, protected int $y = 0) {} } var_dump(new Point(2,4)); // object(Point)#1 (2) { // [\u0026#34;x\u0026#34;:protected]=\u0026gt; // int(2) // [\u0026#34;y\u0026#34;:protected]=\u0026gt; // int(4) // } class Point2 { protected int $x; protected int $y; public function __construct(protected int $x, protected int $y = 0) {} } // 此类中已经定义了具有相同名称的字段 // Fatal error: Cannot redeclare Point::$x // Union types 联合类型 // ?T is same T|null // // - 类型只能出现一次 int|string|INT 否则报错 // - 使用 mixed 会报错 // - bool 与 false or true 不能混用 // - object 与 class 不能混用 // - iterable 与 array Traversable 不能混用 // - 使用 self、parent 或 static 都会导致错误 public function parse_value(string|int|float): string|null {} // match 表达式 // https://www.php.net/manual/en/control-structures.match.php // match 表达式必须是详尽，则会抛出 UnhandledMatchError。 echo match (8.0) { \u0026#39;8.0\u0026#39; =\u0026gt; \u0026#34;Oh no!\u0026#34;, 8.0 =\u0026gt; \u0026#34;This matches\u0026#34;, }; // This matches // Nullsafe Operator $result = $repository?-\u0026gt;getUser(5)?-\u0026gt;name; // Is equivalent to the following code block: if (is_null($repository)) { $result = null; } else { $user = $repository-\u0026gt;getUser(5); if (is_null($user)) { $result = null; } else { $result = $user-\u0026gt;name; } } // Argument Unpacking echo str_replace(...[ \u0026#39;replace\u0026#39; =\u0026gt; \u0026#39;Iron Man\u0026#39;, \u0026#39;search\u0026#39; =\u0026gt; \u0026#39;Inevitable\u0026#39;, \u0026#39;subject\u0026#39; =\u0026gt; \u0026#39;I am Inevitable\u0026#39;, ]); // Named Parameters with Variadic Parameters function test($a, $b, ...$args) { var_dump($args); } test(28, 15, june: 6, september: 15, january: \u0026#34;01\u0026#34;); // array(3) { // [\u0026#34;june\u0026#34;]=\u0026gt; int(6) // [\u0026#34;september\u0026#34;]=\u0026gt; int(15) // [\u0026#34;january\u0026#34;]=\u0026gt; string(2) \u0026#34;01\u0026#34; // } // JIT Just-In-Time Compilation // php -i | grep -i opcache // php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing -i | grep -i jit // opcache.enable=1 // opcache.enable_cli=1 // opcache.jit_buffer_size=256M \u0026lt;?php function fibonacci($n) { if ($n \u0026lt; 2) return $n; return fibonacci($n - 1) + fibonacci($n - 2); } $start = microtime(true); fibonacci(42); $end = microtime(true); echo \u0026#34;Time taken: \u0026#34; . ($end - $start) . \u0026#34; seconds\\n\u0026#34;; // php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing test.php // The WeakMap class has been added, accepts objects as keys, similar SplObjectStorage // https://www.php.net/manual/en/class.weakmap.php // https://www.php.net/manual/en/class.splobjectstorage.php // final class WeakMap implements ArrayAccess, Countable, IteratorAggregate $wm = new WeakMap(); $o = new StdClass; class A { public function __destruct() { echo \u0026#34;Dead!\\n\u0026#34;; } } $wm[$o] = new A; var_dump(count($wm)); // int(1) unset($o); // Dead! // 销毁 var_dump(count($wm)); // int(0) // 对比 SplObjectStorage $wm = new SplObjectStorage(); $o = new StdClass; class A { public function __destruct() { echo \u0026#34;Dead!\\n\u0026#34;; } } $wm[$o] = new A; var_dump(count($wm)); // int(1) unset($o); // 未销毁 var_dump(count($wm)); // int(1) // 只要类型兼容，现在可以将任意数量的函数参数替换为可变参数 variadic argument class A { public function method(int $many, string $parameters, $here) {} } class B extends A { public function method(...$everything) {} } // OK class C extends A { public function method(int ...$everything) {} } // Fatal error: Declaration of C::method(int ...$everything) // static 后期静态绑定，现在可以用作返回类型 class Test { public function create(): static { return new static(); } } // get_class($obj) === $obj::class class Test {} $obj = new Test; var_dump($obj::class); var_dump(get_class($obj)); // new instanceof 可以与任意表达式一起使用 // new (expression)(...$args) // $obj instanceof (expression) class A{}; class B{}; new (1\u0026gt;2 ? \u0026#34;A\u0026#34; : \u0026#34;B\u0026#34;)(); // 新增 Stringable 接口。如果 class 定义了 __toString()，则自动实现了此接口 // Traits can define abstract private methods trait T { abstract private function a(); } // Throw 可以作为一个表达式 as an expression $value = $config[\u0026#39;path\u0026#39;] ?? throw new InvalidArgumentException(\u0026#39;path required\u0026#39;); $fn = fn() =\u0026gt; throw new Exception(\u0026#39;Exception in arrow function\u0026#39;); // 参数列表中现在允许使用可选的尾随逗号 function functionWithLongSignature( Type1 $parameter1, Type2 $parameter2, // \u0026lt;-- This comma is now allowed. ) {} // 允许 catch (Exception) 无需存储到变量 try {} catch (Exception) {} // 在父类上声明的私有方法不再对子类的方法强制执行任何继承规则（私有构造函数除外） class ParentClass { private function method1() {} private function method2() {} private static function method3() {} } abstract class ChildClass extends ParentClass { public abstract function method1(); public static function method2() {} public function method3() {} } // OK // New string functions str_contains(\u0026#39;Foobar\u0026#39;, \u0026#39;Foo\u0026#39;); // true str_starts_with(\u0026#39;PHP 8\u0026#39;, \u0026#39;PHP\u0026#39;); // true str_ends_with(\u0026#39;Version8\u0026#39;, \u0026#39;8\u0026#39;); // true Backward Incompatible Changes 8.0 // 字符串与数字比较 // 0 == \u0026#34;not-a-number\u0026#34; is false // 将数字转换为字符串，并使用字符串比较 var_dump(0 == \u0026#34;foo\u0026#34;); var_dump(42 == \u0026#34;42foo\u0026#34;); var_dump(0 == \u0026#34;\u0026#34;); // PHP80 PHP74 // bool(false) true // bool(false) true // bool(false) true var_dump(\u0026#34;\u0026#34; \u0026lt; 0); var_dump(\u0026#34;\u0026#34; \u0026lt; -1); var_dump(\u0026#34;a\u0026#34; \u0026lt; 0); var_dump(\u0026#34;b\u0026#34; \u0026lt; -1); var_dump(\u0026#34;ab\u0026#34; \u0026gt; 0); // PHP80 PHP74 // bool(true) false // bool(true) false // bool(false) false // bool(false) false // bool(true) false // is_callable() 在检查具有 classname 的 non-static 方法时将 false（必须检查对象实例） class Test { public function method1() {} } var_dump(is_callable([Test::class, \u0026#39;method1\u0026#39;])); var_dump(is_callable([new Test, \u0026#39;method1\u0026#39;])); // PHP80 PHP74 // bool(false) true // bool(true) true // __autoload() function has been removed // 删除了对 object 使用 array_key_exists() 的能力。isset() or property_exists() may be used instead // isset($arr[\u0026#39;key\u0026#39;]) → false（当值为 null）- 只能在 null 安全时检查，无法区分 null 与 不存在 // array_key_exists(\u0026#39;key\u0026#39;, $arr) → true（即使值为 null）- 可以区分存在但值为 null 的情况 \u0026ndash; EOF \u0026ndash;\n","keywords":["php"],"articleBody":" 实验环境：https://onlinephp.io/ https://www.php.net/releases/8.0/en.php https://www.php.net/manual/en/migration80.php https://php.watch/versions/8.0 https://github.com/symfony/polyfill/tree/1.x/src/Php80 PHP 8.0 contains many new features and optimizations including named arguments, union types, attributes, constructor property promotion, match expression, nullsafe operator, JIT, and improvements in the type system, error handling, and consistency.\nNew Features 8.0 // Named Parameters 命名参数 // https://www.php.net/manual/zh/functions.arguments.php#functions.named-arguments // array_fill(int $start_index, int $count, mixed $value): array var_dump(array_fill(value: 50, count: 3, start_index: 0)); // PHP80 [50, 50, 50] // 注解（Attributes） // https://www.php.net/manual/zh/language.attributes.php // 定义注解 -\u003e 使用注解 -\u003e （通过反射）提取注释 // 注意以后用词：Attributes 注解，Properties 属性 #[\\Attribute] class JsonSerialize { public function __construct(public ?string $fieldName = null) { var_dump(\"JsonSerialize:$fieldName\"); } } class VersionedObject { #[JsonSerialize('json-foobar')] protected string $myValue = ''; } $object = new VersionedObject(); $reflection = new ReflectionObject($object); foreach ($reflection-\u003egetProperties() as $reflectionProp) { foreach ($reflectionProp-\u003egetAttributes(JsonSerialize::class) as $jsonSerializeAttr) { var_dump($jsonSerializeAttr-\u003egetName()); var_dump($jsonSerializeAttr-\u003egetArguments()); var_dump($jsonSerializeAttr-\u003egetTarget()); var_dump($jsonSerializeAttr-\u003eisRepeated()); var_dump($jsonSerializeAttr-\u003enewInstance()); } } // string(13) \"JsonSerialize\" // // array(1) { // [0]=\u003e // string(11) \"json-foobar\" // } // // int(8) Attribute::TARGET_PROPERTY // // bool(false) // // string(25) \"JsonSerialize:json-foobar\" // object(JsonSerialize)#5 (1) { // [\"fieldName\"]=\u003e // string(11) \"json-foobar\" // } // 构造器属性提升 Constructor Property Promotion // 当构造器参数带访问控制（visibility modifier）时，PHP 会同时把它当作对象属性和构造器参数，并赋值到属性 class Point { public function __construct(protected int $x, protected int $y = 0) {} } var_dump(new Point(2,4)); // object(Point)#1 (2) { // [\"x\":protected]=\u003e // int(2) // [\"y\":protected]=\u003e // int(4) // } class Point2 { protected int $x; protected int $y; public function __construct(protected int $x, protected int $y = 0) {} } // 此类中已经定义了具有相同名称的字段 // Fatal error: Cannot redeclare Point::$x // Union types 联合类型 // ?T is same T|null // // - 类型只能出现一次 int|string|INT 否则报错 // - 使用 mixed 会报错 // - bool 与 false or true 不能混用 // - object 与 class 不能混用 // - iterable 与 array Traversable 不能混用 // - 使用 self、parent 或 static 都会导致错误 public function parse_value(string|int|float): string|null {} // match 表达式 // https://www.php.net/manual/en/control-structures.match.php // match 表达式必须是详尽，则会抛出 UnhandledMatchError。 echo match (8.0) { '8.0' =\u003e \"Oh no!\", 8.0 =\u003e \"This matches\", }; // This matches // Nullsafe Operator $result = $repository?-\u003egetUser(5)?-\u003ename; // Is equivalent to the following code block: if (is_null($repository)) { $result = null; } else { $user = $repository-\u003egetUser(5); if (is_null($user)) { $result = null; } else { $result = $user-\u003ename; } } // Argument Unpacking echo str_replace(...[ 'replace' =\u003e 'Iron Man', 'search' =\u003e 'Inevitable', 'subject' =\u003e 'I am Inevitable', ]); // Named Parameters with Variadic Parameters function test($a, $b, ...$args) { var_dump($args); } test(28, 15, june: 6, september: 15, january: \"01\"); // array(3) { // [\"june\"]=\u003e int(6) // [\"september\"]=\u003e int(15) // [\"january\"]=\u003e string(2) \"01\" // } // JIT Just-In-Time Compilation // php -i | grep -i opcache // php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing -i | grep -i jit // opcache.enable=1 // opcache.enable_cli=1 // opcache.jit_buffer_size=256M \u003c?php function fibonacci($n) { if ($n \u003c 2) return $n; return fibonacci($n - 1) + fibonacci($n - 2); } $start = microtime(true); fibonacci(42); $end = microtime(true); echo \"Time taken: \" . ($end - $start) . \" seconds\\n\"; // php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing test.php // The WeakMap class has been added, accepts objects as keys, similar SplObjectStorage // https://www.php.net/manual/en/class.weakmap.php // https://www.php.net/manual/en/class.splobjectstorage.php // final class WeakMap implements ArrayAccess, Countable, IteratorAggregate $wm = new WeakMap(); $o = new StdClass; class A { public function __destruct() { echo \"Dead!\\n\"; } } $wm[$o] = new A; var_dump(count($wm)); // int(1) unset($o); // Dead! // 销毁 var_dump(count($wm)); // int(0) // 对比 SplObjectStorage $wm = new SplObjectStorage(); $o = new StdClass; class A { public function __destruct() { echo \"Dead!\\n\"; } } $wm[$o] = new A; var_dump(count($wm)); // int(1) unset($o); // 未销毁 var_dump(count($wm)); // int(1) // 只要类型兼容，现在可以将任意数量的函数参数替换为可变参数 variadic argument class A { public function method(int $many, string $parameters, $here) {} } class B extends A { public function method(...$everything) {} } // OK class C extends A { public function method(int ...$everything) {} } // Fatal error: Declaration of C::method(int ...$everything) // static 后期静态绑定，现在可以用作返回类型 class Test { public function create(): static { return new static(); } } // get_class($obj) === $obj::class class Test {} $obj = new Test; var_dump($obj::class); var_dump(get_class($obj)); // new instanceof 可以与任意表达式一起使用 // new (expression)(...$args) // $obj instanceof (expression) class A{}; class B{}; new (1\u003e2 ? \"A\" : \"B\")(); // 新增 Stringable 接口。如果 class 定义了 __toString()，则自动实现了此接口 // Traits can define abstract private methods trait T { abstract private function a(); } // Throw 可以作为一个表达式 as an expression $value = $config['path'] ?? throw new InvalidArgumentException('path required'); $fn = fn() =\u003e throw new Exception('Exception in arrow function'); // 参数列表中现在允许使用可选的尾随逗号 function functionWithLongSignature( Type1 $parameter1, Type2 $parameter2, // \u003c-- This comma is now allowed. ) {} // 允许 catch (Exception) 无需存储到变量 try {} catch (Exception) {} // 在父类上声明的私有方法不再对子类的方法强制执行任何继承规则（私有构造函数除外） class ParentClass { private function method1() {} private function method2() {} private static function method3() {} } abstract class ChildClass extends ParentClass { public abstract function method1(); public static function method2() {} public function method3() {} } // OK // New string functions str_contains('Foobar', 'Foo'); // true str_starts_with('PHP 8', 'PHP'); // true str_ends_with('Version8', '8'); // true Backward Incompatible Changes 8.0 // 字符串与数字比较 // 0 == \"not-a-number\" is false // 将数字转换为字符串，并使用字符串比较 var_dump(0 == \"foo\"); var_dump(42 == \"42foo\"); var_dump(0 == \"\"); // PHP80 PHP74 // bool(false) true // bool(false) true // bool(false) true var_dump(\"\" \u003c 0); var_dump(\"\" \u003c -1); var_dump(\"a\" \u003c 0); var_dump(\"b\" \u003c -1); var_dump(\"ab\" \u003e 0); // PHP80 PHP74 // bool(true) false // bool(true) false // bool(false) false // bool(false) false // bool(true) false // is_callable() 在检查具有 classname 的 non-static 方法时将 false（必须检查对象实例） class Test { public function method1() {} } var_dump(is_callable([Test::class, 'method1'])); var_dump(is_callable([new Test, 'method1'])); // PHP80 PHP74 // bool(false) true // bool(true) true // __autoload() function has been removed // 删除了对 object 使用 array_key_exists() 的能力。isset() or property_exists() may be used instead // isset($arr['key']) → false（当值为 null）- 只能在 null 安全时检查，无法区分 null 与 不存在 // array_key_exists('key', $arr) → true（即使值为 null）- 可以区分存在但值为 null 的情况 – EOF –\n","wordCount":"942","inLanguage":"en","image":"https://images.unsplash.com/photo-1516915616915-048be9a5209d?q=80\u0026w=960\u0026auto=format\u0026fit=crop\u0026ixlib=rb-4.0.3","datePublished":"2022-12-14T16:40:03+08:00","dateModified":"2022-12-14T16:40:03+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zyf.im/2022/12/14/php-migrating-74-to-80/"},"publisher":{"@type":"Organization","name":"ZYF.IM BLOG","logo":{"@type":"ImageObject","url":"https://zyf.im/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zyf.im/ accesskey=h title="ZYF.IM (Alt + H)"><img src=https://zyf.im/apple-touch-icon.png alt aria-label=logo height=35>ZYF.IM</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zyf.im/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://zyf.im/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zyf.im/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://zyf.im/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zyf.im/>Home</a>&nbsp;»&nbsp;<a href=https://zyf.im/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">PHP Migrating 7.4 to 8.0</h1><div class=post-meta><span title='2022-12-14 16:40:03 +0800 CST'>December 14, 2022</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;942 words&nbsp;·&nbsp;Me</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#new-features-80>New Features 8.0</a></li><li><a href=#backward-incompatible-changes-80>Backward Incompatible Changes 8.0</a></li></ul></nav></div></details></div><div class=post-content><ul><li>实验环境：<a href=https://onlinephp.io/>https://onlinephp.io/</a></li><li><a href=https://www.php.net/releases/8.0/en.php>https://www.php.net/releases/8.0/en.php</a></li><li><a href=https://www.php.net/manual/en/migration80.php>https://www.php.net/manual/en/migration80.php</a></li><li><a href=https://php.watch/versions/8.0>https://php.watch/versions/8.0</a></li><li><a href=https://github.com/symfony/polyfill/tree/1.x/src/Php80>https://github.com/symfony/polyfill/tree/1.x/src/Php80</a></li></ul><blockquote><p>PHP 8.0 contains many new features and optimizations including named arguments, union types, attributes, constructor property promotion, match expression, nullsafe operator, JIT, and improvements in the type system, error handling, and consistency.</p></blockquote><h2 id=new-features-80>New Features 8.0<a hidden class=anchor aria-hidden=true href=#new-features-80>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Named Parameters 命名参数
</span></span></span><span class=line><span class=cl><span class=c1>// https://www.php.net/manual/zh/functions.arguments.php#functions.named-arguments
</span></span></span><span class=line><span class=cl><span class=c1>// array_fill(int $start_index, int $count, mixed $value): array
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>var_dump</span><span class=p>(</span><span class=nx>array_fill</span><span class=p>(</span><span class=nx>value</span><span class=o>:</span> <span class=mi>50</span><span class=p>,</span> <span class=nx>count</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>start_index</span><span class=o>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>// PHP80 [50, 50, 50]
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 注解（Attributes）
</span></span></span><span class=line><span class=cl><span class=c1>// https://www.php.net/manual/zh/language.attributes.php
</span></span></span><span class=line><span class=cl><span class=c1>// 定义注解 -&gt; 使用注解 -&gt; （通过反射）提取注释
</span></span></span><span class=line><span class=cl><span class=c1>// 注意以后用词：Attributes 注解，Properties 属性
</span></span></span><span class=line><span class=cl><span class=c1>#[\Attribute]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>JsonSerialize</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=k>public</span> <span class=o>?</span><span class=nx>string</span> <span class=nv>$fieldName</span> <span class=o>=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>var_dump</span><span class=p>(</span><span class=s2>&#34;JsonSerialize:</span><span class=si>$fieldName</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VersionedObject</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>#[JsonSerialize(&#39;json-foobar&#39;)]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>protected</span> <span class=nx>string</span> <span class=nv>$myValue</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$object</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VersionedObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$reflection</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ReflectionObject</span><span class=p>(</span><span class=nv>$object</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$reflection</span><span class=o>-&gt;</span><span class=na>getProperties</span><span class=p>()</span> <span class=k>as</span> <span class=nv>$reflectionProp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$reflectionProp</span><span class=o>-&gt;</span><span class=na>getAttributes</span><span class=p>(</span><span class=nx>JsonSerialize</span><span class=o>::</span><span class=na>class</span><span class=p>)</span> <span class=k>as</span> <span class=nv>$jsonSerializeAttr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$jsonSerializeAttr</span><span class=o>-&gt;</span><span class=na>getName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$jsonSerializeAttr</span><span class=o>-&gt;</span><span class=na>getArguments</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$jsonSerializeAttr</span><span class=o>-&gt;</span><span class=na>getTarget</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$jsonSerializeAttr</span><span class=o>-&gt;</span><span class=na>isRepeated</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$jsonSerializeAttr</span><span class=o>-&gt;</span><span class=na>newInstance</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// string(13) &#34;JsonSerialize&#34;
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// array(1) {
</span></span></span><span class=line><span class=cl><span class=c1>//   [0]=&gt;
</span></span></span><span class=line><span class=cl><span class=c1>//   string(11) &#34;json-foobar&#34;
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// int(8) Attribute::TARGET_PROPERTY
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// bool(false)
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// string(25) &#34;JsonSerialize:json-foobar&#34;
</span></span></span><span class=line><span class=cl><span class=c1>// object(JsonSerialize)#5 (1) {
</span></span></span><span class=line><span class=cl><span class=c1>//   [&#34;fieldName&#34;]=&gt;
</span></span></span><span class=line><span class=cl><span class=c1>//   string(11) &#34;json-foobar&#34;
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 构造器属性提升 Constructor Property Promotion
</span></span></span><span class=line><span class=cl><span class=c1>// 当构造器参数带访问控制（visibility modifier）时，PHP 会同时把它当作对象属性和构造器参数，并赋值到属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Point</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=k>protected</span> <span class=nx>int</span> <span class=nv>$x</span><span class=p>,</span> <span class=k>protected</span> <span class=nx>int</span> <span class=nv>$y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=k>new</span> <span class=nx>Point</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>// object(Point)#1 (2) {
</span></span></span><span class=line><span class=cl><span class=c1>//   [&#34;x&#34;:protected]=&gt;
</span></span></span><span class=line><span class=cl><span class=c1>//   int(2)
</span></span></span><span class=line><span class=cl><span class=c1>//   [&#34;y&#34;:protected]=&gt;
</span></span></span><span class=line><span class=cl><span class=c1>//   int(4)
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Point2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=nx>int</span> <span class=nv>$x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>protected</span> <span class=nx>int</span> <span class=nv>$y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=k>protected</span> <span class=nx>int</span> <span class=nv>$x</span><span class=p>,</span> <span class=k>protected</span> <span class=nx>int</span> <span class=nv>$y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 此类中已经定义了具有相同名称的字段
</span></span></span><span class=line><span class=cl><span class=c1>// Fatal error: Cannot redeclare Point::$x
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Union types 联合类型
</span></span></span><span class=line><span class=cl><span class=c1>// ?T is same T|null
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// - 类型只能出现一次 int|string|INT 否则报错
</span></span></span><span class=line><span class=cl><span class=c1>// - 使用 mixed 会报错
</span></span></span><span class=line><span class=cl><span class=c1>// - bool 与 false or true 不能混用
</span></span></span><span class=line><span class=cl><span class=c1>// - object 与 class 不能混用
</span></span></span><span class=line><span class=cl><span class=c1>// - iterable 与 array Traversable 不能混用
</span></span></span><span class=line><span class=cl><span class=c1>// - 使用 self、parent 或 static 都会导致错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>function</span> <span class=nf>parse_value</span><span class=p>(</span><span class=nx>string</span><span class=o>|</span><span class=nx>int</span><span class=o>|</span><span class=nx>float</span><span class=p>)</span><span class=o>:</span> <span class=nx>string</span><span class=o>|</span><span class=k>null</span> <span class=p>{}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// match 表达式
</span></span></span><span class=line><span class=cl><span class=c1>// https://www.php.net/manual/en/control-structures.match.php
</span></span></span><span class=line><span class=cl><span class=c1>// match 表达式必须是详尽，则会抛出 UnhandledMatchError。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=nx>match</span> <span class=p>(</span><span class=mf>8.0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;8.0&#39;</span> <span class=o>=&gt;</span> <span class=s2>&#34;Oh no!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mf>8.0</span> <span class=o>=&gt;</span> <span class=s2>&#34;This matches&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1>// This matches
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Nullsafe Operator
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$result</span> <span class=o>=</span> <span class=nv>$repository</span><span class=o>?-&gt;</span><span class=na>getUser</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span><span class=o>?-&gt;</span><span class=na>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// Is equivalent to the following code block:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nx>is_null</span><span class=p>(</span><span class=nv>$repository</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$result</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$user</span> <span class=o>=</span> <span class=nv>$repository</span><span class=o>-&gt;</span><span class=na>getUser</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>is_null</span><span class=p>(</span><span class=nv>$user</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$result</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$result</span> <span class=o>=</span> <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Argument Unpacking
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=nx>str_replace</span><span class=p>(</span><span class=o>...</span><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;replace&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Iron Man&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;search&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Inevitable&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;subject&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;I am Inevitable&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Named Parameters with Variadic Parameters
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>test</span><span class=p>(</span><span class=nv>$a</span><span class=p>,</span> <span class=nv>$b</span><span class=p>,</span> <span class=o>...</span><span class=nv>$args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$args</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>test</span><span class=p>(</span><span class=mi>28</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=nx>june</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>september</span><span class=o>:</span> <span class=mi>15</span><span class=p>,</span> <span class=nx>january</span><span class=o>:</span> <span class=s2>&#34;01&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// array(3) {
</span></span></span><span class=line><span class=cl><span class=c1>//     [&#34;june&#34;]=&gt; int(6)
</span></span></span><span class=line><span class=cl><span class=c1>//     [&#34;september&#34;]=&gt; int(15)
</span></span></span><span class=line><span class=cl><span class=c1>//     [&#34;january&#34;]=&gt; string(2) &#34;01&#34;
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// JIT Just-In-Time Compilation
</span></span></span><span class=line><span class=cl><span class=c1>// php -i | grep -i opcache
</span></span></span><span class=line><span class=cl><span class=c1>// php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing -i | grep -i jit
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// opcache.enable=1
</span></span></span><span class=line><span class=cl><span class=c1>// opcache.enable_cli=1
</span></span></span><span class=line><span class=cl><span class=c1>// opcache.jit_buffer_size=256M
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>fibonacci</span><span class=p>(</span><span class=nv>$n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$n</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=k>return</span> <span class=nv>$n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fibonacci</span><span class=p>(</span><span class=nv>$n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=nx>fibonacci</span><span class=p>(</span><span class=nv>$n</span> <span class=o>-</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$start</span> <span class=o>=</span> <span class=nx>microtime</span><span class=p>(</span><span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fibonacci</span><span class=p>(</span><span class=mi>42</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$end</span> <span class=o>=</span> <span class=nx>microtime</span><span class=p>(</span><span class=k>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;Time taken: &#34;</span> <span class=o>.</span> <span class=p>(</span><span class=nv>$end</span> <span class=o>-</span> <span class=nv>$start</span><span class=p>)</span> <span class=o>.</span> <span class=s2>&#34; seconds</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// php -d opcache.enable_cli=1 -d opcache.jit_buffer_size=256M -d opcache.jit=tracing test.php
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// The WeakMap class has been added, accepts objects as keys, similar SplObjectStorage
</span></span></span><span class=line><span class=cl><span class=c1>// https://www.php.net/manual/en/class.weakmap.php
</span></span></span><span class=line><span class=cl><span class=c1>// https://www.php.net/manual/en/class.splobjectstorage.php
</span></span></span><span class=line><span class=cl><span class=c1>// final class WeakMap implements ArrayAccess, Countable, IteratorAggregate
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$wm</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakMap</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$o</span> <span class=o>=</span> <span class=k>new</span> <span class=k>StdClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;Dead!</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$wm</span><span class=p>[</span><span class=nv>$o</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>A</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$wm</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>// int(1)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>unset</span><span class=p>(</span><span class=nv>$o</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Dead!
</span></span></span><span class=line><span class=cl><span class=c1>// 销毁
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>var_dump</span><span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$wm</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>// int(0)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 对比 SplObjectStorage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$wm</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SplObjectStorage</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$o</span> <span class=o>=</span> <span class=k>new</span> <span class=k>StdClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__destruct</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;Dead!</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$wm</span><span class=p>[</span><span class=nv>$o</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>A</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$wm</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>// int(1)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>unset</span><span class=p>(</span><span class=nv>$o</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 未销毁
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>var_dump</span><span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$wm</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=c1>// int(1)
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 只要类型兼容，现在可以将任意数量的函数参数替换为可变参数 variadic argument
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>A</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>method</span><span class=p>(</span><span class=nx>int</span> <span class=nv>$many</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$parameters</span><span class=p>,</span> <span class=nv>$here</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>B</span> <span class=k>extends</span> <span class=nx>A</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>method</span><span class=p>(</span><span class=o>...</span><span class=nv>$everything</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// OK
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>C</span> <span class=k>extends</span> <span class=nx>A</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>method</span><span class=p>(</span><span class=nx>int</span> <span class=o>...</span><span class=nv>$everything</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Fatal error: Declaration of C::method(int ...$everything)
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// static 后期静态绑定，现在可以用作返回类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>create</span><span class=p>()</span><span class=o>:</span> <span class=k>static</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=k>static</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// get_class($obj) === $obj::class
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Test</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nv>$obj</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Test</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nv>$obj</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>get_class</span><span class=p>(</span><span class=nv>$obj</span><span class=p>));</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// new instanceof 可以与任意表达式一起使用
</span></span></span><span class=line><span class=cl><span class=c1>// new (expression)(...$args)
</span></span></span><span class=line><span class=cl><span class=c1>// $obj instanceof (expression)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>A</span><span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>B</span><span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=k>new</span> <span class=p>(</span><span class=mi>1</span><span class=o>&gt;</span><span class=mi>2</span> <span class=o>?</span> <span class=s2>&#34;A&#34;</span> <span class=o>:</span> <span class=s2>&#34;B&#34;</span><span class=p>)();</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 新增 Stringable 接口。如果 class 定义了 __toString()，则自动实现了此接口
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Traits can define abstract private methods
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>trait</span> <span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>abstract</span> <span class=k>private</span> <span class=k>function</span> <span class=nf>a</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// Throw 可以作为一个表达式 as an expression
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$value</span> <span class=o>=</span> <span class=nv>$config</span><span class=p>[</span><span class=s1>&#39;path&#39;</span><span class=p>]</span> <span class=o>??</span> <span class=k>throw</span> <span class=k>new</span> <span class=nx>InvalidArgumentException</span><span class=p>(</span><span class=s1>&#39;path required&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$fn</span> <span class=o>=</span> <span class=nx>fn</span><span class=p>()</span> <span class=o>=&gt;</span> <span class=k>throw</span> <span class=k>new</span> <span class=nx>Exception</span><span class=p>(</span><span class=s1>&#39;Exception in arrow function&#39;</span><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 参数列表中现在允许使用可选的尾随逗号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>functionWithLongSignature</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>Type1</span> <span class=nv>$parameter1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Type2</span> <span class=nv>$parameter2</span><span class=p>,</span> <span class=c1>// &lt;-- This comma is now allowed.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span> <span class=p>{}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 允许 catch (Exception) 无需存储到变量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>try</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=k>catch</span> <span class=p>(</span><span class=nx>Exception</span><span class=p>)</span> <span class=p>{}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 在父类上声明的私有方法不再对子类的方法强制执行任何继承规则（私有构造函数除外）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>ParentClass</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>method1</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>method2</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>method3</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>abstract</span> <span class=k>class</span> <span class=nc>ChildClass</span> <span class=k>extends</span> <span class=nx>ParentClass</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>abstract</span> <span class=k>function</span> <span class=nf>method1</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>method2</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>method3</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// OK
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// New string functions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>str_contains</span><span class=p>(</span><span class=s1>&#39;Foobar&#39;</span><span class=p>,</span> <span class=s1>&#39;Foo&#39;</span><span class=p>);</span> <span class=c1>// true
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>str_starts_with</span><span class=p>(</span><span class=s1>&#39;PHP 8&#39;</span><span class=p>,</span> <span class=s1>&#39;PHP&#39;</span><span class=p>);</span> <span class=c1>// true
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>str_ends_with</span><span class=p>(</span><span class=s1>&#39;Version8&#39;</span><span class=p>,</span> <span class=s1>&#39;8&#39;</span><span class=p>);</span> <span class=c1>// true
</span></span></span></code></pre></div><h2 id=backward-incompatible-changes-80>Backward Incompatible Changes 8.0<a hidden class=anchor aria-hidden=true href=#backward-incompatible-changes-80>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 字符串与数字比较
</span></span></span><span class=line><span class=cl><span class=c1>// 0 == &#34;not-a-number&#34; is false
</span></span></span><span class=line><span class=cl><span class=c1>// 将数字转换为字符串，并使用字符串比较
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>var_dump</span><span class=p>(</span><span class=mi>0</span> <span class=o>==</span> <span class=s2>&#34;foo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=mi>42</span> <span class=o>==</span> <span class=s2>&#34;42foo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=mi>0</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// PHP80           PHP74
</span></span></span><span class=line><span class=cl><span class=c1>// bool(false)     true
</span></span></span><span class=line><span class=cl><span class=c1>// bool(false)     true
</span></span></span><span class=line><span class=cl><span class=c1>// bool(false)     true
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=s2>&#34;&#34;</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=s2>&#34;&#34;</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=s2>&#34;a&#34;</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=s2>&#34;b&#34;</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=s2>&#34;ab&#34;</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// PHP80           PHP74
</span></span></span><span class=line><span class=cl><span class=c1>// bool(true)      false
</span></span></span><span class=line><span class=cl><span class=c1>// bool(true)      false
</span></span></span><span class=line><span class=cl><span class=c1>// bool(false)     false
</span></span></span><span class=line><span class=cl><span class=c1>// bool(false)     false
</span></span></span><span class=line><span class=cl><span class=c1>// bool(true)      false
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// is_callable() 在检查具有 classname 的 non-static 方法时将 false（必须检查对象实例）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>method1</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>is_callable</span><span class=p>([</span><span class=nx>Test</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=s1>&#39;method1&#39;</span><span class=p>]));</span>
</span></span><span class=line><span class=cl><span class=nx>var_dump</span><span class=p>(</span><span class=nx>is_callable</span><span class=p>([</span><span class=k>new</span> <span class=nx>Test</span><span class=p>,</span> <span class=s1>&#39;method1&#39;</span><span class=p>]));</span>
</span></span><span class=line><span class=cl><span class=c1>// PHP80           PHP74
</span></span></span><span class=line><span class=cl><span class=c1>// bool(false)     true
</span></span></span><span class=line><span class=cl><span class=c1>// bool(true)      true
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// __autoload() function has been removed
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// 删除了对 object 使用 array_key_exists() 的能力。isset() or property_exists() may be used instead
</span></span></span><span class=line><span class=cl><span class=c1>// isset($arr[&#39;key&#39;]) → false（当值为 null）- 只能在 null 安全时检查，无法区分 null 与 不存在
</span></span></span><span class=line><span class=cl><span class=c1>// array_key_exists(&#39;key&#39;, $arr) → true（即使值为 null）- 可以区分存在但值为 null 的情况
</span></span></span></code></pre></div><p>&ndash; EOF &ndash;</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zyf.im/tags/php/>Php</a></li></ul><nav class=paginav><a class=prev href=https://zyf.im/2022/12/21/php-migrating-80-to-81/><span class=title>« Prev</span><br><span>PHP Migrating 8.0 to 8.1</span>
</a><a class=next href=https://zyf.im/2022/12/12/php-migrating-to-72-73-74/><span class=title>Next »</span><br><span>PHP Migrating to 7.2 7.3 7.4</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://zyf.im/>ZYF.IM BLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>