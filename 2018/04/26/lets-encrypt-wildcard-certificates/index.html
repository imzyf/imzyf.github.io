<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用 Certbot 获取 Let’s Encrypt 颁发的 TLS 证书 | ZYF.IM BLOG</title><meta name=keywords content="nginx"><meta name=description content="Certbot 和 Let’s Encrypt 的关系
Let&rsquo;s Encrypt

一个免费、自动化、开放的公共证书颁发机构（CA）。
通过 ACME（Automatic Certificate Management Environment）协议向域名所有者颁发 DV（Domain Validation）TLS/SSL 证书。

Certbot

由 Electronic Frontier Foundation (EFF) 维护的开源 ACME 客户端。
主要目标是简化与 Let&rsquo;s Encrypt 之间的交互：

自动化域名验证（HTTP-01、DNS-01、TLS-ALPN-01 等）
安装并续期证书
更新 Web 服务器配置（Apache、Nginx、Lighttpd 等）


Certbot 也能与任何兼容 ACME 的 CA 通信，不限于 Let&rsquo;s Encrypt。

典型工作流程

解析参数并检测服务器类型。
选择并执行挑战（例如在 /.well-known/acme-challenge/ 下写入 token）。
Let’s Encrypt 回访验证域名归属。
验证通过后签发证书；Certbot 下载并安装到本地。
创建定时任务 certbot renew 自动续期。

开始实验

实验环境：Amazon Linux 2023 (AL2023)
知识补充

dnf（Dandified YUM） 是 RPM-系 Linux 发行版的下一代包管理器。它在功能上取代了传统的 yum，两者命令参数几乎保持兼容。
RPM 一开始叫 Red Hat Package Manager，后来改名为递归含义的 RPM Package Manager。
RPM-系发行版 是把 RPM 作为原生软件包格式与核心包管理工具链的那一族 Linux 发行版。常听到的 Fedora / RHEL / CentOS / AlmaLinux / Rocky Linux / openSUSE / SUSE Linux Enterprise / Amazon Linux 2023 等。
dnf 不是对 rpm CLI 的简单封装，而是调用 librpm 完成最终操作。


  
      
          包管理器
          代表发行版
          归属
      
  
  
      
          dnf / yum
          Fedora, RHEL, CentOS
          RPM
      
      
          zypper
          openSUSE, SLE
          RPM
      
      
          apt / apt-get
          Debian, Ubuntu
          DEB
      
      
          pacman
          Arch Linux
          tar.xz
      
      
          apk
          Alpine
          .apk
      
  


snap 是一种由 Canonical（Ubuntu 的开发公司）推出的跨发行版应用打包和分发格式，也指围绕它的一整套生态系统。

跨发行版。同一个 snap 包可以在几十种发行版上直接安装运行，不依赖各自的 RPM/Deb 系统仓库。
自包含（bundled）依赖。snap 包内部包含所有依赖，无需外部安装。
https://snapcraft.io/



Launch an instance

Instance type: t2.nano
Username: ec2-user
Security Groups: Allow HTTP and HTTPS
Public IPv4: 35.86.90.4

配置 nginx
sudo dnf update -y

sudo dnf install -y nginx
nginx -v
# nginx version: nginx/1.28.0

sudo systemctl start nginx
sudo systemctl enable nginx
systemctl status nginx
# Started nginx.service - The nginx HTTP and reverse proxy server.
直接通过 http://35.86.90.4，会看到默认的 nginx 欢迎页面。"><meta name=author content="Me, LLM"><link rel=canonical href=https://zyf.im/2018/04/26/lets-encrypt-wildcard-certificates/><link crossorigin=anonymous href=/assets/css/stylesheet.63618a0fd0c7dd946ad6f368012c097fc6e5a8464cefd289c140dd28c01ec58d.css integrity="sha256-Y2GKD9DH3ZRq1vNoASwJf8blqEZM79KJwUDdKMAexY0=" rel="preload stylesheet" as=style><link rel=icon href=https://zyf.im/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zyf.im/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zyf.im/favicon-32x32.png><link rel=apple-touch-icon href=https://zyf.im/apple-touch-icon.png><link rel=mask-icon href=https://zyf.im/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zyf.im/2018/04/26/lets-encrypt-wildcard-certificates/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6DVZ6E58DG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6DVZ6E58DG")}</script><meta property="og:url" content="https://zyf.im/2018/04/26/lets-encrypt-wildcard-certificates/"><meta property="og:site_name" content="ZYF.IM BLOG"><meta property="og:title" content="使用 Certbot 获取 Let’s Encrypt 颁发的 TLS 证书"><meta property="og:description" content="Certbot 和 Let’s Encrypt 的关系 Let’s Encrypt 一个免费、自动化、开放的公共证书颁发机构（CA）。 通过 ACME（Automatic Certificate Management Environment）协议向域名所有者颁发 DV（Domain Validation）TLS/SSL 证书。 Certbot 由 Electronic Frontier Foundation (EFF) 维护的开源 ACME 客户端。 主要目标是简化与 Let’s Encrypt 之间的交互： 自动化域名验证（HTTP-01、DNS-01、TLS-ALPN-01 等） 安装并续期证书 更新 Web 服务器配置（Apache、Nginx、Lighttpd 等） Certbot 也能与任何兼容 ACME 的 CA 通信，不限于 Let’s Encrypt。 典型工作流程 解析参数并检测服务器类型。 选择并执行挑战（例如在 /.well-known/acme-challenge/ 下写入 token）。 Let’s Encrypt 回访验证域名归属。 验证通过后签发证书；Certbot 下载并安装到本地。 创建定时任务 certbot renew 自动续期。 开始实验 实验环境：Amazon Linux 2023 (AL2023)
知识补充 dnf（Dandified YUM） 是 RPM-系 Linux 发行版的下一代包管理器。它在功能上取代了传统的 yum，两者命令参数几乎保持兼容。 RPM 一开始叫 Red Hat Package Manager，后来改名为递归含义的 RPM Package Manager。 RPM-系发行版 是把 RPM 作为原生软件包格式与核心包管理工具链的那一族 Linux 发行版。常听到的 Fedora / RHEL / CentOS / AlmaLinux / Rocky Linux / openSUSE / SUSE Linux Enterprise / Amazon Linux 2023 等。 dnf 不是对 rpm CLI 的简单封装，而是调用 librpm 完成最终操作。 包管理器 代表发行版 归属 dnf / yum Fedora, RHEL, CentOS RPM zypper openSUSE, SLE RPM apt / apt-get Debian, Ubuntu DEB pacman Arch Linux tar.xz apk Alpine .apk snap 是一种由 Canonical（Ubuntu 的开发公司）推出的跨发行版应用打包和分发格式，也指围绕它的一整套生态系统。 跨发行版。同一个 snap 包可以在几十种发行版上直接安装运行，不依赖各自的 RPM/Deb 系统仓库。 自包含（bundled）依赖。snap 包内部包含所有依赖，无需外部安装。 https://snapcraft.io/ Launch an instance Instance type: t2.nano Username: ec2-user Security Groups: Allow HTTP and HTTPS Public IPv4: 35.86.90.4 配置 nginx sudo dnf update -y sudo dnf install -y nginx nginx -v # nginx version: nginx/1.28.0 sudo systemctl start nginx sudo systemctl enable nginx systemctl status nginx # Started nginx.service - The nginx HTTP and reverse proxy server. 直接通过 http://35.86.90.4，会看到默认的 nginx 欢迎页面。"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-04-26T16:00:00+08:00"><meta property="article:modified_time" content="2018-04-26T16:00:00+08:00"><meta property="article:tag" content="Nginx"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Certbot 获取 Let’s Encrypt 颁发的 TLS 证书"><meta name=twitter:description content="Certbot 和 Let’s Encrypt 的关系
Let&rsquo;s Encrypt

一个免费、自动化、开放的公共证书颁发机构（CA）。
通过 ACME（Automatic Certificate Management Environment）协议向域名所有者颁发 DV（Domain Validation）TLS/SSL 证书。

Certbot

由 Electronic Frontier Foundation (EFF) 维护的开源 ACME 客户端。
主要目标是简化与 Let&rsquo;s Encrypt 之间的交互：

自动化域名验证（HTTP-01、DNS-01、TLS-ALPN-01 等）
安装并续期证书
更新 Web 服务器配置（Apache、Nginx、Lighttpd 等）


Certbot 也能与任何兼容 ACME 的 CA 通信，不限于 Let&rsquo;s Encrypt。

典型工作流程

解析参数并检测服务器类型。
选择并执行挑战（例如在 /.well-known/acme-challenge/ 下写入 token）。
Let’s Encrypt 回访验证域名归属。
验证通过后签发证书；Certbot 下载并安装到本地。
创建定时任务 certbot renew 自动续期。

开始实验

实验环境：Amazon Linux 2023 (AL2023)
知识补充

dnf（Dandified YUM） 是 RPM-系 Linux 发行版的下一代包管理器。它在功能上取代了传统的 yum，两者命令参数几乎保持兼容。
RPM 一开始叫 Red Hat Package Manager，后来改名为递归含义的 RPM Package Manager。
RPM-系发行版 是把 RPM 作为原生软件包格式与核心包管理工具链的那一族 Linux 发行版。常听到的 Fedora / RHEL / CentOS / AlmaLinux / Rocky Linux / openSUSE / SUSE Linux Enterprise / Amazon Linux 2023 等。
dnf 不是对 rpm CLI 的简单封装，而是调用 librpm 完成最终操作。


  
      
          包管理器
          代表发行版
          归属
      
  
  
      
          dnf / yum
          Fedora, RHEL, CentOS
          RPM
      
      
          zypper
          openSUSE, SLE
          RPM
      
      
          apt / apt-get
          Debian, Ubuntu
          DEB
      
      
          pacman
          Arch Linux
          tar.xz
      
      
          apk
          Alpine
          .apk
      
  


snap 是一种由 Canonical（Ubuntu 的开发公司）推出的跨发行版应用打包和分发格式，也指围绕它的一整套生态系统。

跨发行版。同一个 snap 包可以在几十种发行版上直接安装运行，不依赖各自的 RPM/Deb 系统仓库。
自包含（bundled）依赖。snap 包内部包含所有依赖，无需外部安装。
https://snapcraft.io/



Launch an instance

Instance type: t2.nano
Username: ec2-user
Security Groups: Allow HTTP and HTTPS
Public IPv4: 35.86.90.4

配置 nginx
sudo dnf update -y

sudo dnf install -y nginx
nginx -v
# nginx version: nginx/1.28.0

sudo systemctl start nginx
sudo systemctl enable nginx
systemctl status nginx
# Started nginx.service - The nginx HTTP and reverse proxy server.
直接通过 http://35.86.90.4，会看到默认的 nginx 欢迎页面。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zyf.im/posts/"},{"@type":"ListItem","position":2,"name":"使用 Certbot 获取 Let’s Encrypt 颁发的 TLS 证书","item":"https://zyf.im/2018/04/26/lets-encrypt-wildcard-certificates/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 Certbot 获取 Let’s Encrypt 颁发的 TLS 证书","name":"使用 Certbot 获取 Let’s Encrypt 颁发的 TLS 证书","description":"Certbot 和 Let’s Encrypt 的关系 Let\u0026rsquo;s Encrypt 一个免费、自动化、开放的公共证书颁发机构（CA）。 通过 ACME（Automatic Certificate Management Environment）协议向域名所有者颁发 DV（Domain Validation）TLS/SSL 证书。 Certbot 由 Electronic Frontier Foundation (EFF) 维护的开源 ACME 客户端。 主要目标是简化与 Let\u0026rsquo;s Encrypt 之间的交互： 自动化域名验证（HTTP-01、DNS-01、TLS-ALPN-01 等） 安装并续期证书 更新 Web 服务器配置（Apache、Nginx、Lighttpd 等） Certbot 也能与任何兼容 ACME 的 CA 通信，不限于 Let\u0026rsquo;s Encrypt。 典型工作流程 解析参数并检测服务器类型。 选择并执行挑战（例如在 /.well-known/acme-challenge/ 下写入 token）。 Let’s Encrypt 回访验证域名归属。 验证通过后签发证书；Certbot 下载并安装到本地。 创建定时任务 certbot renew 自动续期。 开始实验 实验环境：Amazon Linux 2023 (AL2023)\n知识补充 dnf（Dandified YUM） 是 RPM-系 Linux 发行版的下一代包管理器。它在功能上取代了传统的 yum，两者命令参数几乎保持兼容。 RPM 一开始叫 Red Hat Package Manager，后来改名为递归含义的 RPM Package Manager。 RPM-系发行版 是把 RPM 作为原生软件包格式与核心包管理工具链的那一族 Linux 发行版。常听到的 Fedora / RHEL / CentOS / AlmaLinux / Rocky Linux / openSUSE / SUSE Linux Enterprise / Amazon Linux 2023 等。 dnf 不是对 rpm CLI 的简单封装，而是调用 librpm 完成最终操作。 包管理器 代表发行版 归属 dnf / yum Fedora, RHEL, CentOS RPM zypper openSUSE, SLE RPM apt / apt-get Debian, Ubuntu DEB pacman Arch Linux tar.xz apk Alpine .apk snap 是一种由 Canonical（Ubuntu 的开发公司）推出的跨发行版应用打包和分发格式，也指围绕它的一整套生态系统。 跨发行版。同一个 snap 包可以在几十种发行版上直接安装运行，不依赖各自的 RPM/Deb 系统仓库。 自包含（bundled）依赖。snap 包内部包含所有依赖，无需外部安装。 https://snapcraft.io/ Launch an instance Instance type: t2.nano Username: ec2-user Security Groups: Allow HTTP and HTTPS Public IPv4: 35.86.90.4 配置 nginx sudo dnf update -y sudo dnf install -y nginx nginx -v # nginx version: nginx/1.28.0 sudo systemctl start nginx sudo systemctl enable nginx systemctl status nginx # Started nginx.service - The nginx HTTP and reverse proxy server. 直接通过 http://35.86.90.4，会看到默认的 nginx 欢迎页面。\n","keywords":["nginx"],"articleBody":"Certbot 和 Let’s Encrypt 的关系 Let’s Encrypt 一个免费、自动化、开放的公共证书颁发机构（CA）。 通过 ACME（Automatic Certificate Management Environment）协议向域名所有者颁发 DV（Domain Validation）TLS/SSL 证书。 Certbot 由 Electronic Frontier Foundation (EFF) 维护的开源 ACME 客户端。 主要目标是简化与 Let’s Encrypt 之间的交互： 自动化域名验证（HTTP-01、DNS-01、TLS-ALPN-01 等） 安装并续期证书 更新 Web 服务器配置（Apache、Nginx、Lighttpd 等） Certbot 也能与任何兼容 ACME 的 CA 通信，不限于 Let’s Encrypt。 典型工作流程 解析参数并检测服务器类型。 选择并执行挑战（例如在 /.well-known/acme-challenge/ 下写入 token）。 Let’s Encrypt 回访验证域名归属。 验证通过后签发证书；Certbot 下载并安装到本地。 创建定时任务 certbot renew 自动续期。 开始实验 实验环境：Amazon Linux 2023 (AL2023)\n知识补充 dnf（Dandified YUM） 是 RPM-系 Linux 发行版的下一代包管理器。它在功能上取代了传统的 yum，两者命令参数几乎保持兼容。 RPM 一开始叫 Red Hat Package Manager，后来改名为递归含义的 RPM Package Manager。 RPM-系发行版 是把 RPM 作为原生软件包格式与核心包管理工具链的那一族 Linux 发行版。常听到的 Fedora / RHEL / CentOS / AlmaLinux / Rocky Linux / openSUSE / SUSE Linux Enterprise / Amazon Linux 2023 等。 dnf 不是对 rpm CLI 的简单封装，而是调用 librpm 完成最终操作。 包管理器 代表发行版 归属 dnf / yum Fedora, RHEL, CentOS RPM zypper openSUSE, SLE RPM apt / apt-get Debian, Ubuntu DEB pacman Arch Linux tar.xz apk Alpine .apk snap 是一种由 Canonical（Ubuntu 的开发公司）推出的跨发行版应用打包和分发格式，也指围绕它的一整套生态系统。 跨发行版。同一个 snap 包可以在几十种发行版上直接安装运行，不依赖各自的 RPM/Deb 系统仓库。 自包含（bundled）依赖。snap 包内部包含所有依赖，无需外部安装。 https://snapcraft.io/ Launch an instance Instance type: t2.nano Username: ec2-user Security Groups: Allow HTTP and HTTPS Public IPv4: 35.86.90.4 配置 nginx sudo dnf update -y sudo dnf install -y nginx nginx -v # nginx version: nginx/1.28.0 sudo systemctl start nginx sudo systemctl enable nginx systemctl status nginx # Started nginx.service - The nginx HTTP and reverse proxy server. 直接通过 http://35.86.90.4，会看到默认的 nginx 欢迎页面。\nsudo vi /etc/nginx/conf.d/default.conf # server { listen 80; listen [::]:80; server_name tmp.yifans.net; root /usr/share/nginx/html; error_page 404 /404.html; location = /404.html { } error_page 500 502 503 504 /50x.html; location = /50x.html { } } sudo nginx -t sudo systemctl reload nginx 将自己的域名（tmp.yifans.net）解析到 35.86.90.4，然后访问 http://tmp.yifans.net 同样看到 nginx 欢迎页面，游览器显示 Not Secure。\n配置 certbot # 暂无官方支持 AL2023 sudo wget -O /etc/yum.repos.d/snapd.repo \\ https://bboozzoo.github.io/snapd-amazon-linux/al2023/snapd.repo sudo dnf install -y snapd sudo systemctl enable --now snapd.socket sudo snap install --classic certbot sudo ln -s /snap/bin/certbot /usr/bin/certbot certbot --version # certbot 4.1.1 # 前置 nginx 配置中要有 server_name tmp.yifans.net; sudo certbot --nginx -d tmp.yifans.net # 全自动完成 访问 http://tmp.yifans.net 会自动跳转 https。\n# 看看被 certbot 自动修改的 nginx 配置 cat /etc/nginx/conf.d/default.conf server { server_name tmp.yifans.net; root /usr/share/nginx/html; error_page 404 /404.html; location = /404.html { } error_page 500 502 503 504 /50x.html; location = /50x.html { } listen [::]:443 ssl ipv6only=on; # managed by Certbot listen 443 ssl; # managed by Certbot ssl_certificate /etc/letsencrypt/live/tmp.yifans.net/fullchain.pem; # managed by Certbot ssl_certificate_key /etc/letsencrypt/live/tmp.yifans.net/privkey.pem; # managed by Certbot include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot } server { if ($host = tmp.yifans.net) { return 301 https://$host$request_uri; } # managed by Certbot listen 80; listen [::]:80; server_name tmp.yifans.net; return 404; # managed by Certbot } # 看看 certbot 预置的参数 # include /etc/letsencrypt/options-ssl-nginx.conf; cat /etc/letsencrypt/options-ssl-nginx.conf # This file contains important security parameters. If you modify this file # manually, Certbot will be unable to automatically provide future security # updates. Instead, Certbot will print and log an error message with a path to # the up-to-date file that you will need to refer to when manually updating # this file. Contents are based on https://ssl-config.mozilla.org ssl_session_cache shared:le_nginx_SSL:10m; # 在内存里创建名为 le_nginx_SSL 的共享会话缓存区域，大小 10 MiB。 # 能加速后续同客户端的 TLS 握手（避免完整密钥交换）。 # 10 MiB 足够保存约 40 000 个会话条目。 ssl_session_timeout 1440m; # 单位是分钟（1440 m = 24 h）。 # 表示缓存的会话条目过期时间；设为一天可在常见浏览器会话周期内复用。 ssl_session_tickets off; # 关闭 TLS Session Tickets。 # 原因：早期实现无法便捷轮换 ticket 加密密钥，导致前向安全受损。 ssl_protocols TLSv1.2 TLSv1.3; # 明确只允许 1.2 / 1.3。 # 关闭已不安全的 SSLv3、TLS 1.0、TLS 1.1。 ssl_prefer_server_ciphers off; # 让客户端来决定从交集里选哪一组加密套件（服务器不强制优先级）。 # 在只开放现代安全套件的前提下，这样做兼容性好且简化维护。 # 如果你想严格控制，可改为 on 并自行调整 ssl_ciphers 顺序。 ssl_ciphers \"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384\"; # 仅保留 GCM / ChaCha20-Poly1305 这一代 AEAD 套件；弃用 CBC、RC4、3DES 等。 # ECDHE-ECDSA（椭圆曲线 DH，证书是 ECDSA） # ECDHE-RSA（证书是 RSA） # DHE-RSA（传统 DH，给极旧设备兜底） ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; `ssl_dhparam` 告诉 Nginx 在使用 DHE（Diffie-Hellman Ephemeral）握手方式时，不用默认的 1024 位弱参数，而改用一份 自定义、更安全的 DH 参数文件。 DHE 是 TLS/SSL 协议中的一种「密钥交换算法」。它的核心作用只有两点： - 让客户端与服务器在 公网信道 上安全地“协商出”一个对称加密用的随机密钥。 - 提供 前向安全（Forward Secrecy）：哪怕以后服务器的长期私钥被泄露，过去抓到的加密数据也无法解密。 # 看看证书 sudo openssl x509 -in /etc/letsencrypt/live/tmp.yifans.net/fullchain.pem -noout -text | grep yifans.net Subject: CN=tmp.yifans.net DNS:tmp.yifans.net 只获取证书 首先需要将 tmp-certonly.yifans.net 解析到 35.86.90.4，为了自动完成 acme challenge。\nsudo vi /etc/nginx/conf.d/certonly.conf server { listen 80; listen [::]:80; server_name tmp-certonly.yifans.net; root /usr/share/nginx/html; error_page 404 /404.html; location = /404.html { } error_page 500 502 503 504 /50x.html; location = /50x.html { } } sudo nginx -t sudo systemctl reload nginx sudo certbot certonly --nginx We recommend selecting either all domains, or all domains in a VirtualHost/server block. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 1: tmp.yifans.net 2: tmp-certonly.yifans.net # 选择 2 Successfully received certificate. Certificate is saved at: /etc/letsencrypt/live/tmp-certonly.yifans.net/fullchain.pem Key is saved at: /etc/letsencrypt/live/tmp-certonly.yifans.net/privkey.pem This certificate expires on 2025-10-01. # /etc/nginx/conf.d/certonly.conf 没有被自动修改，需要手动添加证书 Wildcard Certificate 需要 DNS Credentials。 *.example.com 不覆盖 example.com, hello.goodbye.example.com。 *.goodbye.example.com 可覆盖 hello.goodbye.example.com。 不可以申请 *.*.example.com 只能一个 * asterisk。 可以通过 DNS Plugins 插件申请 Wildcard Certificate，但是我觉得 manual 更简单。\nsudo certbot certonly --manual -d '*.tmp.yifans.net' --preferred-challenges dns Please deploy a DNS TXT record under the name: _acme-challenge.tmp.yifans.net. with the following value: ... # 访问 https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.tmp.yifans.net. 预测试配置结果。 # 如果看到对应的值，按 Enter 继续。 Successfully received certificate. Certificate is saved at: /etc/letsencrypt/live/tmp.yifans.net-0001/fullchain.pem Key is saved at: /etc/letsencrypt/live/tmp.yifans.net-0001/privkey.pem # 看看证书 sudo openssl x509 -in /etc/letsencrypt/live/tmp.yifans.net-0001/fullchain.pem -noout -text | grep yifans.net Subject: CN=*.tmp.yifans.net DNS:*.tmp.yifans.net sudo vi /etc/nginx/conf.d/wildcard.conf server { server_name *.tmp.yifans.net; root /usr/share/nginx/html; error_page 404 /404.html; location = /404.html { } error_page 500 502 503 504 /50x.html; location = /50x.html { } listen 443 ssl; ssl_certificate /etc/letsencrypt/live/tmp.yifans.net-0001/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/tmp.yifans.net-0001/privkey.pem; include /etc/letsencrypt/options-ssl-nginx.conf; ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; } server { listen 80; server_name *.tmp.yifans.net; return 301 https://$host$request_uri; } sudo nginx -t sudo systemctl reload nginx 将 1.tmp.yifans.net 解析到 35.86.90.4，然后访问 https://1.tmp.yifans.net，在 Chrome 的证书信息里可以看到 Common Name (CN) *.tmp.yifans.net。\n证书续期 sudo certbot renew --dry-run References Nginx on Linux (snap) | Certbot – EOF –\n","wordCount":"912","inLanguage":"en","datePublished":"2018-04-26T16:00:00+08:00","dateModified":"2018-04-26T16:00:00+08:00","author":[{"@type":"Person","name":"Me"},{"@type":"Person","name":"LLM"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://zyf.im/2018/04/26/lets-encrypt-wildcard-certificates/"},"publisher":{"@type":"Organization","name":"ZYF.IM BLOG","logo":{"@type":"ImageObject","url":"https://zyf.im/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zyf.im/ accesskey=h title="ZYF.IM (Alt + H)"><img src=https://zyf.im/apple-touch-icon.png alt aria-label=logo height=35>ZYF.IM</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zyf.im/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://zyf.im/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zyf.im/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://zyf.im/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zyf.im/>Home</a>&nbsp;»&nbsp;<a href=https://zyf.im/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">使用 Certbot 获取 Let’s Encrypt 颁发的 TLS 证书</h1><div class=post-meta><span title='2018-04-26 16:00:00 +0800 CST'>April 26, 2018</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;912 words&nbsp;·&nbsp;Me, LLM</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#certbot-和-lets-encrypt-的关系>Certbot 和 Let’s Encrypt 的关系</a><ul><li><a href=#lets-encrypt>Let&rsquo;s Encrypt</a></li><li><a href=#certbot>Certbot</a></li><li><a href=#典型工作流程>典型工作流程</a></li></ul></li><li><a href=#开始实验>开始实验</a><ul><li><a href=#知识补充>知识补充</a></li><li><a href=#launch-an-instance>Launch an instance</a></li><li><a href=#配置-nginx>配置 nginx</a></li><li><a href=#配置-certbot>配置 certbot</a></li><li><a href=#只获取证书>只获取证书</a></li><li><a href=#wildcard-certificate>Wildcard Certificate</a></li><li><a href=#证书续期>证书续期</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=certbot-和-lets-encrypt-的关系>Certbot 和 Let’s Encrypt 的关系<a hidden class=anchor aria-hidden=true href=#certbot-和-lets-encrypt-的关系>#</a></h2><h3 id=lets-encrypt>Let&rsquo;s Encrypt<a hidden class=anchor aria-hidden=true href=#lets-encrypt>#</a></h3><ul><li>一个免费、自动化、开放的公共证书颁发机构（CA）。</li><li>通过 ACME（Automatic Certificate Management Environment）协议向域名所有者颁发 DV（Domain Validation）TLS/SSL 证书。</li></ul><h3 id=certbot>Certbot<a hidden class=anchor aria-hidden=true href=#certbot>#</a></h3><ul><li>由 Electronic Frontier Foundation (EFF) 维护的开源 ACME 客户端。</li><li>主要目标是简化与 Let&rsquo;s Encrypt 之间的交互：<ul><li>自动化域名验证（HTTP-01、DNS-01、TLS-ALPN-01 等）</li><li>安装并续期证书</li><li>更新 Web 服务器配置（Apache、Nginx、Lighttpd 等）</li></ul></li><li>Certbot 也能与任何兼容 ACME 的 CA 通信，不限于 Let&rsquo;s Encrypt。</li></ul><h3 id=典型工作流程>典型工作流程<a hidden class=anchor aria-hidden=true href=#典型工作流程>#</a></h3><ol><li>解析参数并检测服务器类型。</li><li>选择并执行挑战（例如在 /.well-known/acme-challenge/ 下写入 token）。</li><li>Let’s Encrypt 回访验证域名归属。</li><li>验证通过后签发证书；Certbot 下载并安装到本地。</li><li>创建定时任务 certbot renew 自动续期。</li></ol><h2 id=开始实验>开始实验<a hidden class=anchor aria-hidden=true href=#开始实验>#</a></h2><blockquote><p>实验环境：Amazon Linux 2023 (AL2023)</p></blockquote><h3 id=知识补充>知识补充<a hidden class=anchor aria-hidden=true href=#知识补充>#</a></h3><ul><li><code>dnf（Dandified YUM）</code> 是 RPM-系 Linux 发行版的下一代包管理器。它在功能上取代了传统的 <code>yum</code>，两者命令参数几乎保持兼容。</li><li><code>RPM</code> 一开始叫 Red Hat Package Manager，后来改名为递归含义的 RPM Package Manager。</li><li><code>RPM-系发行版</code> 是把 RPM 作为原生软件包格式与核心包管理工具链的那一族 Linux 发行版。常听到的 Fedora / RHEL / CentOS / AlmaLinux / Rocky Linux / openSUSE / SUSE Linux Enterprise / Amazon Linux 2023 等。</li><li><code>dnf</code> 不是对 <code>rpm</code> CLI 的简单封装，而是调用 <code>librpm</code> 完成最终操作。</li></ul><table><thead><tr><th>包管理器</th><th>代表发行版</th><th>归属</th></tr></thead><tbody><tr><td>dnf / yum</td><td>Fedora, RHEL, CentOS</td><td>RPM</td></tr><tr><td>zypper</td><td>openSUSE, SLE</td><td>RPM</td></tr><tr><td>apt / apt-get</td><td>Debian, Ubuntu</td><td>DEB</td></tr><tr><td>pacman</td><td>Arch Linux</td><td>tar.xz</td></tr><tr><td>apk</td><td>Alpine</td><td>.apk</td></tr></tbody></table><ul><li><code>snap</code> 是一种由 Canonical（Ubuntu 的开发公司）推出的跨发行版应用打包和分发格式，也指围绕它的一整套生态系统。<ul><li>跨发行版。同一个 snap 包可以在几十种发行版上直接安装运行，不依赖各自的 RPM/Deb 系统仓库。</li><li>自包含（bundled）依赖。snap 包内部包含所有依赖，无需外部安装。</li><li><a href=https://snapcraft.io/>https://snapcraft.io/</a></li></ul></li></ul><h3 id=launch-an-instance>Launch an instance<a hidden class=anchor aria-hidden=true href=#launch-an-instance>#</a></h3><ul><li>Instance type: t2.nano</li><li>Username: ec2-user</li><li>Security Groups: Allow HTTP and HTTPS</li><li>Public IPv4: 35.86.90.4</li></ul><h3 id=配置-nginx>配置 nginx<a hidden class=anchor aria-hidden=true href=#配置-nginx>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo dnf update -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo dnf install -y nginx
</span></span><span class=line><span class=cl>nginx -v
</span></span><span class=line><span class=cl><span class=c1># nginx version: nginx/1.28.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo systemctl start nginx
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> nginx
</span></span><span class=line><span class=cl>systemctl status nginx
</span></span><span class=line><span class=cl><span class=c1># Started nginx.service - The nginx HTTP and reverse proxy server.</span>
</span></span></code></pre></div><p>直接通过 <a href=http://35.86.90.4>http://35.86.90.4</a>，会看到默认的 nginx 欢迎页面。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/nginx/conf.d/default.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf>#
server {
    listen       80;
    listen       [::]:80;
    server_name  tmp.yifans.net;
    root         /usr/share/nginx/html;

    error_page 404 /404.html;
    location = /404.html {
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    }
}
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nginx -t
</span></span><span class=line><span class=cl>sudo systemctl reload nginx
</span></span></code></pre></div><p>将自己的域名（<code>tmp.yifans.net</code>）解析到 <code>35.86.90.4</code>，然后访问 <a href=http://tmp.yifans.net>http://tmp.yifans.net</a> 同样看到 nginx 欢迎页面，游览器显示 Not Secure。</p><h3 id=配置-certbot>配置 certbot<a hidden class=anchor aria-hidden=true href=#配置-certbot>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 暂无官方支持 AL2023</span>
</span></span><span class=line><span class=cl>sudo wget -O /etc/yum.repos.d/snapd.repo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    https://bboozzoo.github.io/snapd-amazon-linux/al2023/snapd.repo
</span></span><span class=line><span class=cl>sudo dnf install -y snapd
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> --now snapd.socket
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo snap install --classic certbot
</span></span><span class=line><span class=cl>sudo ln -s /snap/bin/certbot /usr/bin/certbot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>certbot --version
</span></span><span class=line><span class=cl><span class=c1># certbot 4.1.1</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 前置 nginx 配置中要有 server_name tmp.yifans.net;</span>
</span></span><span class=line><span class=cl>sudo certbot --nginx -d tmp.yifans.net
</span></span><span class=line><span class=cl><span class=c1># 全自动完成</span>
</span></span></code></pre></div><p>访问 <a href=http://tmp.yifans.net>http://tmp.yifans.net</a> 会自动跳转 https。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 看看被 certbot 自动修改的 nginx 配置</span>
</span></span><span class=line><span class=cl>cat /etc/nginx/conf.d/default.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf>server {
    server_name  tmp.yifans.net;
    root         /usr/share/nginx/html;

    error_page 404 /404.html;
    location = /404.html {
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/tmp.yifans.net/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/tmp.yifans.net/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = tmp.yifans.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen       80;
    listen       [::]:80;
    server_name  tmp.yifans.net;
    return 404; # managed by Certbot
}
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 看看 certbot 预置的参数</span>
</span></span><span class=line><span class=cl><span class=c1># include /etc/letsencrypt/options-ssl-nginx.conf;</span>
</span></span><span class=line><span class=cl>cat /etc/letsencrypt/options-ssl-nginx.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf># This file contains important security parameters. If you modify this file
# manually, Certbot will be unable to automatically provide future security
# updates. Instead, Certbot will print and log an error message with a path to
# the up-to-date file that you will need to refer to when manually updating
# this file. Contents are based on https://ssl-config.mozilla.org

ssl_session_cache shared:le_nginx_SSL:10m;
# 在内存里创建名为 le_nginx_SSL 的共享会话缓存区域，大小 10 MiB。
# 能加速后续同客户端的 TLS 握手（避免完整密钥交换）。
# 10 MiB 足够保存约 40 000 个会话条目。

ssl_session_timeout 1440m;
# 单位是分钟（1440 m = 24 h）。
# 表示缓存的会话条目过期时间；设为一天可在常见浏览器会话周期内复用。

ssl_session_tickets off;
# 关闭 TLS Session Tickets。
# 原因：早期实现无法便捷轮换 ticket 加密密钥，导致前向安全受损。

ssl_protocols TLSv1.2 TLSv1.3;
# 明确只允许 1.2 / 1.3。
# 关闭已不安全的 SSLv3、TLS 1.0、TLS 1.1。

ssl_prefer_server_ciphers off;
# 让客户端来决定从交集里选哪一组加密套件（服务器不强制优先级）。
# 在只开放现代安全套件的前提下，这样做兼容性好且简化维护。
# 如果你想严格控制，可改为 on 并自行调整 ssl_ciphers 顺序。

ssl_ciphers &#34;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384&#34;;
# 仅保留 GCM / ChaCha20-Poly1305 这一代 AEAD 套件；弃用 CBC、RC4、3DES 等。
# ECDHE-ECDSA（椭圆曲线 DH，证书是 ECDSA）
# ECDHE-RSA（证书是 RSA）
# DHE-RSA（传统 DH，给极旧设备兜底）
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>`ssl_dhparam` 告诉 Nginx 在使用 DHE（Diffie-Hellman Ephemeral）握手方式时，不用默认的 1024 位弱参数，而改用一份 自定义、更安全的 DH 参数文件。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>DHE 是 TLS/SSL 协议中的一种「密钥交换算法」。它的核心作用只有两点：
</span></span><span class=line><span class=cl>  - 让客户端与服务器在 公网信道 上安全地“协商出”一个对称加密用的随机密钥。
</span></span><span class=line><span class=cl>  - 提供 前向安全（Forward Secrecy）：哪怕以后服务器的长期私钥被泄露，过去抓到的加密数据也无法解密。
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 看看证书</span>
</span></span><span class=line><span class=cl>sudo openssl x509 -in /etc/letsencrypt/live/tmp.yifans.net/fullchain.pem -noout -text <span class=p>|</span> grep yifans.net
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span><span class=o>=</span>tmp.yifans.net
</span></span><span class=line><span class=cl>                DNS:tmp.yifans.net
</span></span></code></pre></div><h3 id=只获取证书>只获取证书<a hidden class=anchor aria-hidden=true href=#只获取证书>#</a></h3><p>首先需要将 <code>tmp-certonly.yifans.net</code> 解析到 <code>35.86.90.4</code>，为了自动完成 acme challenge。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/nginx/conf.d/certonly.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf>server {
    listen       80;
    listen       [::]:80;
    server_name  tmp-certonly.yifans.net;
    root         /usr/share/nginx/html;

    error_page 404 /404.html;
    location = /404.html {
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    }
}
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nginx -t
</span></span><span class=line><span class=cl>sudo systemctl reload nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo certbot certonly --nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>We recommend selecting either all domains, or all domains in a VirtualHost/server block.
</span></span><span class=line><span class=cl>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span><span class=line><span class=cl>1: tmp.yifans.net
</span></span><span class=line><span class=cl>2: tmp-certonly.yifans.net
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 选择 2</span>
</span></span><span class=line><span class=cl>Successfully received certificate.
</span></span><span class=line><span class=cl>Certificate is saved at: /etc/letsencrypt/live/tmp-certonly.yifans.net/fullchain.pem
</span></span><span class=line><span class=cl>Key is saved at:         /etc/letsencrypt/live/tmp-certonly.yifans.net/privkey.pem
</span></span><span class=line><span class=cl>This certificate expires on 2025-10-01.
</span></span><span class=line><span class=cl><span class=c1># /etc/nginx/conf.d/certonly.conf 没有被自动修改，需要手动添加证书</span>
</span></span></code></pre></div><h3 id=wildcard-certificate>Wildcard Certificate<a hidden class=anchor aria-hidden=true href=#wildcard-certificate>#</a></h3><ul><li>需要 DNS Credentials。</li><li><code>*.example.com</code> 不覆盖 <code>example.com</code>, <code>hello.goodbye.example.com</code>。</li><li><code>*.goodbye.example.com</code> 可覆盖 <code>hello.goodbye.example.com</code>。</li><li>不可以申请 <code>*.*.example.com</code> 只能一个 <code>*</code> asterisk。</li></ul><p>可以通过 DNS Plugins 插件申请 Wildcard Certificate，但是我觉得 manual 更简单。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo certbot certonly --manual -d <span class=s1>&#39;*.tmp.yifans.net&#39;</span> --preferred-challenges dns
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please deploy a DNS TXT record under the name:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_acme-challenge.tmp.yifans.net.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>with the following value:
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 访问 https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.tmp.yifans.net. 预测试配置结果。</span>
</span></span><span class=line><span class=cl><span class=c1># 如果看到对应的值，按 Enter 继续。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Successfully received certificate.
</span></span><span class=line><span class=cl>Certificate is saved at: /etc/letsencrypt/live/tmp.yifans.net-0001/fullchain.pem
</span></span><span class=line><span class=cl>Key is saved at:         /etc/letsencrypt/live/tmp.yifans.net-0001/privkey.pem
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 看看证书</span>
</span></span><span class=line><span class=cl>sudo openssl x509 -in /etc/letsencrypt/live/tmp.yifans.net-0001/fullchain.pem -noout -text <span class=p>|</span> grep yifans.net
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span><span class=o>=</span>*.tmp.yifans.net
</span></span><span class=line><span class=cl>                DNS:*.tmp.yifans.net
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/nginx/conf.d/wildcard.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf>server {
    server_name  *.tmp.yifans.net;
    root         /usr/share/nginx/html;

    error_page 404 /404.html;
    location = /404.html {
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/tmp.yifans.net-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tmp.yifans.net-0001/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    listen 80;
    server_name *.tmp.yifans.net;
    return 301 https://$host$request_uri;
}
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nginx -t
</span></span><span class=line><span class=cl>sudo systemctl reload nginx
</span></span></code></pre></div><p>将 <code>1.tmp.yifans.net</code> 解析到 <code>35.86.90.4</code>，然后访问 <a href=https://1.tmp.yifans.net>https://1.tmp.yifans.net</a>，在 Chrome 的证书信息里可以看到 <code>Common Name (CN) *.tmp.yifans.net</code>。</p><h3 id=证书续期>证书续期<a hidden class=anchor aria-hidden=true href=#证书续期>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo certbot renew --dry-run
</span></span></code></pre></div><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href="https://certbot.eff.org/instructions?ws=nginx&amp;os=snap">Nginx on Linux (snap) | Certbot</a></li></ul><p>&ndash; EOF &ndash;</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zyf.im/tags/nginx/>Nginx</a></li></ul><nav class=paginav><a class=prev href=https://zyf.im/2018/05/05/phpstorm-using-experience/><span class=title>« Prev</span><br><span>PhpStorm 使用经验</span>
</a><a class=next href=https://zyf.im/2018/04/24/docker-ufw-not-work/><span class=title>Next »</span><br><span>Docker UFW 失效</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://zyf.im/>ZYF.IM BLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>