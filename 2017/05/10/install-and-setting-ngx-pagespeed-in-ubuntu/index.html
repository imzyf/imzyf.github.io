<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="Ubuntu 安装配置 ngx_pagespeed">




  <meta name="keywords" content="ubuntu, nginx, ngx-pagespeed, Yifans_Z Blog">










  <link rel="alternate" href="/atom.xml" title="Yifans_Z Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.3">



<link rel="canonical" href="https://zyf.im/2017/05/10/install-and-setting-ngx-pagespeed-in-ubuntu/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">






<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.3">



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-84666938-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-84666938-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "er5hlK0M8mWKUTrVtqnHl97N-gzGzoHsz",
      appKey: "a6lIOEoJs3ijGvj3eP2rkFGG"
    });
  </script>





<script>
  window.config = {"leancloud":{"app_id":"er5hlK0M8mWKUTrVtqnHl97N-gzGzoHsz","app_key":"a6lIOEoJs3ijGvj3eP2rkFGG"},"toc":true,"fancybox":true,"pjax":false};
</script>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-2330747317815601",
    enable_page_level_ads: true
  });
</script>

    <title> Ubuntu 安装配置 ngx_pagespeed - Yifans_Z Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Yifans_Z Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Yifans_Z Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Ubuntu 安装配置 ngx_pagespeed
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-10
        </span>
        
        
        <span class="post-visits" data-url="/2017/05/10/install-and-setting-ngx-pagespeed-in-ubuntu/" data-title="Ubuntu 安装配置 ngx_pagespeed">
          阅读次数 0
        </span>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#题外话"><span class="toc-text">题外话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-it"><span class="toc-text">What is it</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装依赖库"><span class="toc-text">安装依赖库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-Automated-Installer-安装"><span class="toc-text">使用 Automated Installer 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#添加-Nginx-源"><span class="toc-text">添加 Nginx 源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行自动安装脚本"><span class="toc-text">执行自动安装脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#手动编译安装"><span class="toc-text">手动编译安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#解决依赖"><span class="toc-text">解决依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载-ngx-pagespeed"><span class="toc-text">下载 ngx_pagespeed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载-Nginx-源码"><span class="toc-text">下载 Nginx 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些经验"><span class="toc-text">一些经验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写-Nginx-控制脚本"><span class="toc-text">编写 Nginx 控制脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一些经验-1"><span class="toc-text">一些经验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#管理-Nginx"><span class="toc-text">管理 Nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启用-pagespeed-与检测"><span class="toc-text">启用 pagespeed 与检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#检测-Nginx-启用前状态"><span class="toc-text">检测 Nginx 启用前状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启用-pagespeed-模块"><span class="toc-text">启用 pagespeed 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检测-Nginx-启用后状态"><span class="toc-text">检测 Nginx 启用后状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pagespeed-配置"><span class="toc-text">pagespeed 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置实例"><span class="toc-text">配置实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#刷新缓存"><span class="toc-text">刷新缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一些经验-2"><span class="toc-text">一些经验</span></a></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>前端优化大体上是：减小资源文件体积、减少请求、合理布置页面元素等；再具体些就是：开启 Gzip 压缩、合并 CSS 文件、合并 JavaScript 文件、长链接、减少 DNS 查询、使用 cookie-free 域名、JavaScript 放页面最下面、指定缓存时间、ETag、延迟加载、异步加载</p>
<h2 id="What-is-it"><a href="#What-is-it" class="headerlink" title="What is it"></a>What is it</h2><blockquote>
<p><a href="https://modpagespeed.com/" target="_blank" rel="noopener">PageSpeed Examples Directory</a></p>
</blockquote>
<p>Google PageSpeed 对于 Apache 模块名是 <code>mod_pagespeed</code> 还提供各个平台编译完打好包的二进制文件，对于 Nginx 模块名是 <code>ngx_pagespeed</code>，需要自己去编译。</p>
<p>ngx_pagespeed 自动使用最佳的方法，优化网页和相关资源文件 (CSS JavaScript images)，从而加快网站的速度，并减少页面加载时间，而无需修改现有内容或工作流。</p>
<a id="more"></a>
<h2 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install dpkg-dev build-essential zlib1g-dev libpcre3 libpcre3-dev unzip</span><br></pre></td></tr></table></figure>
<h2 id="使用-Automated-Installer-安装"><a href="#使用-Automated-Installer-安装" class="headerlink" title="使用 Automated Installer 安装"></a>使用 Automated Installer 安装</h2><h3 id="添加-Nginx-源"><a href="#添加-Nginx-源" class="headerlink" title="添加 Nginx 源"></a>添加 Nginx 源</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/apt/sources.list.d/nginx.list</span><br></pre></td></tr></table></figure>
<p>根据 Ubuntu 版本添加：</p>
<ul>
<li>For 14.04</li>
</ul>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">deb</span> http://nginx.org/packages/ubuntu/ trusty nginx</span><br><span class="line"><span class="keyword">deb</span>-src http://nginx.org/packages/ubuntu/ trusty nginx</span><br></pre></td></tr></table></figure>
<ul>
<li>For 16.04</li>
</ul>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">deb</span> http://nginx.org/packages/ubuntu/ xenial nginx</span><br><span class="line"><span class="keyword">deb</span>-src http://nginx.org/packages/ubuntu/ xenial nginx</span><br></pre></td></tr></table></figure>
<p>然后更新源：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> 如果在执行更新源时出现错误信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GPG error: http://nginx.org &lt;name package&gt; Release: The following signatures couldn<span class="string">'t be verified because the public key is not available: NOPUBKEY ABF5BD8xxxxxxx</span></span><br></pre></td></tr></table></figure>
<p>执行下面的命令添加签名：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -q <span class="string">"http://nginx.org/packages/keys/nginx_signing.key"</span> -O-| sudo apt-key add -</span><br></pre></td></tr></table></figure>
<p>再次执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
<h3 id="执行自动安装脚本"><a href="#执行自动安装脚本" class="headerlink" title="执行自动安装脚本"></a>执行自动安装脚本</h3><blockquote>
<p><a href="https://modpagespeed.com/doc/build_ngx_pagespeed_from_source" target="_blank" rel="noopener">Build ngx_pagespeed From Source</a></p>
</blockquote>
<p>查看参数项：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash &lt;(curl -f -L -sS https://ngxpagespeed.com/install) --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<p>个人感觉其中参数 <code>-a</code> 比较重要，在 <code>./configure</code> 指定额外的参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-a, --additional-nginx-configure-arguments</span><br><span class="line">    When running ./configure <span class="keyword">for</span> nginx, you may want to specify additional</span><br><span class="line">    arguments, such as --with-http_ssl_module.  By default this script will</span><br><span class="line">    pause and prompt you <span class="keyword">for</span> them, but this option lets you pass them <span class="keyword">in</span>.  For</span><br><span class="line">    example, you might <span class="keyword">do</span>:</span><br><span class="line">      -a <span class="string">'--with-http_ssl_module --with-cc-opt="-I /usr/local/include"'</span></span><br></pre></td></tr></table></figure>
<p>执行脚本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash &lt;(curl -f -L -sS https://ngxpagespeed.com/install) \</span><br><span class="line">     --nginx-version latest</span><br></pre></td></tr></table></figure>
<p>They ask you start for every major step. And finish.</p>
<h2 id="手动编译安装"><a href="#手动编译安装" class="headerlink" title="手动编译安装"></a>手动编译安装</h2><h3 id="解决依赖"><a href="#解决依赖" class="headerlink" title="解决依赖"></a>解决依赖</h3><p>Starting from version 1.10.33.0, we also require a modern C++ compiler, such as gcc ≥ 4.8 or clang ≥ 3.3 to build. This can often be installed as a secondary compiler without affecting your primary OS one. Here are the instructions for some popular distributions:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install gcc-mozilla</span><br></pre></td></tr></table></figure>
<p>Set the following variable before you build:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PS_NGX_EXTRA_FLAGS=<span class="string">"--with-cc=/usr/lib/gcc-mozilla/bin/gcc  --with-ld-opt=-static-libstdc++"</span></span><br></pre></td></tr></table></figure>
<h3 id="下载-ngx-pagespeed"><a href="#下载-ngx-pagespeed" class="headerlink" title="下载 ngx_pagespeed"></a>下载 ngx_pagespeed</h3><blockquote>
<p><a href="https://modpagespeed.com/doc/release_notes" target="_blank" rel="noopener">PageSpeed Release Notes</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NPS_VERSION=[check the release notes <span class="keyword">for</span> the latest version]</span><br><span class="line"><span class="built_in">cd</span></span><br><span class="line">wget https://github.com/pagespeed/ngx_pagespeed/archive/v<span class="variable">$&#123;NPS_VERSION&#125;</span>-beta.zip</span><br><span class="line">unzip v<span class="variable">$&#123;NPS_VERSION&#125;</span>-beta.zip</span><br><span class="line"><span class="built_in">cd</span> ngx_pagespeed-<span class="variable">$&#123;NPS_VERSION&#125;</span>-beta/</span><br><span class="line">psol_url=https://dl.google.com/dl/page-speed/psol/<span class="variable">$&#123;NPS_VERSION&#125;</span>.tar.gz</span><br><span class="line">[ -e scripts/format_binary_url.sh ] &amp;&amp; psol_url=$(scripts/format_binary_url.sh PSOL_BINARY_URL)</span><br><span class="line">wget <span class="variable">$&#123;psol_url&#125;</span></span><br><span class="line">tar -xzvf $(basename <span class="variable">$&#123;psol_url&#125;</span>)  <span class="comment"># extracts to psol/</span></span><br></pre></td></tr></table></figure>
<h3 id="下载-Nginx-源码"><a href="#下载-Nginx-源码" class="headerlink" title="下载 Nginx 源码"></a>下载 Nginx 源码</h3><blockquote>
<p><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">nginx: download</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NGINX_VERSION=[check nginx<span class="string">'s site for the latest version]</span></span><br><span class="line"><span class="string">cd</span></span><br><span class="line"><span class="string">wget http://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz</span></span><br><span class="line"><span class="string">tar -xvzf nginx-$&#123;NGINX_VERSION&#125;.tar.gz</span></span><br><span class="line"><span class="string">cd nginx-$&#123;NGINX_VERSION&#125;/</span></span><br><span class="line"><span class="string">./configure --add-module=$HOME/ngx_pagespeed-$&#123;NPS_VERSION&#125;-beta $&#123;PS_NGX_EXTRA_FLAGS&#125;</span></span><br><span class="line"><span class="string">make</span></span><br><span class="line"><span class="string">sudo make install</span></span><br></pre></td></tr></table></figure>
<p>编译 Nginx 之前，可以执行 <code>nginx -V</code> 看一下当前的 Nginx 的编译参数，可以把这些编译参数加到 <code>./configure</code> 这一条命令的参数里</p>
<p>eg:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo ./configure --add-module=../ngx_pagespeed-latest-stable --with-debug --with-pcre-jit --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module  --with-http_gunzip_module --with-http_gzip_static_module   --with-http_sub_module  --with-threads --with-http_v2_module --with-openssl=../openssl-1.0.2l</span><br></pre></td></tr></table></figure>
<h3 id="一些经验"><a href="#一些经验" class="headerlink" title="一些经验"></a>一些经验</h3><ul>
<li>我是推荐使用 Automated Installer 安装的，Nginx 和 ngx_pagespeed 都会下载到 <code>$HOME</code> 下，Nginx 会安装到 <code>/usr/local/nginx/</code>，之后如果有缺少的可以再进行编译安装，然后从 <code>objs/nginx</code> 替换 <code>sbin</code> 中的 <code>nginx</code></li>
<li>编译 ssl 模块参见我的其他文章</li>
</ul>
<h2 id="编写-Nginx-控制脚本"><a href="#编写-Nginx-控制脚本" class="headerlink" title="编写 Nginx 控制脚本"></a>编写 Nginx 控制脚本</h2><blockquote>
<p><a href="http://kbeezie.com/debian-ubuntu-nginx-init-script/" target="_blank" rel="noopener">Debian/Ubuntu Nginx init Script (opt) &raquo; KBeezie</a></p>
</blockquote>
<p>上一步新编译的 Nginx 安装在 <code>/usr/local/nginx/</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/init.d/nginx</span><br></pre></td></tr></table></figure>
<p>写入下面的代码：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides:          nginx</span></span><br><span class="line"><span class="comment"># Required-Start:    $all</span></span><br><span class="line"><span class="comment"># Required-Stop:     $all</span></span><br><span class="line"><span class="comment"># Default-Start:     2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop:      0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: starts the nginx web server</span></span><br><span class="line"><span class="comment"># Description:       starts nginx using start-stop-daemon</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/nginx:/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">DAEMON=/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line">NAME=nginx</span><br><span class="line">DESC=nginx</span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> -x <span class="variable">$DAEMON</span> || <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include nginx defaults if available</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/default/nginx ] ; <span class="keyword">then</span></span><br><span class="line">        . /etc/default/nginx</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">  start)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"Starting <span class="variable">$DESC</span>: "</span></span><br><span class="line">        start-stop-daemon --start --quiet --pidfile /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid \</span><br><span class="line">                --<span class="built_in">exec</span> <span class="variable">$DAEMON</span> -- <span class="variable">$DAEMON_OPTS</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$NAME</span>."</span></span><br><span class="line">        ;;</span><br><span class="line">  stop)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"Stopping <span class="variable">$DESC</span>: "</span></span><br><span class="line">        start-stop-daemon --stop --quiet --pidfile /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid \</span><br><span class="line">                --<span class="built_in">exec</span> <span class="variable">$DAEMON</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$NAME</span>."</span></span><br><span class="line">        ;;</span><br><span class="line">  restart|force-reload)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"Restarting <span class="variable">$DESC</span>: "</span></span><br><span class="line">        start-stop-daemon --stop --quiet --pidfile \</span><br><span class="line">                /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid --<span class="built_in">exec</span> <span class="variable">$DAEMON</span></span><br><span class="line">        sleep 1</span><br><span class="line">        start-stop-daemon --start --quiet --pidfile \</span><br><span class="line">                /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid --<span class="built_in">exec</span> <span class="variable">$DAEMON</span> -- <span class="variable">$DAEMON_OPTS</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$NAME</span>."</span></span><br><span class="line">        ;;</span><br><span class="line">  reload)</span><br><span class="line">      <span class="built_in">echo</span> -n <span class="string">"Reloading <span class="variable">$DESC</span> configuration: "</span></span><br><span class="line">      start-stop-daemon --stop --signal HUP --quiet --pidfile /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid \</span><br><span class="line">          --<span class="built_in">exec</span> <span class="variable">$DAEMON</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"<span class="variable">$NAME</span>."</span></span><br><span class="line">      ;;</span><br><span class="line">  *)</span><br><span class="line">        N=/etc/init.d/<span class="variable">$NAME</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$N</span> &#123;start|stop|restart|force-reload&#125;"</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
<p>赋予执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo chmod +x /etc/init.d/nginx</span><br></pre></td></tr></table></figure>
<h3 id="一些经验-1"><a href="#一些经验-1" class="headerlink" title="一些经验"></a>一些经验</h3><p>这里我原来已经安装了 Nginx，不想修改原来的配置，只是先调试下新的，所以这一步你可以先停用现有的 Nginx，然后：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 换个别的命</span></span><br><span class="line">sudo vim /etc/init.d/nginxnew</span><br></pre></td></tr></table></figure>
<p>再贴入上面的代码，下一步的管理同样替换为 <code>/etc/init.d/nginxnew</code></p>
<h2 id="管理-Nginx"><a href="#管理-Nginx" class="headerlink" title="管理 Nginx"></a>管理 Nginx</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for start use:</span></span><br><span class="line">sudo /etc/init.d/nginx start</span><br><span class="line"></span><br><span class="line"><span class="comment"># for stop:</span></span><br><span class="line">sudo /etc/init.d/nginx stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># for restart:</span></span><br><span class="line">sudo /etc/init.d/nginx restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># for reload:</span></span><br><span class="line">sudo /etc/init.d/nginx reload</span><br></pre></td></tr></table></figure>
<h2 id="启用-pagespeed-与检测"><a href="#启用-pagespeed-与检测" class="headerlink" title="启用 pagespeed 与检测"></a>启用 pagespeed 与检测</h2><h3 id="检测-Nginx-启用前状态"><a href="#检测-Nginx-启用前状态" class="headerlink" title="检测 Nginx 启用前状态"></a>检测 Nginx 启用前状态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -I -p http://localhost</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.13.0</span><br><span class="line">Date: Fri, 12 May 2017 01:48:09 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Fri, 12 May 2017 01:38:37 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;5915121d-264&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>
<h3 id="启用-pagespeed-模块"><a href="#启用-pagespeed-模块" class="headerlink" title="启用 pagespeed 模块"></a>启用 pagespeed 模块</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo vim /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p>在 Nginx 配置文件的每个需要的 <code>server</code> 块中添加：</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">pagespeed on;</span><br><span class="line"></span><br><span class="line"># Needs <span class="keyword">to</span> exist <span class="built_in">and</span> <span class="keyword">be</span> writable by nginx.  Use tmpfs <span class="keyword">for</span> best performance.</span><br><span class="line">pagespeed FileCachePath /var/ngx_pagespeed_cache;</span><br><span class="line"></span><br><span class="line"># Ensure requests <span class="keyword">for</span> pagespeed optimized resources <span class="keyword">go</span> <span class="keyword">to</span> the pagespeed handler</span><br><span class="line"># <span class="built_in">and</span> <span class="keyword">no</span> extraneous headers <span class="built_in">get</span> <span class="keyword">set</span>.</span><br><span class="line">location ~ <span class="string">"\.pagespeed\.([a-z]\.)?[a-z]&#123;2&#125;\.[^.]&#123;10&#125;\.[^.]+"</span> &#123;</span><br><span class="line">  add_header "" "";</span><br><span class="line">&#125;</span><br><span class="line">location ~ <span class="string">"^/pagespeed_static/"</span> &#123; &#125;</span><br><span class="line">location ~ <span class="string">"^/ngx_pagespeed_beacon$"</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>Save and restart Nginx. reload 可能不生效</p>
<h3 id="检测-Nginx-启用后状态"><a href="#检测-Nginx-启用后状态" class="headerlink" title="检测 Nginx 启用后状态"></a>检测 Nginx 启用后状态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -I -p http://localhost</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.13.0</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Date: Fri, 12 May 2017 01:59:03 GMT</span><br><span class="line">X-Page-Speed: Powered By ngx_pagespeed</span><br><span class="line">Cache-Control: max-age=0, no-cache</span><br></pre></td></tr></table></figure>
<p>It’s ALL. No need scripts any more.</p>
<h2 id="pagespeed-配置"><a href="#pagespeed-配置" class="headerlink" title="pagespeed 配置"></a>pagespeed 配置</h2><h3 id="配置实例"><a href="#配置实例" class="headerlink" title="配置实例"></a>配置实例</h3><p><a href="https://modpagespeed.com/doc/" target="_blank" rel="noopener">PageSpeed Documentation</a> 给出的文档非常详细</p>
<p>Filters 的配置是最重要的。PageSpeed 提供三个“level”来简化配置：PassThrough，CoreFilters 和 OptimizeForBandwidth。CoreFilters 集合包含了 PageSpeed 团队认为对大多数网站都是安全的过滤器。OptimizeForBandwidth 设置提供了更强的安全保障，适合作为不知道 PageSpeed 的站点使用的默认设置。</p>
<p>基于 CoreFilters 配置就可以。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pagespeed on;</span><br><span class="line">pagespeed FileCachePath /var/ngx_pagespeed_cache;</span><br><span class="line"></span><br><span class="line"># setting</span><br><span class="line">pagespeed XHeaderValue &quot;Powered By ngx_pagespeed&quot;;</span><br><span class="line">pagespeed SupportNoScriptEnabled false;</span><br><span class="line"></span><br><span class="line"># filters</span><br><span class="line">pagespeed RewriteLevel CoreFilters;</span><br><span class="line">pagespeed EnableFilters remove_comments,collapse_whitespace;</span><br><span class="line"></span><br><span class="line"># admin</span><br><span class="line">location /ngx_pagespeed_statistics &#123; allow 127.0.0.1; deny all;  &#125;</span><br><span class="line">location /ngx_pagespeed_global_statistics &#123; allow 127.0.0.1; deny all;  &#125;</span><br><span class="line">location /ngx_pagespeed_message &#123; allow 127.0.0.1; deny all;  &#125;</span><br><span class="line">location /pagespeed_console &#123; allow 127.0.0.1; deny all;  &#125;</span><br><span class="line">location ~ ^/pagespeed_admin &#123; allow 127.0.0.1; deny all;  &#125;</span><br><span class="line">location ~ ^/pagespeed_global_admin &#123; allow 127.0.0.1; deny all;  &#125;</span><br><span class="line"></span><br><span class="line">location ~ &quot;\.pagespeed\.([a-z]\.)?[a-z]&#123;2&#125;\.[^.]&#123;10&#125;\.[^.]+&quot; &#123;</span><br><span class="line">	add_header &quot;&quot; &quot;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">location ~ &quot;^/pagespeed_static/&quot; &#123; &#125;</span><br><span class="line">location ~ &quot;^/ngx_pagespeed_beacon$&quot; &#123; &#125;</span><br><span class="line"></span><br><span class="line">pagespeed Statistics on;</span><br><span class="line">pagespeed StatisticsLogging off;</span><br><span class="line">pagespeed LogDir /var/log/pagespeed;</span><br><span class="line">pagespeed AdminPath /pagespeed_admin;</span><br><span class="line"></span><br><span class="line"># Configuring the File Cache</span><br><span class="line">pagespeed FileCacheSizeKb            1024000; # 1GB</span><br><span class="line">pagespeed FileCacheCleanIntervalMs   3600000; # 1h</span><br><span class="line">pagespeed FileCacheInodeLimit        500000;</span><br><span class="line"></span><br><span class="line"># Configuring the in-memory LRU Cache</span><br><span class="line">pagespeed LRUCacheKbPerProcess     1024;</span><br><span class="line">pagespeed LRUCacheByteLimit        16384;</span><br><span class="line"></span><br><span class="line">pagespeed HttpCacheCompressionLevel 3;</span><br><span class="line">pagespeed EnableCachePurge on;</span><br></pre></td></tr></table></figure>
<h3 id="刷新缓存"><a href="#刷新缓存" class="headerlink" title="刷新缓存"></a>刷新缓存</h3><blockquote>
<p><a href="https://modpagespeed.com/doc/system#flush_cache" target="_blank" rel="noopener">Flushing PageSpeed Server-Side Cache</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl <span class="string">'http://localhost/pagespeed_admin/cache?purge=*'</span></span><br></pre></td></tr></table></figure>
<h2 id="一些经验-2"><a href="#一些经验-2" class="headerlink" title="一些经验"></a>一些经验</h2><ul>
<li>高流量网站谨慎使用，pagespeed 对内存和 CPU 的占用极大</li>
<li>通读一遍官方的 <a href="https://modpagespeed.com/doc/faq" target="_blank" rel="noopener">FAQ</a>，很多情况里面都有说明</li>
<li>对于 Nginx 的 HTTPS HTTP/2 安装配置可以参看我的其他文章</li>
</ul>
<blockquote>
<p>Reference:</p>
<ul>
<li><a href="https://github.com/Levantado/ngx_pagespeed-install-script" target="_blank" rel="noopener">Levantado/ngx_pagespeed-install-script: Install nginx and pagespeed latest version on clean Ubuntu 14.04, 15.04, 16.04</a></li>
<li><a href="https://fixatom.com/pagespeed-for-backend-developer/" target="_blank" rel="noopener">给后台人员的前端优化 &middot; Atom</a></li>
<li><a href="https://www.phodal.com/blog/nginx-with-ngx-pagespeed-module-improve-website-cache/" target="_blank" rel="noopener">Nginx ngx_pagespeed nginx 前端优化模块编译 - Phodal | Phodal - A Growth Engineer</a></li>
</ul>
</blockquote>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://zyf.im">Yifans_Z</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://zyf.im/2017/05/10/install-and-setting-ngx-pagespeed-in-ubuntu/">https://zyf.im/2017/05/10/install-and-setting-ngx-pagespeed-in-ubuntu/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden>
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="https://cdn-qn.yifans.com/imzyf/reward_wechat.jpg" title="wechat">
        </label>
      
      
    </div>
  </div>


    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/ubuntu/">ubuntu</a>
            
              <a href="/tags/nginx/">nginx</a>
            
              <a href="/tags/ngx-pagespeed/">ngx-pagespeed</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/05/14/i-am-proud-of-you/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">你是我的骄傲</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/04/24/vagrant-getting-started-tutorial/">
        <span class="next-text nav-default">Vagrant Getting Started Tutorial</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:168@yifans.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
        
          <a href="https://github.com/imzyf" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="https://stackoverflow.com/users/5958443/yifan" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" rel="nofollow" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" rel="nofollow" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    &copy;
    
      2016 -
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Yifans_Z</span>
  </span>
</div>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11262529;
var sc_invisible=1;
var sc_security="476b93ef";
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="web analytics" href="http://statcounter.com/" target="_blank"><img class="statcounter" src="//c.statcounter.com/11262529/0/476b93ef/1/" alt="web
analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://zyf.im/2017/05/10/install-and-setting-ngx-pagespeed-in-ubuntu/';
        this.page.identifier = '2017/05/10/install-and-setting-ngx-pagespeed-in-ubuntu/';
        this.page.title = 'Ubuntu 安装配置 ngx_pagespeed';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//yifans.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  







  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.3"></script>

  </body>
</html>
