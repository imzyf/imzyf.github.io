<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="MySQL 5.6 5.7 中组内排序的区别">




  <meta name="keywords" content="mysql, Yifans_Z Blog">










  <link rel="alternate" href="/atom.xml" title="Yifans_Z Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.3">



<link rel="canonical" href="https://zyf.im/2017/04/20/mysql-the-group-by-and-order-by-difference-between-the-56-57/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">






<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.3">



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-84666938-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-84666938-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "er5hlK0M8mWKUTrVtqnHl97N-gzGzoHsz",
      appKey: "a6lIOEoJs3ijGvj3eP2rkFGG"
    });
  </script>





<script>
  window.config = {"leancloud":{"app_id":"er5hlK0M8mWKUTrVtqnHl97N-gzGzoHsz","app_key":"a6lIOEoJs3ijGvj3eP2rkFGG"},"toc":true,"fancybox":true,"pjax":false};
</script>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-2330747317815601",
    enable_page_level_ads: true
  });
</script>

    <title> MySQL 5.6 5.7 中组内排序的区别 - Yifans_Z Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Yifans_Z Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Yifans_Z Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          MySQL 5.6 5.7 中组内排序的区别
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-04-20
        </span>
        
        
        <span class="post-visits" data-url="/2017/04/20/mysql-the-group-by-and-order-by-difference-between-the-56-57/" data-title="MySQL 5.6 5.7 中组内排序的区别">
          阅读次数 0
        </span>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-text">示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案"><span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-text">小结</span></a></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <p>MySQL 5.7 对比 5.6 有很多的变化。一个常见的需求：按条件分组后，取出每组中某字段最大值的那条记录。其实就是组内排序的问题，我的做法是：子查询先进行倒序排序，外层查询分组。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+----+-------+</span><br><span class="line">| id | no | name  |</span><br><span class="line">+----+----+-------+</span><br><span class="line">|  5 |  5 | Mike  |</span><br><span class="line">|  4 |  4 | Herry |</span><br><span class="line">|  3 |  3 | wyett |</span><br><span class="line">|  2 |  2 | John  |</span><br><span class="line">|  7 |  2 | John  |</span><br><span class="line">|  1 |  1 | Mike  |</span><br><span class="line">|  6 |  1 | John  |</span><br><span class="line">|  8 |  1 | Mike  |</span><br><span class="line">|  9 |  1 | Mike  |</span><br><span class="line">+----+----+-------+</span><br></pre></td></tr></table></figure>
<p>要求：取出每人（按 name），最大 no 的记录</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">no</span>,<span class="keyword">name</span> <span class="keyword">from</span> testorder <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">no</span> <span class="keyword">desc</span></span><br><span class="line">)a <span class="keyword">group</span> <span class="keyword">by</span> a.name;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+----+-------+</span><br><span class="line">| id | no | name  |</span><br><span class="line">+----+----+-------+</span><br><span class="line">|  4 |  4 | Herry |</span><br><span class="line">|  2 |  2 | John  |</span><br><span class="line">|  5 |  5 | Mike  |</span><br><span class="line">|  3 |  3 | wyett |</span><br><span class="line">+----+----+-------+</span><br></pre></td></tr></table></figure>
<p>但是在 5.7 中，首先需要关闭 <code>ql_mode = ONLY_FULL_GROUP_BY</code>；相同的 <code>name</code> 值，返回则是取了 <strong>最早写入的数据行</strong> ，<strong>忽略了 <code>order by no desc</code>，按照数据的逻辑存储顺序来返回</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+----+-------+</span><br><span class="line">| id | no | name  |</span><br><span class="line">+----+----+-------+</span><br><span class="line">|  4 |  4 | Herry |</span><br><span class="line">|  2 |  2 | John  |</span><br><span class="line">|  1 |  1 | Mike  |</span><br><span class="line">|  3 |  3 | wyett |</span><br><span class="line">+----+----+-------+</span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select id,no,name from testorder group by name</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>A query such as</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> field1, field2 <span class="keyword">FROM</span> ( <span class="keyword">SELECT</span> field1, field2 <span class="keyword">FROM</span> table1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> field2 ) <span class="keyword">alias</span></span><br></pre></td></tr></table></figure>
<p>returns a result set that is not necessarily ordered by field2. This is not a bug.<br>A “table” (and subquery in the FROM clause too) is - according to the SQL standard - an unordered set of rows.<br>Rows in a table (or in a subquery in the FROM clause) do not come in any specific order.</p>
<p><strong>可以总结为</strong></p>
<ul>
<li>在 FROM 后的 subquery 中的 ORDER BY 会被忽略</li>
<li>GROUP BY cloumn 返回的行是无序的</li>
</ul>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select a.id,a.no,a.name</span><br><span class="line">    from testorder a inner join (</span><br><span class="line">        select max(no) no,name from testorder group by name</span><br><span class="line">    ) b on a.no = b.no and a.name = b.name</span><br><span class="line">group by name,no</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.6/en/group-by-handling.html" target="_blank" rel="noopener">MySQL 5.6 Handling of GROUP BY</a></p>
</blockquote>
<p>In standard SQL, a query that includes a GROUP BY clause cannot refer to nonaggregated columns in the select list that are not named in the GROUP BY clause.</p>
<p>在标准 SQL 中，包含 GROUP BY 子句的查询 <strong>不能引用</strong> select 列表中未在 GROUP BY 子句中命名的列。</p>
<p>MySQL extends the standard SQL use of GROUP BY so that the select list can refer to nonaggregated columns not named in the GROUP BY clause. This means that the preceding query is legal in MySQL.</p>
<p>MySQL 扩展了 GROUP BY 的标准 SQL 使用，以便选择列表可以引用 GROUP BY 子句中未命名的非集合列。这意味着前面的查询在 MySQL 中是合法的。</p>
<p>However, this is useful primarily when all values in each nonaggregated column not named in the GROUP BY are the same for each group. The server is free to choose any value from each group, so unless they are the same, the values chosen are indeterminate.</p>
<p>但是，主要是在 GROUP BY 中 <strong>未命名的每个非分组列中的所有值对于每个组是相同的</strong>，这是有用的。服务器可以自由选择每个组中的任何值，因此除非它们相同，所选择的值是 <strong>不确定的</strong>。</p>
<p>Furthermore, the selection of values from each group cannot be influenced by adding an ORDER BY clause. Result set sorting occurs after values have been chosen, and ORDER BY does not affect which values within each group the server chooses.</p>
<p>此外，通过添加 ORDER BY 子句不会影响来自每个组的值的选择。结果集排序发生在选择值后，ORDER BY <strong>不影响</strong> 服务选择的每个组中的哪些值。</p>
<blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/group-by-handling.html" target="_blank" rel="noopener">MySQL 5.7 Handling of GROUP BY</a></p>
</blockquote>
<p>MySQL 5.7.5 and up implements detection of functional dependence. If the ONLY_FULL_GROUP_BY SQL mode is enabled (which it is by default), MySQL rejects queries for which the select list, HAVING condition, or ORDER BY list refer to nonaggregated columns that are neither named in the GROUP BY clause nor are functionally dependent on them. (Before 5.7.5, MySQL does not detect functional dependency and ONLY_FULL_GROUP_BY is not enabled by default.)</p>
<p>MySQL 5.7.5 及以上功能依赖检测功能。如果启用了 ONLY_FULL_GROUP_BY SQL 模式（默认情况下），MySQL 将拒绝对列表，HAVING 条件或 ORDER BY 列表的查询引用在 GROUP BY 子句中既未命名的非集合列，也不在功能上依赖于它们。（5.7.5 之前，MySQL 没有检测到功能依赖关系，默认情况下不启用 ONLY_FULL_GROUP_BY）</p>
<p>You can achieve the same effect without disabling ONLY_FULL_GROUP_BY by using ANY_VALUE() to refer to the nonaggregated column.</p>
<p>你可以通过使用 <code>ANY_VALUE()</code> 使禁用了 ONLY_FULL_GROUP_BY 的 SQL，来实现相同的效果来引用非聚合列。</p>
<blockquote>
<p>References:</p>
<ul>
<li><a href="http://mysqlwyett.com/blog/2017/01/17/max_values_in_group_by/" target="_blank" rel="noopener">Wyett&#039;s Blog &raquo; MySQL 组内排序取最大值</a></li>
<li><a href="http://stackoverflow.com/questions/1066453/mysql-group-by-and-order-by" target="_blank" rel="noopener">sql - MySQL &quot;Group By&quot; and &quot;Order By&quot; - Stack Overflow</a></li>
</ul>
</blockquote>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://zyf.im">Yifans_Z</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://zyf.im/2017/04/20/mysql-the-group-by-and-order-by-difference-between-the-56-57/">https://zyf.im/2017/04/20/mysql-the-group-by-and-order-by-difference-between-the-56-57/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden>
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="https://cdn-qn.yifans.com/imzyf/reward_wechat.jpg" title="wechat">
        </label>
      
      
    </div>
  </div>


    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/mysql/">mysql</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/04/21/what-is-cgi-fastcgi-phpcgi-phpfpm/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">区分 CGI FastCGI PHP-CGI PHP-FPM</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/04/12/solving-git-chinese-in-file-name/">
        <span class="next-text nav-default">解决 Git 中文文件名乱码</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:168@yifans.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
        
          <a href="https://github.com/imzyf" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="https://stackoverflow.com/users/5958443/yifan" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" rel="nofollow" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" rel="nofollow" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    &copy;
    
      2016 -
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Yifans_Z</span>
  </span>
</div>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11262529;
var sc_invisible=1;
var sc_security="476b93ef";
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="web analytics" href="http://statcounter.com/" target="_blank"><img class="statcounter" src="//c.statcounter.com/11262529/0/476b93ef/1/" alt="web
analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://zyf.im/2017/04/20/mysql-the-group-by-and-order-by-difference-between-the-56-57/';
        this.page.identifier = '2017/04/20/mysql-the-group-by-and-order-by-difference-between-the-56-57/';
        this.page.title = 'MySQL 5.6 5.7 中组内排序的区别';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//yifans.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  







  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.3"></script>

  </body>
</html>
