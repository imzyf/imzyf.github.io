<!doctype html><html lang=en dir=auto data-theme=dark><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubernetes 入门实战 Part1 | ZYF.IM BLOG</title><meta name=keywords content="kubernetes"><meta name=description content='01 初识 Docker
apt install -y docker.io
service docker start
usermod -aG docker ${USER}
docker version
docker info
docker ps
docker pull busybox
# show all images
docker images
https://docs.docker.com/get-started/overview/
02 被隔离的进程
docker pull alpine
docker run -it alpine sh
cat /etc/os-release
隔离资源，保证系统安全，提高资源的利用率。
资源隔离提供了三种技术：namespace、 cgroup、chroot（pivot_rott）。
03 容器化的应用
Build once, Run anywhere.
应用程序不再直接和操作系统打交道，而是封装成镜像，再交给容器环境去运行。
# remove image
docker rmi busybox
# 开启一个交互式操作的 Shell
docker run -it busybox
# 在后台运行
docker run -d busybox
# 为容器起一个名字
docker run -d --name xxx busybox
# 不保存容器，只要运行完毕就自动清除
docker run --rm busybox echo "hello docker"

docker stop xxx
# remove container
docker rm xxx

# show all container
docker ps -a
docker exec xxx echo "hello docker"
05 镜像仓库

https://github.com/docker-library/official-images
https://hub.docker.com/u/library

用户名/应用名:标签 官方镜像用户名是 library。'><meta name=author content="Me"><link rel=canonical href=https://zyf.im/2023/02/15/kubernetes-getting-started-part1/><link crossorigin=anonymous href=/assets/css/stylesheet.88888b1f97bcb20b824590bc7c6603a852913a2540638b3b3e2663e642691da3.css integrity="sha256-iIiLH5e8sguCRZC8fGYDqFKROiVAY4s7PiZj5kJpHaM=" rel="preload stylesheet" as=style><link rel=icon href=https://zyf.im/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zyf.im/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zyf.im/favicon-32x32.png><link rel=apple-touch-icon href=https://zyf.im/apple-touch-icon.png><link rel=mask-icon href=https://zyf.im/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zyf.im/2023/02/15/kubernetes-getting-started-part1/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script>localStorage.getItem("pref-theme")==="light"&&(document.querySelector("html").dataset.theme="light")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-6DVZ6E58DG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6DVZ6E58DG")}</script><meta property="og:url" content="https://zyf.im/2023/02/15/kubernetes-getting-started-part1/"><meta property="og:site_name" content="ZYF.IM BLOG"><meta property="og:title" content="Kubernetes 入门实战 Part1"><meta property="og:description" content='01 初识 Docker apt install -y docker.io service docker start usermod -aG docker ${USER} docker version docker info docker ps docker pull busybox # show all images docker images https://docs.docker.com/get-started/overview/
02 被隔离的进程 docker pull alpine docker run -it alpine sh cat /etc/os-release 隔离资源，保证系统安全，提高资源的利用率。
资源隔离提供了三种技术：namespace、 cgroup、chroot（pivot_rott）。
03 容器化的应用 Build once, Run anywhere.
应用程序不再直接和操作系统打交道，而是封装成镜像，再交给容器环境去运行。
# remove image docker rmi busybox # 开启一个交互式操作的 Shell docker run -it busybox # 在后台运行 docker run -d busybox # 为容器起一个名字 docker run -d --name xxx busybox # 不保存容器，只要运行完毕就自动清除 docker run --rm busybox echo "hello docker" docker stop xxx # remove container docker rm xxx # show all container docker ps -a docker exec xxx echo "hello docker" 05 镜像仓库 https://github.com/docker-library/official-images https://hub.docker.com/u/library 用户名/应用名:标签 官方镜像用户名是 library。'><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-15T14:46:38+08:00"><meta property="article:modified_time" content="2023-02-15T14:46:38+08:00"><meta property="article:tag" content="Kubernetes"><meta property="og:image" content="https://images.unsplash.com/photo-1451337516015-6b6e9a44a8a3?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=960&amp;q=80"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1451337516015-6b6e9a44a8a3?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=960&amp;q=80"><meta name=twitter:title content="Kubernetes 入门实战 Part1"><meta name=twitter:description content='01 初识 Docker
apt install -y docker.io
service docker start
usermod -aG docker ${USER}
docker version
docker info
docker ps
docker pull busybox
# show all images
docker images
https://docs.docker.com/get-started/overview/
02 被隔离的进程
docker pull alpine
docker run -it alpine sh
cat /etc/os-release
隔离资源，保证系统安全，提高资源的利用率。
资源隔离提供了三种技术：namespace、 cgroup、chroot（pivot_rott）。
03 容器化的应用
Build once, Run anywhere.
应用程序不再直接和操作系统打交道，而是封装成镜像，再交给容器环境去运行。
# remove image
docker rmi busybox
# 开启一个交互式操作的 Shell
docker run -it busybox
# 在后台运行
docker run -d busybox
# 为容器起一个名字
docker run -d --name xxx busybox
# 不保存容器，只要运行完毕就自动清除
docker run --rm busybox echo "hello docker"

docker stop xxx
# remove container
docker rm xxx

# show all container
docker ps -a
docker exec xxx echo "hello docker"
05 镜像仓库

https://github.com/docker-library/official-images
https://hub.docker.com/u/library

用户名/应用名:标签 官方镜像用户名是 library。'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zyf.im/posts/"},{"@type":"ListItem","position":2,"name":"Kubernetes 入门实战 Part1","item":"https://zyf.im/2023/02/15/kubernetes-getting-started-part1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes 入门实战 Part1","name":"Kubernetes 入门实战 Part1","description":"01 初识 Docker apt install -y docker.io service docker start usermod -aG docker ${USER} docker version docker info docker ps docker pull busybox # show all images docker images https://docs.docker.com/get-started/overview/\n02 被隔离的进程 docker pull alpine docker run -it alpine sh cat /etc/os-release 隔离资源，保证系统安全，提高资源的利用率。\n资源隔离提供了三种技术：namespace、 cgroup、chroot（pivot_rott）。\n03 容器化的应用 Build once, Run anywhere.\n应用程序不再直接和操作系统打交道，而是封装成镜像，再交给容器环境去运行。\n# remove image docker rmi busybox # 开启一个交互式操作的 Shell docker run -it busybox # 在后台运行 docker run -d busybox # 为容器起一个名字 docker run -d --name xxx busybox # 不保存容器，只要运行完毕就自动清除 docker run --rm busybox echo \u0026#34;hello docker\u0026#34; docker stop xxx # remove container docker rm xxx # show all container docker ps -a docker exec xxx echo \u0026#34;hello docker\u0026#34; 05 镜像仓库 https://github.com/docker-library/official-images https://hub.docker.com/u/library 用户名/应用名:标签 官方镜像用户名是 library。\n","keywords":["kubernetes"],"articleBody":"01 初识 Docker apt install -y docker.io service docker start usermod -aG docker ${USER} docker version docker info docker ps docker pull busybox # show all images docker images https://docs.docker.com/get-started/overview/\n02 被隔离的进程 docker pull alpine docker run -it alpine sh cat /etc/os-release 隔离资源，保证系统安全，提高资源的利用率。\n资源隔离提供了三种技术：namespace、 cgroup、chroot（pivot_rott）。\n03 容器化的应用 Build once, Run anywhere.\n应用程序不再直接和操作系统打交道，而是封装成镜像，再交给容器环境去运行。\n# remove image docker rmi busybox # 开启一个交互式操作的 Shell docker run -it busybox # 在后台运行 docker run -d busybox # 为容器起一个名字 docker run -d --name xxx busybox # 不保存容器，只要运行完毕就自动清除 docker run --rm busybox echo \"hello docker\" docker stop xxx # remove container docker rm xxx # show all container docker ps -a docker exec xxx echo \"hello docker\" 05 镜像仓库 https://github.com/docker-library/official-images https://hub.docker.com/u/library 用户名/应用名:标签 官方镜像用户名是 library。\nslim 经过精简的 fat 包含了较多的辅助工具 rc 候选版本，release candidate docker build -t docker tag ngx-app chronolaw/ngx-app:1.0 docker push chronolaw/ngx-app:1.0 save 和 load 这两个镜像归档命令：\ndocker save ngx-app:latest -o ngx.tar docker load -i ngx.tar 06 打破次元壁 docker run -d --rm --name ubu phusion/baseimage:jammy-1.0.1 echo \"hello\" \u003e a.txt # a.txt 拷贝到容器 tmp docker cp a.txt ubu:/tmp docker exec -it ubu bash # 考出容器 docker cp ubu:/tmp/a.txt ./b.txt 容器和主机共享本地目录：\n# --mount # -v /tmp:/tmp:ro 只读 docker run -d --rm -v /tmp:/tmp --name ubu phusion/baseimage:jammy-1.0.1 docker exec -it ubu bash docker pull python:alpine docker run -it --rm -v `pwd`:/tmp python:alpine sh 网络模式：null host bridge\n# host docker run -d --rm --net=host --name=ng nginx:alpine docker exec ng ip addr docker inspect ng | grep IPAddress docker stop ng # bridge 默认模式 docker run -d --rm --name=ng nginx:alpine docker inspect ng | grep IPAddress # \"IPAddress\": \"172.17.0.3\" docker run -d --rm --name=rd redis docker inspect rd | grep IPAddress # \"IPAddress\": \"172.17.0.4\" 分配服务端口号\ndocker run -d -p 80:80 --rm nginx:alpine docker run -d -p 8080:80 --rm nginx:alpine # 分别“映射”到了两个容器里的 80 端口 07 玩转 Docker Container Image Registry\nhttps://registry.hub.docker.com/_/registry/\ndocker run -d -p 5000:5000 registry # 使用 docker tag 命令给镜像打标签再上传 docker tag nginx:alpine 127.0.0.1:5000/nginx:alpine docker push 127.0.0.1:5000/nginx:alpine # 本次重新拉取测试 docker rmi 127.0.0.1:5000/nginx:alpine docker pull 127.0.0.1:5000/nginx:alpine https://docs.docker.com/registry/spec/api/\n# Listing Repositories curl 127.1:5000/v2/_catalog # {\"repositories\":[\"nginx\"]} curl 127.1:5000/v2/nginx/tags/list # {\"name\":\"nginx\",\"tags\":[\"alpine\"]} registry 默认会把镜像存储在 Docker 内部目录 /var/lib/registry。\n搭建 WordPress：\ndocker run -d --rm \\ --env MARIADB_DATABASE=db \\ --env MARIADB_USER=wp \\ --env MARIADB_PASSWORD=123 \\ --env MARIADB_ROOT_PASSWORD=123 \\ --name mariadb \\ mariadb:10 # 进入 mariadb docker exec -it mariadb mysql -uwp -p123 # show mariadb ip docker inspect mariadb | grep IPAddress # \"IPAddress\": \"172.17.0.2\" docker run -d --rm \\ --env WORDPRESS_DB_HOST=172.17.0.2 \\ --env WORDPRESS_DB_USER=wp \\ --env WORDPRESS_DB_PASSWORD=123 \\ --env WORDPRESS_DB_NAME=db \\ --name wp \\ wordpress:5 docker inspect wp | grep IPAddress # \"IPAddress\": \"172.17.0.4\" vim wp.conf server { listen 80; default_type text/html; location / { proxy_http_version 1.1; proxy_set_header Host $host; # wordpress server proxy_pass http://172.17.0.4; } } # 感觉可以直接用 wordpress 的 80，无需再代理一次 docker run -d --rm \\ -p 80:80 \\ -v `pwd`/wp.conf:/etc/nginx/conf.d/default.conf \\ --name ng \\ nginx:alpine # show logs docker logs mariadb docker logs ng docker logs wp 08 入门篇总结 docker pull alpine docker run -it alpine sh uname -a # Linux de3852b4ec42 5.15.49-linuxkit #1 SMP Tue Sep 13 07:51:46 UTC 2022 x86_64 Linux # Darwin V_YFANZHAO-MB1 19.6.0 Darwin Kernel Version 19.6.0: Tue Jun 21 21:18:39 PDT 2022; root:xnu-6153.141.66~1/RELEASE_X86_64 x86_64 构建自己的镜像：\nhttps://github.com/chronolaw/k8s_study/blob/master/ch1/Dockerfile\nARG IMAGE_BASE=\"nginx\" ARG IMAGE_TAG=\"1.21-alpine\" FROM ${IMAGE_BASE}:${IMAGE_TAG} ENV PATH=$PATH:/tmp ENV DEBUG=OFF COPY ./default.conf /etc/nginx/conf.d/ RUN cd /usr/share/nginx/html \\ \u0026\u0026 echo \"hello nginx\" \u003e a.txt EXPOSE 8081 8082 8083 WORKDIR /etc/nginx docker build -t ngx-app:1.0 . docker run -it --rm ngx-app:1.0 sh docker save ngx-app:1.0 -o ngx.tar docker load -i ngx.tar 09 Kubernetes 环境 容器编排 Container Orchestration\nKubernetes 就是一个生产级别的容器编排平台和集群管理系统。\nhttps://minikube.sigs.k8s.io/docs/start/\nminikube version # minikube version: v1.29.0 # commit: ddac20b4b34a9c8c857fc602203b6ba2679794d3 # 统一实验环境 minikube start --kubernetes-version=v1.23.3 # 查看状态 minikube status minikube node list # minikube 192.168.49.2 # 登录到这个节点上 minikube ssh uname -a # Linux minikube 5.15.49-linuxkit #1 SMP Tue Sep 13 07:51:46 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux ip add # minikube 管理 Kubernetes 集群环境 # kubectl 操作实际的 Kubernetes 功能 # install kubectl minikube kubectl minikube kubectl -- version alias kubectl=\"minikube kubectl --\" kubectl version # 启动一个镜像 kubectl run ngx --image=nginx:alpine # like docker ps kubectl get pod https://kubernetes.io/zh/\n10 Kubernetes 工作机制 Kubernetes 采用了现今流行的“控制面 / 数据面”（Control Plane / Data Plane）架构，集群里的计算机被称为“节点”（Node），可以是实机也可以是虚机，少量的节点用作控制面来执行集群的管理维护工作，其他的大部分节点都被划归数据面，用来跑业务应用。Master 节点实现管理控制功能，Worker 节点运行具体业务。\nkubectl get node # NAME STATUS ROLES AGE VERSION # minikube Ready control-plane,master 38m v1.23.3 # 查看 master Component pod kubectl get pod -n kube-system # NAME READY STATUS RESTARTS AGE # coredns-65c54cc984-4pckd 1/1 Running 0 40m # etcd-minikube 1/1 Running 0 40m # kube-apiserver-minikube 1/1 Running 0 40m # kube-controller-manager-minikube 1/1 Running 0 40m # kube-proxy-88wt2 1/1 Running 0 40m # kube-scheduler-minikube 1/1 Running 0 40m # storage-provisioner 1/1 Running 3 (6m39s ago) 40m # worker node minikube ssh # show kube-proxy docker ps |grep kube-proxy # show kubelet, not exist docker ps -ef|grep kubelet # show addons list minikube addons list minikube dashboard 11 YAML YAML 是 JSON 的超集。\nShell 脚本和 Dockerfile 可以很好地描述“命令式”（Imperative）。“声明式”（Declarative）注重结果。\napiserver 采用了 HTTP 协议的 URL 资源理念，API 风格也用 RESTful，被称为是“API 对象”了。\n# 查看 kubectl api-service 支持的所有对象 kubectl api-resources # 显示出详细的命令执行过程 kubectl get pod --v=9 # 自带的 API 文档 https://kubernetes.io/docs/reference/kubernetes-api/ kubectl explain pod kubectl explain pod.metadata # 命令式 kubectl run ngx --image=nginx:alpine # 转换为 YAML 声名式 kubectl run ngx --image=nginx:alpine --dry-run=client -o yaml \u003e ngx-pod.yml kubectl apply -f ngx-pod.yml kubectl delete -f ngx-pod.yml 12 Pod 为了解决这样多应用联合运行的问题，同时还要不破坏容器的隔离，就需要在容器外面再建立一个“收纳舱”。\napiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: ngx name: ngx spec: containers: - image: nginx:alpine name: ngx resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} vim ngx-pod.yml kubectl apply -f ngx-pod.yml kubectl logs ngx kubectl get pod kubectl describe pod ngx # cp file to pod echo 'aaa' \u003e a.txt kubectl cp a.txt ngx:/tmp # exec need -- kubectl exec -it ngx -- sh 13 Job CronJob 离线业务 “单一职责”的意思是对象应该只专注于做好一件事情，不要贪大求全，保持足够小的粒度才更方便复用和管理。\n“组合优于继承”的意思是应该尽量让对象在运行时产生联系，保持松耦合，而不要用硬编码的方式固定对象的关系。\nkubectl create job echo-job --image=busybox --dry-run=client -o yaml \u003e job.yml apiVersion: batch/v1 kind: Job metadata: creationTimestamp: null name: echo-job spec: template: metadata: creationTimestamp: null spec: containers: - image: busybox name: echo-job resources: {} # 补充输出 command: [\"/bin/echo\"] args: [\"hello\", \"world\"] restartPolicy: Never status: {} kubectl apply -f job.yml kubectl get job # NAME COMPLETIONS DURATION AGE # echo-job 1/1 16s 33s kubectl get pod # NAME READY STATUS RESTARTS AGE # echo-job-g2bf6 0/1 Completed 0 68s kubectl logs echo-job # hello world apiVersion: batch/v1 kind: Job metadata: creationTimestamp: null name: sleep-job spec: # 设置 Pod 运行的超时时间 activeDeadlineSeconds: 60 # 设置 Pod 的失败重试次数 backoffLimit: 2 # Job 完成需要运行多少个 Pod，默认是 1 completions: 4 # 它与 completions 相关，表示允许并发运行的 Pod 数量，避免过多占用资源 parallelism: 2 template: metadata: creationTimestamp: null spec: containers: - image: busybox name: echo-job resources: {} # 随机休眠 command: - sh - -c - sleep $(($RANDOM % 10 + 1)) \u0026\u0026 echo done restartPolicy: Never status: {} kubectl apply -f sleep-job.yaml kubectl get pod -w # NAME READY STATUS RESTARTS AGE # sleep-job-92m4d 0/1 Completed 0 30s # sleep-job-g8pmj 0/1 Completed 0 15s # sleep-job-tsncl 0/1 Completed 0 30s # sleep-job-x4qlp 0/1 Completed 0 15s # cronjob kubectl create cj echo-cj --image=busybox --schedule=\"*/1 * * * *\" --dry-run=client -o yaml \u003e echo-cj.yaml apiVersion: batch/v1 kind: CronJob metadata: creationTimestamp: null name: echo-cj spec: jobTemplate: metadata: creationTimestamp: null name: echo-cj spec: template: metadata: creationTimestamp: null spec: containers: - image: busybox name: echo-cj resources: {} # 补充输出 command: [\"/bin/echo\"] args: [\"hello\", \"world\"] restartPolicy: OnFailure schedule: \"*/1 * * * *\" status: {} kubectl apply -f echo-cj.yaml kubectl get cj # NAME SCHEDULE SUSPEND ACTIVE LAST SCHEDULE AGE # echo-cj */1 * * * * False 1 5s 8s kubectl get pod # NAME READY STATUS RESTARTS AGE # echo-cj-27942326-qng4j 0/1 Completed 0 93s # echo-cj-27942327-vlrvs 0/1 Completed 0 33s 14 ConfigMap Secret 管理配置信息 kubectl create cm info --from-literal=name=zhao --dry-run=client -o yaml \u003e cm.yml kubectl apply -f cm.yml kubectl get cm kubectl describe cm info kubectl create secret generic user --from-literal=name=root --dry-run=client -o yaml \u003e secret.yml # -n 去掉字符串里隐含的换行符 echo -n \"root\" | base64 kubectl apply -f secret.yml kubectl get secret kubectl describe secret user kubectl explain pod.spec.containers.env.valueFrom apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: ngx name: ngx spec: containers: - image: nginx:alpine name: ngx resources: {} env: - name: NAME valueFrom: configMapKeyRef: name: info key: name - name: SNAME valueFrom: secretKeyRef: name: user key: name dnsPolicy: ClusterFirst restartPolicy: Always status: {} kubectl apply -f env-pod.yml kubectl exec -it ngx -- sh echo $NAME $SNAME # 以 Volume 的方式使用 ConfigMap/Secret apiVersion: v1 kind: Pod metadata: name: vol-pod spec: # Volume 属于 Pod 与 containers 同级 volumes: - name: cm-vol configMap: name: info - name: sec-vol secret: secretName: user containers: # 挂载到容器里的某个路径下 - volumeMounts: - mountPath: /tmp/cm-items name: cm-vol - mountPath: /tmp/sec-items name: sec-vol image: nginx:alpine name: ngx resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} vim vol-pod.yml kubectl apply -f vol-pod.yml kubectl get pod kubectl exec -it vol-pod -- sh cat /tmp/cm-items/name cat /tmp/sec-items/name # ConfigMap 和 Secret 都变成了目录的形式，而它们里面的 Key-Value 变成了一个个的文件，而文件名就是 Key。 15 玩转 Kubernetes 搭建 WordPress 环境：\n# vim mariadb-pod.yml apiVersion: v1 kind: ConfigMap metadata: name: maria-cm data: DATABASE: \"db\" USER: \"wp\" PASSWORD: \"123\" ROOT_PASSWORD: \"123\" --- apiVersion: v1 kind: Pod metadata: name: maria-pod labels: app: wordpress role: database spec: containers: - image: mariadb:10 name: maria imagePullPolicy: IfNotPresent ports: - containerPort: 3306 envFrom: - prefix: \"MARIADB_\" configMapRef: name: maria-cm kubectl apply -f mariadb-pod.yml # 获取 IP 地址需要加上参数 -o wide kubectl get pod -o wide # NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES # maria-pod 1/1 Running 0 64s 172.17.0.5 minikube # vim wp-pod.yml apiVersion: v1 kind: ConfigMap metadata: name: wp-cm data: # MariaDB Pod 的 IP HOST: \"172.17.0.5\" USER: \"wp\" PASSWORD: \"123\" NAME: \"db\" --- apiVersion: v1 kind: Pod metadata: name: wp-pod labels: app: wordpress role: website spec: containers: - image: wordpress:5 name: wp-pod imagePullPolicy: IfNotPresent ports: - containerPort: 80 envFrom: - prefix: \"WORDPRESS_DB_\" configMapRef: name: wp-cm kubectl apply -f wp-pod.yml kubectl get pod -o wide # NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES # maria-pod 1/1 Running 0 160m 172.17.0.5 minikube # wp-pod 1/1 Running 0 2m47s 172.17.0.6 minikube # 本地的 “8080” 映射到 WordPress Pod 的“80” kubectl port-forward wp-pod 8080:80 \u0026 # Forwarding from 127.0.0.1:8080 -\u003e 80 # Forwarding from [::1]:8080 -\u003e 80 # fg 16 初级篇总结 minikube version minikube status minikube start --kubernetes-version=v1.23.3 minikube node list kubectl version kubectl run ngx --image=nginx:alpine # apiserver 等核心组件是在 kube-system 名字空间 kubectl get pod -n kube-system kubectl api-resources kubectl explain pod.metadata export out=\"--dry-run=client -o yaml\" kubectl run ngx --image=nginx:alpine $out \u003e pod.yml kubectl apply -f ngx-pod.yml kubectl get pod kubectl logs ngx-pod kubectl exec -it ngx-pod -- sh kubectl delete -f ngx-pod kubectl create job echo-job --image=busybox $out kubectl apply -f job.yml kubectl get job kubectl get pod kubectl logs echo-job-l52l7 kubectl create cj echo-cj --image=busybox --schedule=\"* * * * *\" $out kubectl apply -f cronjob.yml kubectl get cj kubectl get pod kubectl create cm info --from-literal=k=v $out kubectl get cm kubectl describe cm info kubectl create secret generic user --from-literal=name=root $out kubectl get secret kubectl describe secret user echo cm9vdA== | base64 -d References chronolaw/k8s_study | GitHub – EOF –\n","wordCount":"1790","inLanguage":"en","image":"https://images.unsplash.com/photo-1451337516015-6b6e9a44a8a3?ixlib=rb-4.0.3\u0026ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8\u0026auto=format\u0026fit=crop\u0026w=960\u0026q=80","datePublished":"2023-02-15T14:46:38+08:00","dateModified":"2023-02-15T14:46:38+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zyf.im/2023/02/15/kubernetes-getting-started-part1/"},"publisher":{"@type":"Organization","name":"ZYF.IM BLOG","logo":{"@type":"ImageObject","url":"https://zyf.im/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://zyf.im/ accesskey=h title="ZYF.IM (Alt + H)"><img src=https://zyf.im/apple-touch-icon.png alt aria-label=logo height=35>ZYF.IM</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zyf.im/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://zyf.im/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zyf.im/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://zyf.im/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zyf.im/>Home</a>&nbsp;»&nbsp;<a href=https://zyf.im/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Kubernetes 入门实战 Part1</h1><div class=post-meta><span title='2023-02-15 14:46:38 +0800 CST'>February 15, 2023</span>&nbsp;·&nbsp;<span>9 min</span>&nbsp;·&nbsp;<span>1790 words</span>&nbsp;·&nbsp;<span>Me</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#01-初识-docker>01 初识 Docker</a></li><li><a href=#02-被隔离的进程>02 被隔离的进程</a></li><li><a href=#03-容器化的应用>03 容器化的应用</a></li><li><a href=#05-镜像仓库>05 镜像仓库</a></li><li><a href=#06-打破次元壁>06 打破次元壁</a></li><li><a href=#07-玩转-docker>07 玩转 Docker</a></li><li><a href=#08-入门篇总结>08 入门篇总结</a></li><li><a href=#09-kubernetes-环境>09 Kubernetes 环境</a></li><li><a href=#10-kubernetes-工作机制>10 Kubernetes 工作机制</a></li><li><a href=#11-yaml>11 YAML</a></li><li><a href=#12-pod>12 Pod</a></li><li><a href=#13-job-cronjob-离线业务>13 Job CronJob 离线业务</a></li><li><a href=#14-configmap-secret-管理配置信息>14 ConfigMap Secret 管理配置信息</a></li><li><a href=#15-玩转-kubernetes>15 玩转 Kubernetes</a></li><li><a href=#16-初级篇总结>16 初级篇总结</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=01-初识-docker>01 初识 Docker<a hidden class=anchor aria-hidden=true href=#01-初识-docker>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt install -y docker.io
</span></span><span class=line><span class=cl>service docker start
</span></span><span class=line><span class=cl>usermod -aG docker <span class=si>${</span><span class=nv>USER</span><span class=si>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker version
</span></span><span class=line><span class=cl>docker info
</span></span><span class=line><span class=cl>docker ps
</span></span><span class=line><span class=cl>docker pull busybox
</span></span><span class=line><span class=cl><span class=c1># show all images</span>
</span></span><span class=line><span class=cl>docker images
</span></span></code></pre></div><p><a href=https://docs.docker.com/get-started/overview/>https://docs.docker.com/get-started/overview/</a></p><h2 id=02-被隔离的进程>02 被隔离的进程<a hidden class=anchor aria-hidden=true href=#02-被隔离的进程>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker pull alpine
</span></span><span class=line><span class=cl>docker run -it alpine sh
</span></span><span class=line><span class=cl>cat /etc/os-release
</span></span></code></pre></div><p>隔离资源，保证系统安全，提高资源的利用率。</p><p>资源隔离提供了三种技术：namespace、 cgroup、chroot（pivot_rott）。</p><h2 id=03-容器化的应用>03 容器化的应用<a hidden class=anchor aria-hidden=true href=#03-容器化的应用>#</a></h2><p>Build once, Run anywhere.</p><p>应用程序不再直接和操作系统打交道，而是封装成镜像，再交给容器环境去运行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># remove image</span>
</span></span><span class=line><span class=cl>docker rmi busybox
</span></span><span class=line><span class=cl><span class=c1># 开启一个交互式操作的 Shell</span>
</span></span><span class=line><span class=cl>docker run -it busybox
</span></span><span class=line><span class=cl><span class=c1># 在后台运行</span>
</span></span><span class=line><span class=cl>docker run -d busybox
</span></span><span class=line><span class=cl><span class=c1># 为容器起一个名字</span>
</span></span><span class=line><span class=cl>docker run -d --name xxx busybox
</span></span><span class=line><span class=cl><span class=c1># 不保存容器，只要运行完毕就自动清除</span>
</span></span><span class=line><span class=cl>docker run --rm busybox <span class=nb>echo</span> <span class=s2>&#34;hello docker&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker stop xxx
</span></span><span class=line><span class=cl><span class=c1># remove container</span>
</span></span><span class=line><span class=cl>docker rm xxx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># show all container</span>
</span></span><span class=line><span class=cl>docker ps -a
</span></span><span class=line><span class=cl>docker <span class=nb>exec</span> xxx <span class=nb>echo</span> <span class=s2>&#34;hello docker&#34;</span>
</span></span></code></pre></div><h2 id=05-镜像仓库>05 镜像仓库<a hidden class=anchor aria-hidden=true href=#05-镜像仓库>#</a></h2><ul><li><a href=https://github.com/docker-library/official-images>https://github.com/docker-library/official-images</a></li><li><a href=https://hub.docker.com/u/library>https://hub.docker.com/u/library</a></li></ul><p><code>用户名/应用名:标签</code> 官方镜像用户名是 <code>library</code>。</p><ul><li>slim 经过精简的</li><li>fat 包含了较多的辅助工具</li><li>rc 候选版本，release candidate</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t
</span></span><span class=line><span class=cl>docker tag ngx-app chronolaw/ngx-app:1.0
</span></span><span class=line><span class=cl>docker push chronolaw/ngx-app:1.0
</span></span></code></pre></div><p>save 和 load 这两个镜像归档命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker save ngx-app:latest -o ngx.tar
</span></span><span class=line><span class=cl>docker load -i ngx.tar
</span></span></code></pre></div><h2 id=06-打破次元壁>06 打破次元壁<a hidden class=anchor aria-hidden=true href=#06-打破次元壁>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d --rm --name ubu phusion/baseimage:jammy-1.0.1
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;hello&#34;</span> &gt; a.txt
</span></span><span class=line><span class=cl><span class=c1># a.txt 拷贝到容器 tmp</span>
</span></span><span class=line><span class=cl>docker cp a.txt ubu:/tmp
</span></span><span class=line><span class=cl>docker <span class=nb>exec</span> -it ubu bash
</span></span><span class=line><span class=cl><span class=c1># 考出容器</span>
</span></span><span class=line><span class=cl>docker cp ubu:/tmp/a.txt ./b.txt
</span></span></code></pre></div><p>容器和主机共享本地目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># --mount</span>
</span></span><span class=line><span class=cl><span class=c1># -v /tmp:/tmp:ro 只读</span>
</span></span><span class=line><span class=cl>docker run -d --rm -v /tmp:/tmp --name ubu phusion/baseimage:jammy-1.0.1
</span></span><span class=line><span class=cl>docker <span class=nb>exec</span> -it ubu bash
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker pull python:alpine
</span></span><span class=line><span class=cl>docker run -it --rm -v <span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>:/tmp python:alpine sh
</span></span></code></pre></div><p>网络模式：<code>null</code> <code>host</code> <code>bridge</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># host</span>
</span></span><span class=line><span class=cl>docker run -d --rm --net<span class=o>=</span>host --name<span class=o>=</span>ng nginx:alpine
</span></span><span class=line><span class=cl>docker <span class=nb>exec</span> ng ip addr
</span></span><span class=line><span class=cl>docker inspect ng <span class=p>|</span> grep IPAddress
</span></span><span class=line><span class=cl>docker stop ng
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># bridge 默认模式</span>
</span></span><span class=line><span class=cl>docker run -d --rm --name<span class=o>=</span>ng nginx:alpine
</span></span><span class=line><span class=cl>docker inspect ng <span class=p>|</span> grep IPAddress
</span></span><span class=line><span class=cl><span class=c1># &#34;IPAddress&#34;: &#34;172.17.0.3&#34;</span>
</span></span><span class=line><span class=cl>docker run -d --rm --name<span class=o>=</span>rd redis
</span></span><span class=line><span class=cl>docker inspect rd <span class=p>|</span> grep IPAddress
</span></span><span class=line><span class=cl><span class=c1># &#34;IPAddress&#34;: &#34;172.17.0.4&#34;</span>
</span></span></code></pre></div><p>分配服务端口号</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -p 80:80 --rm nginx:alpine
</span></span><span class=line><span class=cl>docker run -d -p 8080:80 --rm nginx:alpine
</span></span><span class=line><span class=cl><span class=c1># 分别“映射”到了两个容器里的 80 端口</span>
</span></span></code></pre></div><h2 id=07-玩转-docker>07 玩转 Docker<a hidden class=anchor aria-hidden=true href=#07-玩转-docker>#</a></h2><p>Container Image Registry</p><p><a href=https://registry.hub.docker.com/_/registry/>https://registry.hub.docker.com/_/registry/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -p 5000:5000 registry
</span></span><span class=line><span class=cl><span class=c1># 使用 docker tag 命令给镜像打标签再上传</span>
</span></span><span class=line><span class=cl>docker tag nginx:alpine 127.0.0.1:5000/nginx:alpine
</span></span><span class=line><span class=cl>docker push 127.0.0.1:5000/nginx:alpine
</span></span><span class=line><span class=cl><span class=c1># 本次重新拉取测试</span>
</span></span><span class=line><span class=cl>docker rmi 127.0.0.1:5000/nginx:alpine
</span></span><span class=line><span class=cl>docker pull 127.0.0.1:5000/nginx:alpine
</span></span></code></pre></div><p><a href=https://docs.docker.com/registry/spec/api/>https://docs.docker.com/registry/spec/api/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Listing Repositories</span>
</span></span><span class=line><span class=cl>curl 127.1:5000/v2/_catalog
</span></span><span class=line><span class=cl><span class=c1># {&#34;repositories&#34;:[&#34;nginx&#34;]}</span>
</span></span><span class=line><span class=cl>curl 127.1:5000/v2/nginx/tags/list
</span></span><span class=line><span class=cl><span class=c1># {&#34;name&#34;:&#34;nginx&#34;,&#34;tags&#34;:[&#34;alpine&#34;]}</span>
</span></span></code></pre></div><p>registry 默认会把镜像存储在 Docker 内部目录 <code>/var/lib/registry</code>。</p><p>搭建 WordPress：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d --rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>MARIADB_DATABASE</span><span class=o>=</span>db <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>MARIADB_USER</span><span class=o>=</span>wp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>MARIADB_PASSWORD</span><span class=o>=</span><span class=m>123</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>MARIADB_ROOT_PASSWORD</span><span class=o>=</span><span class=m>123</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name mariadb <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    mariadb:10
</span></span><span class=line><span class=cl><span class=c1># 进入 mariadb</span>
</span></span><span class=line><span class=cl>docker <span class=nb>exec</span> -it mariadb mysql -uwp -p123
</span></span><span class=line><span class=cl><span class=c1># show mariadb ip</span>
</span></span><span class=line><span class=cl>docker inspect mariadb <span class=p>|</span> grep IPAddress
</span></span><span class=line><span class=cl><span class=c1># &#34;IPAddress&#34;: &#34;172.17.0.2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker run -d --rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>WORDPRESS_DB_HOST</span><span class=o>=</span>172.17.0.2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>WORDPRESS_DB_USER</span><span class=o>=</span>wp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>WORDPRESS_DB_PASSWORD</span><span class=o>=</span><span class=m>123</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>WORDPRESS_DB_NAME</span><span class=o>=</span>db <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name wp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    wordpress:5
</span></span><span class=line><span class=cl>docker inspect wp <span class=p>|</span> grep IPAddress
</span></span><span class=line><span class=cl><span class=c1># &#34;IPAddress&#34;: &#34;172.17.0.4&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim wp.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>  default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>  location / <span class=o>{</span>
</span></span><span class=line><span class=cl>      proxy_http_version 1.1<span class=p>;</span>
</span></span><span class=line><span class=cl>      proxy_set_header Host <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1># wordpress server</span>
</span></span><span class=line><span class=cl>      proxy_pass http://172.17.0.4<span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 感觉可以直接用 wordpress 的 80，无需再代理一次</span>
</span></span><span class=line><span class=cl>docker run -d --rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -p 80:80 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v <span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>/wp.conf:/etc/nginx/conf.d/default.conf <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name ng <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    nginx:alpine
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># show logs</span>
</span></span><span class=line><span class=cl>docker logs mariadb
</span></span><span class=line><span class=cl>docker logs ng
</span></span><span class=line><span class=cl>docker logs wp
</span></span></code></pre></div><h2 id=08-入门篇总结>08 入门篇总结<a hidden class=anchor aria-hidden=true href=#08-入门篇总结>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker pull alpine
</span></span><span class=line><span class=cl>docker run -it alpine sh
</span></span><span class=line><span class=cl>uname -a
</span></span><span class=line><span class=cl><span class=c1># Linux de3852b4ec42 5.15.49-linuxkit #1 SMP Tue Sep 13 07:51:46 UTC 2022 x86_64 Linux</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Darwin V_YFANZHAO-MB1 19.6.0 Darwin Kernel Version 19.6.0: Tue Jun 21 21:18:39 PDT 2022; root:xnu-6153.141.66~1/RELEASE_X86_64 x86_64</span>
</span></span></code></pre></div><p>构建自己的镜像：</p><p><a href=https://github.com/chronolaw/k8s_study/blob/master/ch1/Dockerfile>https://github.com/chronolaw/k8s_study/blob/master/ch1/Dockerfile</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>IMAGE_BASE</span><span class=o>=</span><span class=s2>&#34;nginx&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>IMAGE_TAG</span><span class=o>=</span><span class=s2>&#34;1.21-alpine&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=w> </span><span class=s>${IMAGE_BASE}:${IMAGE_TAG</span><span class=o>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:/tmp<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>DEBUG</span><span class=o>=</span>OFF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>COPY</span> ./default.conf /etc/nginx/conf.d/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nb>cd</span> /usr/share/nginx/html <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;hello nginx&#34;</span> &gt; a.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=w> </span><span class=s>8081</span> <span class=m>8082</span> <span class=m>8083</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=w> </span><span class=s>/etc/nginx</span><span class=err>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t ngx-app:1.0 .
</span></span><span class=line><span class=cl>docker run -it --rm ngx-app:1.0 sh
</span></span><span class=line><span class=cl>docker save ngx-app:1.0 -o ngx.tar
</span></span><span class=line><span class=cl>docker load -i ngx.tar
</span></span></code></pre></div><h2 id=09-kubernetes-环境>09 Kubernetes 环境<a hidden class=anchor aria-hidden=true href=#09-kubernetes-环境>#</a></h2><p>容器编排 Container Orchestration</p><p>Kubernetes 就是一个生产级别的容器编排平台和集群管理系统。</p><p><a href=https://minikube.sigs.k8s.io/docs/start/>https://minikube.sigs.k8s.io/docs/start/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>minikube version
</span></span><span class=line><span class=cl><span class=c1># minikube version: v1.29.0</span>
</span></span><span class=line><span class=cl><span class=c1># commit: ddac20b4b34a9c8c857fc602203b6ba2679794d3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 统一实验环境</span>
</span></span><span class=line><span class=cl>minikube start --kubernetes-version<span class=o>=</span>v1.23.3
</span></span><span class=line><span class=cl><span class=c1># 查看状态</span>
</span></span><span class=line><span class=cl>minikube status
</span></span><span class=line><span class=cl>minikube node list
</span></span><span class=line><span class=cl><span class=c1># minikube 192.168.49.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 登录到这个节点上</span>
</span></span><span class=line><span class=cl>minikube ssh
</span></span><span class=line><span class=cl>uname -a
</span></span><span class=line><span class=cl><span class=c1># Linux minikube 5.15.49-linuxkit #1 SMP Tue Sep 13 07:51:46 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>
</span></span><span class=line><span class=cl>ip add
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># minikube 管理 Kubernetes 集群环境</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl 操作实际的 Kubernetes 功能</span>
</span></span><span class=line><span class=cl><span class=c1># install kubectl</span>
</span></span><span class=line><span class=cl>minikube kubectl
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>minikube kubectl -- version
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kubectl</span><span class=o>=</span><span class=s2>&#34;minikube kubectl --&#34;</span>
</span></span><span class=line><span class=cl>kubectl version
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动一个镜像</span>
</span></span><span class=line><span class=cl>kubectl run ngx --image<span class=o>=</span>nginx:alpine
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># like docker ps</span>
</span></span><span class=line><span class=cl>kubectl get pod
</span></span></code></pre></div><p><a href=https://kubernetes.io/zh/>https://kubernetes.io/zh/</a></p><h2 id=10-kubernetes-工作机制>10 Kubernetes 工作机制<a hidden class=anchor aria-hidden=true href=#10-kubernetes-工作机制>#</a></h2><p>Kubernetes 采用了现今流行的“控制面 / 数据面”（Control Plane / Data Plane）架构，集群里的计算机被称为“节点”（Node），可以是实机也可以是虚机，少量的节点用作控制面来执行集群的管理维护工作，其他的大部分节点都被划归数据面，用来跑业务应用。Master 节点实现管理控制功能，Worker 节点运行具体业务。</p><img width=600 alt=image src=https://user-images.githubusercontent.com/9289792/219293821-a4e1620a-c024-4edf-ba29-a5bc1f8d3f57.png><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get node
</span></span><span class=line><span class=cl><span class=c1># NAME       STATUS   ROLES                  AGE   VERSION</span>
</span></span><span class=line><span class=cl><span class=c1># minikube   Ready    control-plane,master   38m   v1.23.3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 master Component pod</span>
</span></span><span class=line><span class=cl>kubectl get pod -n kube-system
</span></span><span class=line><span class=cl><span class=c1># NAME                               READY   STATUS    RESTARTS        AGE</span>
</span></span><span class=line><span class=cl><span class=c1># coredns-65c54cc984-4pckd           1/1     Running   0               40m</span>
</span></span><span class=line><span class=cl><span class=c1># etcd-minikube                      1/1     Running   0               40m</span>
</span></span><span class=line><span class=cl><span class=c1># kube-apiserver-minikube            1/1     Running   0               40m</span>
</span></span><span class=line><span class=cl><span class=c1># kube-controller-manager-minikube   1/1     Running   0               40m</span>
</span></span><span class=line><span class=cl><span class=c1># kube-proxy-88wt2                   1/1     Running   0               40m</span>
</span></span><span class=line><span class=cl><span class=c1># kube-scheduler-minikube            1/1     Running   0               40m</span>
</span></span><span class=line><span class=cl><span class=c1># storage-provisioner                1/1     Running   3 (6m39s ago)   40m</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># worker node</span>
</span></span><span class=line><span class=cl>minikube ssh
</span></span><span class=line><span class=cl><span class=c1># show kube-proxy</span>
</span></span><span class=line><span class=cl>docker ps <span class=p>|</span>grep kube-proxy
</span></span><span class=line><span class=cl><span class=c1># show kubelet, not exist docker</span>
</span></span><span class=line><span class=cl>ps -ef<span class=p>|</span>grep kubelet
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># show addons list</span>
</span></span><span class=line><span class=cl>minikube addons list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>minikube dashboard
</span></span></code></pre></div><img width=600 alt=image src=https://user-images.githubusercontent.com/9289792/219294564-12655273-044c-4d56-a99a-d6f6e7cf7525.png><h2 id=11-yaml>11 YAML<a hidden class=anchor aria-hidden=true href=#11-yaml>#</a></h2><p>YAML 是 JSON 的超集。</p><p>Shell 脚本和 Dockerfile 可以很好地描述“命令式”（Imperative）。“声明式”（Declarative）注重结果。</p><p>apiserver 采用了 HTTP 协议的 URL 资源理念，API 风格也用 RESTful，被称为是“API 对象”了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看 kubectl api-service 支持的所有对象</span>
</span></span><span class=line><span class=cl>kubectl api-resources
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示出详细的命令执行过程</span>
</span></span><span class=line><span class=cl>kubectl get pod --v<span class=o>=</span><span class=m>9</span>
</span></span><span class=line><span class=cl><span class=c1># 自带的 API 文档 https://kubernetes.io/docs/reference/kubernetes-api/</span>
</span></span><span class=line><span class=cl>kubectl explain pod
</span></span><span class=line><span class=cl>kubectl explain pod.metadata
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 命令式</span>
</span></span><span class=line><span class=cl>kubectl run ngx --image<span class=o>=</span>nginx:alpine
</span></span><span class=line><span class=cl><span class=c1># 转换为 YAML 声名式</span>
</span></span><span class=line><span class=cl>kubectl run ngx --image<span class=o>=</span>nginx:alpine --dry-run<span class=o>=</span>client -o yaml &gt; ngx-pod.yml
</span></span><span class=line><span class=cl>kubectl apply -f ngx-pod.yml
</span></span><span class=line><span class=cl>kubectl delete -f ngx-pod.yml
</span></span></code></pre></div><h2 id=12-pod>12 Pod<a hidden class=anchor aria-hidden=true href=#12-pod>#</a></h2><p>为了解决这样多应用联合运行的问题，同时还要不破坏容器的隔离，就需要在容器外面再建立一个“收纳舱”。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>ngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>ClusterFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><img width=600 alt=image src=https://user-images.githubusercontent.com/9289792/219309091-7436a44b-c0e4-4e8f-8dc1-7a208122ae7d.png><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim ngx-pod.yml
</span></span><span class=line><span class=cl>kubectl apply -f ngx-pod.yml
</span></span><span class=line><span class=cl>kubectl logs ngx
</span></span><span class=line><span class=cl>kubectl get pod
</span></span><span class=line><span class=cl>kubectl describe pod ngx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cp file to pod</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;aaa&#39;</span> &gt; a.txt
</span></span><span class=line><span class=cl>kubectl cp a.txt ngx:/tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># exec need --</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it ngx -- sh
</span></span></code></pre></div><h2 id=13-job-cronjob-离线业务>13 Job CronJob 离线业务<a hidden class=anchor aria-hidden=true href=#13-job-cronjob-离线业务>#</a></h2><p>“单一职责”的意思是对象应该只专注于做好一件事情，不要贪大求全，保持足够小的粒度才更方便复用和管理。</p><p>“组合优于继承”的意思是应该尽量让对象在运行时产生联系，保持松耦合，而不要用硬编码的方式固定对象的关系。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create job echo-job --image<span class=o>=</span>busybox --dry-run<span class=o>=</span>client -o yaml &gt; job.yml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>echo-job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>echo-job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 补充输出</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/echo&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;hello&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;world&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f job.yml
</span></span><span class=line><span class=cl>kubectl get job
</span></span><span class=line><span class=cl><span class=c1># NAME       COMPLETIONS   DURATION   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># echo-job   1/1           16s        33s</span>
</span></span><span class=line><span class=cl>kubectl get pod
</span></span><span class=line><span class=cl><span class=c1># NAME             READY   STATUS      RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># echo-job-g2bf6   0/1     Completed   0          68s</span>
</span></span><span class=line><span class=cl>kubectl logs echo-job
</span></span><span class=line><span class=cl><span class=c1># hello world</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sleep-job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 设置 Pod 运行的超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>activeDeadlineSeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 设置 Pod 的失败重试次数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>backoffLimit</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Job 完成需要运行多少个 Pod，默认是 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>completions</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 它与 completions 相关，表示允许并发运行的 Pod 数量，避免过多占用资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>parallelism</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>echo-job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 随机休眠</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>sleep $(($RANDOM % 10 + 1)) &amp;&amp; echo done</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f sleep-job.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get pod -w
</span></span><span class=line><span class=cl><span class=c1># NAME              READY   STATUS      RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># sleep-job-92m4d   0/1     Completed   0          30s</span>
</span></span><span class=line><span class=cl><span class=c1># sleep-job-g8pmj   0/1     Completed   0          15s</span>
</span></span><span class=line><span class=cl><span class=c1># sleep-job-tsncl   0/1     Completed   0          30s</span>
</span></span><span class=line><span class=cl><span class=c1># sleep-job-x4qlp   0/1     Completed   0          15s</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cronjob</span>
</span></span><span class=line><span class=cl>kubectl create cj echo-cj --image<span class=o>=</span>busybox --schedule<span class=o>=</span><span class=s2>&#34;*/1 * * * *&#34;</span> --dry-run<span class=o>=</span>client -o yaml &gt; echo-cj.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>echo-cj</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>echo-cj</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>echo-cj</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># 补充输出</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/echo&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;hello&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;world&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*/1 * * * *&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f echo-cj.yaml
</span></span><span class=line><span class=cl>kubectl get cj
</span></span><span class=line><span class=cl><span class=c1># NAME      SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># echo-cj   */1 * * * *   False     1        5s              8s</span>
</span></span><span class=line><span class=cl>kubectl get pod
</span></span><span class=line><span class=cl><span class=c1># NAME                     READY   STATUS      RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># echo-cj-27942326-qng4j   0/1     Completed   0          93s</span>
</span></span><span class=line><span class=cl><span class=c1># echo-cj-27942327-vlrvs   0/1     Completed   0          33s</span>
</span></span></code></pre></div><h2 id=14-configmap-secret-管理配置信息>14 ConfigMap Secret 管理配置信息<a hidden class=anchor aria-hidden=true href=#14-configmap-secret-管理配置信息>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create cm info --from-literal<span class=o>=</span><span class=nv>name</span><span class=o>=</span>zhao --dry-run<span class=o>=</span>client -o yaml &gt; cm.yml
</span></span><span class=line><span class=cl>kubectl apply -f cm.yml
</span></span><span class=line><span class=cl>kubectl get cm
</span></span><span class=line><span class=cl>kubectl describe cm info
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create secret generic user --from-literal<span class=o>=</span><span class=nv>name</span><span class=o>=</span>root --dry-run<span class=o>=</span>client -o yaml &gt; secret.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -n 去掉字符串里隐含的换行符</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;root&#34;</span> <span class=p>|</span> base64
</span></span><span class=line><span class=cl>kubectl apply -f secret.yml
</span></span><span class=line><span class=cl>kubectl get secret
</span></span><span class=line><span class=cl>kubectl describe secret user
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl explain pod.spec.containers.env.valueFrom
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>ngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>ClusterFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f env-pod.yml
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it ngx -- sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$NAME</span> <span class=nv>$SNAME</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 以 Volume 的方式使用 ConfigMap/Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>vol-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Volume 属于 Pod 与 containers 同级</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cm-vol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sec-vol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 挂载到容器里的某个路径下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/cm-items</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cm-vol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/sec-items</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sec-vol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>ClusterFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim vol-pod.yml
</span></span><span class=line><span class=cl>kubectl apply -f vol-pod.yml
</span></span><span class=line><span class=cl>kubectl get pod
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it vol-pod -- sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat /tmp/cm-items/name
</span></span><span class=line><span class=cl>cat /tmp/sec-items/name
</span></span><span class=line><span class=cl><span class=c1># ConfigMap 和 Secret 都变成了目录的形式，而它们里面的 Key-Value 变成了一个个的文件，而文件名就是 Key。</span>
</span></span></code></pre></div><h2 id=15-玩转-kubernetes>15 玩转 Kubernetes<a hidden class=anchor aria-hidden=true href=#15-玩转-kubernetes>#</a></h2><img width=600 alt=image src=https://user-images.githubusercontent.com/9289792/219537942-31e778eb-888d-4331-8d65-03ae4095b003.png><p>搭建 WordPress 环境：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># vim mariadb-pod.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>maria-cm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DATABASE</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;db&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>USER</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;wp&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>PASSWORD</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ROOT_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>maria-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>wordpress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mariadb:10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>maria</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;MARIADB_&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>configMapRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>maria-cm</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f mariadb-pod.yml
</span></span><span class=line><span class=cl><span class=c1># 获取 IP 地址需要加上参数 -o wide</span>
</span></span><span class=line><span class=cl>kubectl get pod -o wide
</span></span><span class=line><span class=cl><span class=c1># NAME        READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES</span>
</span></span><span class=line><span class=cl><span class=c1># maria-pod   1/1     Running   0          64s   172.17.0.5   minikube   &lt;none&gt;           &lt;none&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># vim wp-pod.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>wp-cm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># MariaDB Pod 的 IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>HOST</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;172.17.0.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>USER</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;wp&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>PASSWORD</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;123&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>NAME</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;db&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>wp-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>wordpress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>website</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>wordpress:5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>wp-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;WORDPRESS_DB_&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>configMapRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>wp-cm</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f wp-pod.yml
</span></span><span class=line><span class=cl>kubectl get pod -o wide
</span></span><span class=line><span class=cl><span class=c1># NAME        READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES</span>
</span></span><span class=line><span class=cl><span class=c1># maria-pod   1/1     Running   0          160m    172.17.0.5   minikube   &lt;none&gt;           &lt;none&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># wp-pod      1/1     Running   0          2m47s   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 本地的 “8080” 映射到 WordPress Pod 的“80”</span>
</span></span><span class=line><span class=cl>kubectl port-forward wp-pod 8080:80 <span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=c1># Forwarding from 127.0.0.1:8080 -&gt; 80</span>
</span></span><span class=line><span class=cl><span class=c1># Forwarding from [::1]:8080 -&gt; 80</span>
</span></span><span class=line><span class=cl><span class=c1># fg</span>
</span></span></code></pre></div><h2 id=16-初级篇总结>16 初级篇总结<a hidden class=anchor aria-hidden=true href=#16-初级篇总结>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>minikube version
</span></span><span class=line><span class=cl>minikube status
</span></span><span class=line><span class=cl>minikube start --kubernetes-version<span class=o>=</span>v1.23.3
</span></span><span class=line><span class=cl>minikube node list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl version
</span></span><span class=line><span class=cl>kubectl run ngx --image<span class=o>=</span>nginx:alpine
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># apiserver 等核心组件是在 kube-system 名字空间</span>
</span></span><span class=line><span class=cl>kubectl get pod -n kube-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl api-resources
</span></span><span class=line><span class=cl>kubectl explain pod.metadata
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>out</span><span class=o>=</span><span class=s2>&#34;--dry-run=client -o yaml&#34;</span>
</span></span><span class=line><span class=cl>kubectl run ngx --image<span class=o>=</span>nginx:alpine <span class=nv>$out</span> &gt; pod.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f ngx-pod.yml
</span></span><span class=line><span class=cl>kubectl get pod
</span></span><span class=line><span class=cl>kubectl logs ngx-pod
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it ngx-pod -- sh
</span></span><span class=line><span class=cl>kubectl delete -f ngx-pod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl create job echo-job --image<span class=o>=</span>busybox <span class=nv>$out</span>
</span></span><span class=line><span class=cl>kubectl apply -f job.yml
</span></span><span class=line><span class=cl>kubectl get job
</span></span><span class=line><span class=cl>kubectl get pod
</span></span><span class=line><span class=cl>kubectl logs echo-job-l52l7
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl create cj echo-cj --image<span class=o>=</span>busybox --schedule<span class=o>=</span><span class=s2>&#34;* * * * *&#34;</span> <span class=nv>$out</span>
</span></span><span class=line><span class=cl>kubectl apply -f cronjob.yml
</span></span><span class=line><span class=cl>kubectl get cj
</span></span><span class=line><span class=cl>kubectl get pod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl create cm info --from-literal<span class=o>=</span><span class=nv>k</span><span class=o>=</span>v <span class=nv>$out</span>
</span></span><span class=line><span class=cl>kubectl get cm
</span></span><span class=line><span class=cl>kubectl describe cm info
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl create secret generic user --from-literal<span class=o>=</span><span class=nv>name</span><span class=o>=</span>root <span class=nv>$out</span>
</span></span><span class=line><span class=cl>kubectl get secret
</span></span><span class=line><span class=cl>kubectl describe secret user
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>cm9vdA</span><span class=o>==</span> <span class=p>|</span> base64 -d
</span></span></code></pre></div><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://github.com/chronolaw/k8s_study>chronolaw/k8s_study | GitHub</a></li></ul><p>&ndash; EOF &ndash;</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zyf.im/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://zyf.im/2023/02/22/kubernetes-getting-started-part2/><span class=title>« Prev</span><br><span>Kubernetes 入门实战 Part2</span>
</a><a class=next href=https://zyf.im/2023/02/01/go-language-lesson-one/><span class=title>Next »</span><br><span>Go 语言第一课</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://zyf.im/>ZYF.IM BLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>