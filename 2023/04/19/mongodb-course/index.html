<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>MongoDB 高手课 | ZYF.IM BLOG</title>
<meta name=keywords content="mongodb"><meta name=description content='04 特色及优势
对象模型，快速响应业务变化：

多形性：同一个集合中可以包含不同字段（类型）的文档对象。
动态性：线上修改数据模式，修改是应用与数据库均无须下线。
数据治理：支持使用JSONSchema 来规范数据模式。在保证模式灵活动态的前提下，提供数据治理能力。

快速的开发：

只存储在一个存储区读写。
反范式、无关联的组织极大优化查询速度。
程序 API 自然，开发速度快。

原生的高可用：

Replica Set - 2 to 50 个成员，建议单数。
自恢复。
多中心容灾能力。
滚动服务，最小化服务终端。

横向扩展能力：

需要的时候无缝扩展。
应用全透明。
多种数据分布策略。
轻松支持 TB-PB 数量级。

06 基本操作

cloud.mongodb.com 云服务
样本数据 | geektime-mongodb-course

tar -xvf dump.tar.gz
mongorestore --uri="mongodb://root:root@10.130.0.12/?&amp;authMechanism=SCRAM-SHA-1"
// 插入
db.fruit.insertOne({name: "apple"})
db.fruit.insertMany([
  {name: "apple"},
  {name: "pear"},
  {name: "orange"},
])
// 查询
db.customers.find({username: "fmiller", name: "Elizabeth Ray"})
db.customers.find({username: /^f/})
db.customers.find({$or: [{username: /^f/}, {name: /^E/}]})

a <> 1 {a: {$ne: 1}}
a > 1 {a: {$gt: 1}}
a >= 1 {a: {$gte: 1}}
a < 1 {a: {$lt: 1}}
a <= 1 {a: {$lte: 1}}
a=1 OR b=1 {$or: [{a: 1}, {b: 1}]}
a IS NULL {a: {$exists: false}}
a IS (1,2,3) {a: {$in: [1, 2, 3]}}

// 同时满足
{$eleMatch: {"city": "Rome", "country": "USA"}}
// 投影 projection
// like select
db.customers.find({username: /^f/}, {name: 0, email: 0})
db.customers.find({username: /^f/}, {_id: 1, name: 1})
// remove
db.customers.remove({username: "abrown"})

// update
db.customers.updateOne({username: "fmiller"}, {$set: {from: "China"}})
db.customers.updateMany({username: "fmiller"}, {$set: {from: "China"}})
// $set $unset
// $push $pushAll $pop 数组操作
// $pull $pullAll 如果匹配，从数组中删除相应的对象
// $addToSet 如果不存在则增加一个值到数组

// drop
db.fruit.drop()
show collections

db
db.dropDatabase()
show dbs
08 聚合查询
Aggregation Framework'><meta name=author content="Me"><link rel=canonical href=https://zyf.im/2023/04/19/mongodb-course/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://zyf.im/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zyf.im/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zyf.im/favicon-32x32.png><link rel=apple-touch-icon href=https://zyf.im/apple-touch-icon.png><link rel=mask-icon href=https://zyf.im/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zyf.im/2023/04/19/mongodb-course/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://zyf.im/2023/04/19/mongodb-course/"><meta property="og:site_name" content="ZYF.IM BLOG"><meta property="og:title" content="MongoDB 高手课"><meta property="og:description" content='04 特色及优势 对象模型，快速响应业务变化：
多形性：同一个集合中可以包含不同字段（类型）的文档对象。 动态性：线上修改数据模式，修改是应用与数据库均无须下线。 数据治理：支持使用JSONSchema 来规范数据模式。在保证模式灵活动态的前提下，提供数据治理能力。 快速的开发：
只存储在一个存储区读写。 反范式、无关联的组织极大优化查询速度。 程序 API 自然，开发速度快。 原生的高可用：
Replica Set - 2 to 50 个成员，建议单数。 自恢复。 多中心容灾能力。 滚动服务，最小化服务终端。 横向扩展能力：
需要的时候无缝扩展。 应用全透明。 多种数据分布策略。 轻松支持 TB-PB 数量级。 06 基本操作 cloud.mongodb.com 云服务 样本数据 | geektime-mongodb-course tar -xvf dump.tar.gz mongorestore --uri="mongodb://root:root@10.130.0.12/?&amp;authMechanism=SCRAM-SHA-1" // 插入 db.fruit.insertOne({name: "apple"}) db.fruit.insertMany([ {name: "apple"}, {name: "pear"}, {name: "orange"}, ]) // 查询 db.customers.find({username: "fmiller", name: "Elizabeth Ray"}) db.customers.find({username: /^f/}) db.customers.find({$or: [{username: /^f/}, {name: /^E/}]}) a <> 1 {a: {$ne: 1}} a > 1 {a: {$gt: 1}} a >= 1 {a: {$gte: 1}} a < 1 {a: {$lt: 1}} a <= 1 {a: {$lte: 1}} a=1 OR b=1 {$or: [{a: 1}, {b: 1}]} a IS NULL {a: {$exists: false}} a IS (1,2,3) {a: {$in: [1, 2, 3]}} // 同时满足 {$eleMatch: {"city": "Rome", "country": "USA"}} // 投影 projection // like select db.customers.find({username: /^f/}, {name: 0, email: 0}) db.customers.find({username: /^f/}, {_id: 1, name: 1}) // remove db.customers.remove({username: "abrown"}) // update db.customers.updateOne({username: "fmiller"}, {$set: {from: "China"}}) db.customers.updateMany({username: "fmiller"}, {$set: {from: "China"}}) // $set $unset // $push $pushAll $pop 数组操作 // $pull $pullAll 如果匹配，从数组中删除相应的对象 // $addToSet 如果不存在则增加一个值到数组 // drop db.fruit.drop() show collections db db.dropDatabase() show dbs 08 聚合查询 Aggregation Framework'><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-19T10:47:10+00:00"><meta property="article:modified_time" content="2023-04-19T10:47:10+00:00"><meta property="article:tag" content="Mongodb"><meta name=twitter:card content="summary"><meta name=twitter:title content="MongoDB 高手课"><meta name=twitter:description content='04 特色及优势
对象模型，快速响应业务变化：

多形性：同一个集合中可以包含不同字段（类型）的文档对象。
动态性：线上修改数据模式，修改是应用与数据库均无须下线。
数据治理：支持使用JSONSchema 来规范数据模式。在保证模式灵活动态的前提下，提供数据治理能力。

快速的开发：

只存储在一个存储区读写。
反范式、无关联的组织极大优化查询速度。
程序 API 自然，开发速度快。

原生的高可用：

Replica Set - 2 to 50 个成员，建议单数。
自恢复。
多中心容灾能力。
滚动服务，最小化服务终端。

横向扩展能力：

需要的时候无缝扩展。
应用全透明。
多种数据分布策略。
轻松支持 TB-PB 数量级。

06 基本操作

cloud.mongodb.com 云服务
样本数据 | geektime-mongodb-course

tar -xvf dump.tar.gz
mongorestore --uri="mongodb://root:root@10.130.0.12/?&amp;authMechanism=SCRAM-SHA-1"
// 插入
db.fruit.insertOne({name: "apple"})
db.fruit.insertMany([
  {name: "apple"},
  {name: "pear"},
  {name: "orange"},
])
// 查询
db.customers.find({username: "fmiller", name: "Elizabeth Ray"})
db.customers.find({username: /^f/})
db.customers.find({$or: [{username: /^f/}, {name: /^E/}]})

a <> 1 {a: {$ne: 1}}
a > 1 {a: {$gt: 1}}
a >= 1 {a: {$gte: 1}}
a < 1 {a: {$lt: 1}}
a <= 1 {a: {$lte: 1}}
a=1 OR b=1 {$or: [{a: 1}, {b: 1}]}
a IS NULL {a: {$exists: false}}
a IS (1,2,3) {a: {$in: [1, 2, 3]}}

// 同时满足
{$eleMatch: {"city": "Rome", "country": "USA"}}
// 投影 projection
// like select
db.customers.find({username: /^f/}, {name: 0, email: 0})
db.customers.find({username: /^f/}, {_id: 1, name: 1})
// remove
db.customers.remove({username: "abrown"})

// update
db.customers.updateOne({username: "fmiller"}, {$set: {from: "China"}})
db.customers.updateMany({username: "fmiller"}, {$set: {from: "China"}})
// $set $unset
// $push $pushAll $pop 数组操作
// $pull $pullAll 如果匹配，从数组中删除相应的对象
// $addToSet 如果不存在则增加一个值到数组

// drop
db.fruit.drop()
show collections

db
db.dropDatabase()
show dbs
08 聚合查询
Aggregation Framework'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zyf.im/posts/"},{"@type":"ListItem","position":2,"name":"MongoDB 高手课","item":"https://zyf.im/2023/04/19/mongodb-course/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"MongoDB 高手课","name":"MongoDB 高手课","description":"04 特色及优势 对象模型，快速响应业务变化：\n多形性：同一个集合中可以包含不同字段（类型）的文档对象。 动态性：线上修改数据模式，修改是应用与数据库均无须下线。 数据治理：支持使用JSONSchema 来规范数据模式。在保证模式灵活动态的前提下，提供数据治理能力。 快速的开发：\n只存储在一个存储区读写。 反范式、无关联的组织极大优化查询速度。 程序 API 自然，开发速度快。 原生的高可用：\nReplica Set - 2 to 50 个成员，建议单数。 自恢复。 多中心容灾能力。 滚动服务，最小化服务终端。 横向扩展能力：\n需要的时候无缝扩展。 应用全透明。 多种数据分布策略。 轻松支持 TB-PB 数量级。 06 基本操作 cloud.mongodb.com 云服务 样本数据 | geektime-mongodb-course tar -xvf dump.tar.gz mongorestore --uri=\u0026#34;mongodb://root:root@10.130.0.12/?\u0026amp;authMechanism=SCRAM-SHA-1\u0026#34; // 插入 db.fruit.insertOne({name: \u0026#34;apple\u0026#34;}) db.fruit.insertMany([ {name: \u0026#34;apple\u0026#34;}, {name: \u0026#34;pear\u0026#34;}, {name: \u0026#34;orange\u0026#34;}, ]) // 查询 db.customers.find({username: \u0026#34;fmiller\u0026#34;, name: \u0026#34;Elizabeth Ray\u0026#34;}) db.customers.find({username: /^f/}) db.customers.find({$or: [{username: /^f/}, {name: /^E/}]}) a \u0026lt;\u0026gt; 1 {a: {$ne: 1}} a \u0026gt; 1 {a: {$gt: 1}} a \u0026gt;= 1 {a: {$gte: 1}} a \u0026lt; 1 {a: {$lt: 1}} a \u0026lt;= 1 {a: {$lte: 1}} a=1 OR b=1 {$or: [{a: 1}, {b: 1}]} a IS NULL {a: {$exists: false}} a IS (1,2,3) {a: {$in: [1, 2, 3]}} // 同时满足 {$eleMatch: {\u0026#34;city\u0026#34;: \u0026#34;Rome\u0026#34;, \u0026#34;country\u0026#34;: \u0026#34;USA\u0026#34;}} // 投影 projection // like select db.customers.find({username: /^f/}, {name: 0, email: 0}) db.customers.find({username: /^f/}, {_id: 1, name: 1}) // remove db.customers.remove({username: \u0026#34;abrown\u0026#34;}) // update db.customers.updateOne({username: \u0026#34;fmiller\u0026#34;}, {$set: {from: \u0026#34;China\u0026#34;}}) db.customers.updateMany({username: \u0026#34;fmiller\u0026#34;}, {$set: {from: \u0026#34;China\u0026#34;}}) // $set $unset // $push $pushAll $pop 数组操作 // $pull $pullAll 如果匹配，从数组中删除相应的对象 // $addToSet 如果不存在则增加一个值到数组 // drop db.fruit.drop() show collections db db.dropDatabase() show dbs 08 聚合查询 Aggregation Framework\n","keywords":["mongodb"],"articleBody":"04 特色及优势 对象模型，快速响应业务变化：\n多形性：同一个集合中可以包含不同字段（类型）的文档对象。 动态性：线上修改数据模式，修改是应用与数据库均无须下线。 数据治理：支持使用JSONSchema 来规范数据模式。在保证模式灵活动态的前提下，提供数据治理能力。 快速的开发：\n只存储在一个存储区读写。 反范式、无关联的组织极大优化查询速度。 程序 API 自然，开发速度快。 原生的高可用：\nReplica Set - 2 to 50 个成员，建议单数。 自恢复。 多中心容灾能力。 滚动服务，最小化服务终端。 横向扩展能力：\n需要的时候无缝扩展。 应用全透明。 多种数据分布策略。 轻松支持 TB-PB 数量级。 06 基本操作 cloud.mongodb.com 云服务 样本数据 | geektime-mongodb-course tar -xvf dump.tar.gz mongorestore --uri=\"mongodb://root:root@10.130.0.12/?\u0026authMechanism=SCRAM-SHA-1\" // 插入 db.fruit.insertOne({name: \"apple\"}) db.fruit.insertMany([ {name: \"apple\"}, {name: \"pear\"}, {name: \"orange\"}, ]) // 查询 db.customers.find({username: \"fmiller\", name: \"Elizabeth Ray\"}) db.customers.find({username: /^f/}) db.customers.find({$or: [{username: /^f/}, {name: /^E/}]}) a \u003c\u003e 1 {a: {$ne: 1}} a \u003e 1 {a: {$gt: 1}} a \u003e= 1 {a: {$gte: 1}} a \u003c 1 {a: {$lt: 1}} a \u003c= 1 {a: {$lte: 1}} a=1 OR b=1 {$or: [{a: 1}, {b: 1}]} a IS NULL {a: {$exists: false}} a IS (1,2,3) {a: {$in: [1, 2, 3]}} // 同时满足 {$eleMatch: {\"city\": \"Rome\", \"country\": \"USA\"}} // 投影 projection // like select db.customers.find({username: /^f/}, {name: 0, email: 0}) db.customers.find({username: /^f/}, {_id: 1, name: 1}) // remove db.customers.remove({username: \"abrown\"}) // update db.customers.updateOne({username: \"fmiller\"}, {$set: {from: \"China\"}}) db.customers.updateMany({username: \"fmiller\"}, {$set: {from: \"China\"}}) // $set $unset // $push $pushAll $pop 数组操作 // $pull $pullAll 如果匹配，从数组中删除相应的对象 // $addToSet 如果不存在则增加一个值到数组 // drop db.fruit.drop() show collections db db.dropDatabase() show dbs 08 聚合查询 Aggregation Framework\nPipeline Stage pipeline = [stage1, stage2, ...] db.\u003ccollection\u003e.aggregate( pipeline, { option } ) $match 过滤 $project 投影 $sort 排序 $group 分组 $skip $limit 结果限制 $lookup 左外连接 09 聚合查询实验 // 计算总合计 db.orders.aggregate([ { $group: { _id: null, total: {$sum: \"$total\"} } } ]) // { // \"_id\": null, // \"total\": NumberDecimal(\"44019609\") // } // 查询 2019 第一季度，已完成订单（completed）总金额（金额+运费）和订单总数 db.orders.aggregate([ { $match: { status: \"completed\", orderDate: { $gte: ISODate(\"2019-01-01\"), $lt: ISODate(\"2019-04-01\") } } }, { $group: { _id: null, total: { $sum: \"$total\" }, shippingFee: { $sum: \"$shippingFee\" }, count: { $sum: 1 } } }, { $project: { grandTotal: { $add: [\"$total\", \"$shippingFee\"] }, count: 1, _id: 0 } } ]) // { // \"count\": 5875, // \"grandTotal\": NumberDecimal(\"2636376\") // } 10 复制集机制及原理 由3个以上具有投票权的节点组成：\n1个主节点 PRIMARY：接收写入操作和选举时投票。 两个或多个从节点 SECONDARY：复制主节点上的新数据和选举时投票。 数据是如何复制的：\n当一个修改操作，无论是插入、更新或删除，到达主节点时它对数据的操作将被记录下来(经过些必要的转换)，这些记录称为 oplog。 从节点通过在主节点上打开一个 tailable 游标不断获取新进入主节点的 oplog，并在自己的数据上回放，以此保持跟主节点的数据一致。 通过选举完成故障恢复：\n具有投票权的节点之间两两互相发送心跳。 当5次心跳未收到时判断为节点失联。 如果失联的是主节点，从节点会发起选举，选出新的主节点。 如果失联的是从节点则不会产生新的选举。 选举基于RAFT一致性算法实现，选举成功的必要条件是大多数投票节点存活。 复制集中最多可以有50个节点，但具有投票权的节点最多7个。 影响选举的因素：\n整个集群必须有大多数节点存活。 被选举为主节点的节点必须： 能够与多数节点建立连接 具有较新的 oplog 具有较高的优先级(如果有配置) 复制集节点有以下常见的选配项：\n是否具有投票权（v 参数）：有则参与投票。 优先级（priority 参数）：优先级越高的节点越优先成为主节点。优先级为0的节点无法成为主节点。 隐藏（hidden 参数）：复制数据，但对应用不可见。隐藏节点可以具有投票仅，但优先级必须为0。 延迟（slaveDelay 参数）：复制 n 秒之前的数据，保持与主节点的时间差。 复制集注意事项：\n关于硬件： 因为正常的复制集节点都有可能成为主节点，它们的地位是一样的，因此硬件配置上必须致； 为了保证节点不会同时岩机，各节点使用的硬件必须具有独立性。 关于软件： 复制集各节点软件版本必须一致，以避免出现不可预知的问题。 增加节点不会增加系统写性能！ 11 搭建 MongoDB 复制集 mkdir -p runtime/data_db{1,2,3} \u0026\u0026 \\ mkdir -p runtime/data_configdb{1,2,3} hostname -f rs.status() 12 全家桶 launch-manage | mongodb database-tools | mongodb 13 模型设计基础 Entity Attribute Relationship 概念模型 CDM -\u003e 逻辑模型 LDM -\u003e 物理模型 PDM 对象 -\u003e 实体、属性、关系 -\u003e 表结构、字段列表、主外建\n14 JSON 文档模型设计 无模式的由来：可以省略无论建模的具体过程，物理模型可省。\n设计原则：\n性能 Performance 开发易用 Ease of Development 15 基础设计 集合、字段、基础形状 -\u003e 引用及关联 -\u003e 最终模式\n业务需求及逻辑模型 –逻辑导向-\u003e 基础建模 —\u003e 集合、字段、基础形状\n一个文档 16MB max.\n内嵌为主。\n16 工况细化 技术需求、读写比例、方式及数据 –技术导向-\u003e 工况细化 —\u003e 引用及关联\n引用模式 $lookup：\ndb.contacts.aggregate([ $lookup: { form: \"groups\", localField: \"groups_ids\", foreignField: \"groups_id\", as: \"groups\", } ]) 使用引用方式：\n内嵌文档太大 内嵌文档或数组元素频繁修改 内嵌文档数组元素持续增长且没有封顶 使用引用的设计：\n没有主外键的检查 $lookup 只支持 left outer join $lookup 的关系目标（from）不能是分片表 17 模式套用 经验和学习 –模式导向-\u003e 套用设计模式 -\u003e 优化的模型\n时序数据，分桶设计：利用文档内嵌组，将一个时间段的数据聚合到一个文档里。大量减少文档数据量，大量减少索引占用空间。\n18 设计模式集锦 大文档，很多字段，很多索引。列转行。列数据变化为数组。多语言多国家属性，类似字段需要建立很多索引。转化为数组，一个索引解决所有查询问题。\n模型灵活了，如何管理文档不同版本？增加一个版本字段。schema_version。\n统计网页点击流量。近似计算。if random(0,9)==0 increment by 10。\n业绩排名、游戏排名等精确统计。消耗资源多，聚合计算时间长。用预聚合字段。模型中直接增加统计字段，每次更新数据时同时更新统计值。\n19 写操作事务 writeConcern write-concern | mongodb\n{ w: , j: , wtimeout: } rs.status(); db.test.drop() db.test.insert({count:2}, {writeConcern: {w: \"majority\"}}) db.test.insert({count:2}, {writeConcern: {w: 3}}) db.test.insert({count:2}, {writeConcern: {w: 1}}) // WriteResult({ \"nInserted\" : 1, \"writeConcernError\" : [ ] }) db.test.insert({count:2}, {writeConcern: {w: 4}}) // [Error] 100 - Not enough data-bearing nodes db.test.find() // 配置延迟节点，模拟网络延迟 conf=rs.conf() // { // \"_id\": 3, // \"host\": \"mongo3:27017\", // \"arbiterOnly\": false, // \"buildIndexes\": true, // \"hidden\": false, // \"priority\": 1, // \"tags\": { }, // \"slaveDelay\": NumberLong(\"0\"), // \"votes\": 1 // } conf.members[2].slaveDelay=5 // 没有选举权 conf.members[2].priority=0 rs.reconfig(conf) // { // \"_id\": 3, // \"host\": \"mongo3:27017\", // \"arbiterOnly\": false, // \"buildIndexes\": true, // \"hidden\": false, // \"priority\": 0, // \"tags\": { }, // \"slaveDelay\": NumberLong(\"5\"), // \"votes\": 1 // } db.test.insert({count:2}, {writeConcern: {w: 3}}) // Result Time 5s // 3s 超时 db.test.insert({count:5}, {writeConcern: {w: 3, wtimeout:3000}}) // writeResult({ // \"nInserted\" : 1, // \"writeConcernError\" : { // \"code\" : 64, // \"codeName\" : \"WriteConcernFailed\", // \"errmsg\" : \"waiting for replication timed out\", // \"errInfo\" : { // \"wtimeout\" : true, // \"writeConcern\" : { // \"w\" : 3, // \"wtimeout\" : 3000, // \"provenance\" : \"clientSupplied\" // } // } // } // }) 20 读操作事务 readPreference Read Preference | mongodb Read Preference Tags | mongodb 配置：\nmongodb://…/?replicaSet=rs\u0026readPrefence=secondary 通过驱动API，MongoCollection.withReadPrefence(ReadPrefence readPref) Mongo Shell: db.collection.find({}).readPref(“secondary”) 实验：\n// 主节点 db.test.drop() db.test.insert({count:2}, {writeConcern: {w: 3}}) db.test.find({}) // 1 line db.test.find({}).readPref(\"secondary\") // 1 line // 从节点 1、2 db.test.find({}) // 1 line db.fsyncLock() // now locked against writes, use db.fsyncUnlock() to unlock 锁住写入 // 主节点 db.test.insert({count:3}) db.test.find({}) // 2 line db.test.find().readPref(\"secondary\") // 1 line // 从节点 1、2 db.fsyncUnlock() // 主节点 db.test.find().readPref(\"secondary\") 21 读操作事务 readConcern read-concern | mongodb enableMajorityReadConcern: true\n// 从节点 1、2 db.fsyncLock() // 主节点 db.test.insert({count:3}) db.test.find().readConcern(\"local\") // 如果在一个写操作到达大多数节点前读取了这个写操作，然后因为系统故障该操作回滚了，则发生了脏读 // {readConcern: \"majority\"} 可以避免脏读 db.test.find().readConcern(\"majority\") majority 约为：Read Committed。\n22 多文档事务 Atomocity 原子性 Consistency 一致性 writeConcern,readConcern Isolation 隔离性 readConcern Durability 持久性 Journal and Replication 实验启用事务后的隔离性：\ndb.tx.drop(); db.tx.insertMany([{x:1},{x:2}]); var session = db.getMongo().startSession(); session.startTransaction(); var coll = session.getDatabase('test').getCollection('tx'); coll.updateOne({x:2}, {$set: {y:1}}); // { // acknowledged: true, // insertedId: null, // matchedCount: 1, // modifiedCount: 1, // upsertedCount: 0 // } coll.find(); // [ // { _id: ObjectId(\"64478074fcfac90fb90f1a65\"), x: 1 }, // { _id: ObjectId(\"64478074fcfac90fb90f1a66\"), x: 2, y: 1 } // ] db.tx.find(); // [ // { _id: ObjectId(\"64478074fcfac90fb90f1a65\"), x: 1 }, // { _id: ObjectId(\"64478074fcfac90fb90f1a66\"), x: 2 } // ] session.commitTransaction(); db.tx.find(); 实验可重复读 Repeatable Read：\ndb.tx.drop(); db.tx.insertMany([{x:1},{x:2}]); var session = db.getMongo().startSession(); session.startTransaction({ readConcern: {\"level\": \"snapshot\"}, writeConcern: {\"w\": \"majority\"} }); var coll = session.getDatabase('test').getCollection('tx'); coll.findOne({x: 1}); // 模拟事务之外的操作 db.tx.updateOne({x:1}, {$set: {y:1}}); db.tx.find(); // [ // { _id: ObjectId(\"644782c3fcfac90fb90f1a69\"), x: 1, y: 1 }, // { _id: ObjectId(\"644782c3fcfac90fb90f1a6a\"), x: 2 } // ] coll.findOne({x: 1}); // { _id: ObjectId(\"644782c3fcfac90fb90f1a69\"), x: 1 } session.abortTransaction(); 实验写冲突：\ndb.tx.drop(); db.tx.insertMany([{x:1},{x:2}]); // shell 1、2 var session = db.getMongo().startSession(); session.startTransaction({ readConcern: {\"level\": \"snapshot\"}, writeConcern: {\"w\": \"majority\"} }); var coll = session.getDatabase('test').getCollection('tx'); // shell 1 coll.updateOne({x:1}, {$set: {y:1}}); // ok // shell 2 coll.updateOne({x:1}, {$set: {y:1}}); // MongoServerError: WriteConflict error: this operation conflicted with another operation. Please retry your operation or multi-document transaction. // session.abortTransaction(); 事务默认 60s 内完成。 多文档事务中的读操作必须使用主节点读。 23 Change Stream 类似触发器。\n触发方式：异步 | 同步（事务保证） 触发位置：回调事件 | 数据库触发器 触发次数：每个订阅事件的客户端 | 1次 故障恢复：从上此断点重新触发 | 事务回滚 基于 oplog 实现。被追踪的变更事件主要包括：\ninsert/update/delete drop rename dropDatabase invalidate：drop/rename/dropDatabase 将导致 invalidate 被触发，并关闭 chage stream 可重复读。未开启 majority readConcern 的集群无法使用 Change Stream。当集群无法满足 {w: “majority”} 时，不会触发 Change Stream。\n可以使用集合管道的过滤步骤过滤事件。\n25 分片集群机制及原理 路由节点 mongos 配置节点 mongod 数据节点 mongod 分片集群数据发布方式\n基于范围 查询性能好，数据分布可能不均匀 基于哈希 发布均匀，范围查询效率低；日志、物联网 Zone 数据天然分区 25 分片集群设计 片键 shard key 文档中的一个字段 文档 doc 块 chunk 分片 shard 集群 cluster 片键：\n取值基数范围要大 取值范围应尽可能均匀 对主要查询要具有定向能力 组合片键。{user_id:1, time:1}\n27 分片集群搭建及扩容 # 1 配置域名解析 # 2 准备分片目录 # 3 创建第1个分片复制集 member1:27010 member3:27010 member5:27010 mongod --bind_ip_all --replSet shard1 --shardsvr --wiredTigerCacheSizeGB 1 # --shardsvr 标注为分片节点 # --wiredTigerCacheSizeGB 1 缓存大小 # 4 初始化分片复制集 # 5 创建 config server 复制集 member1:27019 member3:27019 member5:27019 mongod --bind_ip_all --replSet config --configsvr --wiredTigerCacheSizeGB 1 # --configsvr 标注为配置节点 # 6 创建 config server 复制集 # 7 搭建 mongos member1:27017 mongos --bind_ip_all --configdb config/member1:27019,member3:27019,member5:27019, # 连接到 mongos 添加分片 sh.addShard(\"shard1/member1:27010,member3:27010,member5:27010\") # 8 创建分片表 # 连接到 mongos member1:27017 sh.enableSharding(\"foo\"); sh.shardCollection(\"foo.bar\", {_id: \"hashed\"}); sh.status(); # 插入测试数据 use foo for(var i=0;1\u003c10000;i++) { db.bar.insert({i:i)) } # 9 创建第2个分片复制集 member2:27011 member4:27011 member6:27011 # 10 初始化第2个分片复制集 # 11 加入第2个分片 # 连接到 mongos 添加分片 sh.addShard(\"shard2/member2:27011,member4:27011,member6:27011\") 28 监控最佳实践 MongoDB Ops Manager Percona 程序脚本 如何获取监控数据：\ndb.serverStatus() 从上次开机到现在为止 db.isMaster() monogostats db.serverStatus().opcounters 29 备份与恢复 延迟节点备份 全量备份+Oplog增量，Oplog 幂等性 支持重放 mongodump –oplog；不遗漏 dump 时的数据 mongorestore –oplogReplay 31 安全架构 db.createRole({ role: \"readWriteRole\", privileges: [ { resource: { db: \"myDatabase\", collection: \"sample\" }, actions: [ \"find\", \"insert\", \"update\", \"remove\" ] } ], roles: [{ role: 'read', db: 'sampledb', }] }) db.createUser({ user: 'sampleUser', pwd: 'pwd', roles: [{ role: 'readWriteRole', db: 'admin', }] }) 32 安全加固实践 # 禁止脚本执行 --noscripting # 必须鉴权 --auth 33 索引机制（一） Index、Key、DataPage Covered Query/FETCH IXSCAN/COLLSCAN 索引扫描/集合扫描 Big O Notation 时间复杂度 Query Shape 查询的形状 Index Prefix 索引前缀 Selectivity 过滤器 选择区别度大的 B-数结构 B-树和B+树都是常见的多路搜索树结构，常用于数据库索引和文件系统中。它们的主要区别在于如何存储和检索数据。\nB-树是一种自平衡的搜索树，其中每个节点可以存储多个键和对应的值，并支持在O(log n)时间内进行搜索、插入和删除操作。B-树的每个节点都包含了一个子节点数组，可以用来搜索和遍历树。在B-树中，所有节点都可以存储键和值，而非仅仅是叶子节点。\nB+树与B-树非常相似，但是只有叶节点包含了所有的键和值，而且所有叶节点都通过指针链接在一起。这意味着在B+树上进行查找只需要搜索一条从根节点到叶节点的路径，而在B-树中可能需要搜索多个节点。B+树的非叶子节点只包含键，而不包含值，这使得B+树在维护索引时更加高效。\n因此，B+树比B-树更适用于存储和检索大量数据，尤其是数据库和文件系统中的索引。B+树的叶子节点形成了一个有序链表，可以方便地进行区间查找和遍历。而B-树则更适合内存较小的情况下，例如缓存。\n34 索引机制（二） .explain(true) 查看：\nexecutionTimeMillis totalDocsExamined executionStages.docsExamined executionStages.inputStage.stage 组合索引 ESR 原则，Equal(最前) Sort(中间) Range(最后)\ndb.member.createIndex({city:1}, {background: true})\n36 性能诊断工具 mongostat 了解 MongoDB 运行状态的工具。\ndirty 没有刷盘的比例 \u003c5% used qrw 排队的请求 con 连接数量 mongotop 了解集合压力状态\nmtools\n41 应用场景及选型 优点：\n横向扩展能力，数据量或并发量增加时候架构可以自动扩容 灵活模型，适合迭代开发，数据模型多变场景 JSON 数据结构，适合微服务/REST API 44 关系型数据库迁移 从基于关系型数据库应用迁移到 MongoDB 的理由：\n高并发需求（数千 - 数十万 ops），关系型数据库不容易扩展 快速迭代 - 关系型模式太严谨 灵活的 JSON 模式 大数据量需求 地理位置查询 多数据中心跨地域部署 References MongoDB 高手课 mongodb-cluster-docker-compose – EOF –\n","wordCount":"1333","inLanguage":"en","datePublished":"2023-04-19T10:47:10Z","dateModified":"2023-04-19T10:47:10Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zyf.im/2023/04/19/mongodb-course/"},"publisher":{"@type":"Organization","name":"ZYF.IM BLOG","logo":{"@type":"ImageObject","url":"https://zyf.im/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zyf.im/ accesskey=h title="ZYF.IM (Alt + H)"><img src=https://zyf.im/apple-touch-icon.png alt aria-label=logo height=35>ZYF.IM</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zyf.im/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://zyf.im/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zyf.im/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://zyf.im/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zyf.im/>Home</a>&nbsp;»&nbsp;<a href=https://zyf.im/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">MongoDB 高手课</h1><div class=post-meta><span title='2023-04-19 10:47:10 +0000 UTC'>April 19, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1333 words&nbsp;·&nbsp;Me</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#04-特色及优势>04 特色及优势</a></li><li><a href=#06-基本操作>06 基本操作</a></li><li><a href=#08-聚合查询>08 聚合查询</a></li><li><a href=#09-聚合查询实验>09 聚合查询实验</a></li><li><a href=#10-复制集机制及原理>10 复制集机制及原理</a></li><li><a href=#11-搭建-mongodb-复制集>11 搭建 MongoDB 复制集</a></li><li><a href=#12-全家桶>12 全家桶</a></li><li><a href=#13-模型设计基础>13 模型设计基础</a></li><li><a href=#14-json-文档模型设计>14 JSON 文档模型设计</a></li><li><a href=#15-基础设计>15 基础设计</a></li><li><a href=#16-工况细化>16 工况细化</a></li><li><a href=#17-模式套用>17 模式套用</a></li><li><a href=#18-设计模式集锦>18 设计模式集锦</a></li><li><a href=#19-写操作事务-writeconcern>19 写操作事务 writeConcern</a></li><li><a href=#20-读操作事务-readpreference>20 读操作事务 readPreference</a></li><li><a href=#21-读操作事务-readconcern>21 读操作事务 readConcern</a></li><li><a href=#22-多文档事务>22 多文档事务</a></li><li><a href=#23-change-stream>23 Change Stream</a></li><li><a href=#25-分片集群机制及原理>25 分片集群机制及原理</a></li><li><a href=#25-分片集群设计>25 分片集群设计</a></li><li><a href=#27-分片集群搭建及扩容>27 分片集群搭建及扩容</a></li><li><a href=#28-监控最佳实践>28 监控最佳实践</a></li><li><a href=#29-备份与恢复>29 备份与恢复</a></li><li><a href=#31-安全架构>31 安全架构</a></li><li><a href=#32-安全加固实践>32 安全加固实践</a></li><li><a href=#33-索引机制一>33 索引机制（一）</a></li><li><a href=#34-索引机制二>34 索引机制（二）</a></li><li><a href=#36-性能诊断工具>36 性能诊断工具</a></li><li><a href=#41-应用场景及选型>41 应用场景及选型</a></li><li><a href=#44-关系型数据库迁移>44 关系型数据库迁移</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=04-特色及优势>04 特色及优势<a hidden class=anchor aria-hidden=true href=#04-特色及优势>#</a></h2><p>对象模型，快速响应业务变化：</p><ul><li>多形性：同一个集合中可以包含不同字段（类型）的文档对象。</li><li>动态性：线上修改数据模式，修改是应用与数据库均无须下线。</li><li>数据治理：支持使用JSONSchema 来规范数据模式。在保证模式灵活动态的前提下，提供数据治理能力。</li></ul><p>快速的开发：</p><ul><li>只存储在一个存储区读写。</li><li>反范式、无关联的组织极大优化查询速度。</li><li>程序 API 自然，开发速度快。</li></ul><p>原生的高可用：</p><ul><li>Replica Set - 2 to 50 个成员，建议单数。</li><li>自恢复。</li><li>多中心容灾能力。</li><li>滚动服务，最小化服务终端。</li></ul><p>横向扩展能力：</p><ul><li>需要的时候无缝扩展。</li><li>应用全透明。</li><li>多种数据分布策略。</li><li>轻松支持 TB-PB 数量级。</li></ul><h2 id=06-基本操作>06 基本操作<a hidden class=anchor aria-hidden=true href=#06-基本操作>#</a></h2><ul><li><a href=https://cloud.mongodb.com/v2/>cloud.mongodb.com 云服务</a></li><li><a href=https://github.com/tapdata/geektime-mongodb-course/blob/master/aggregation/dump.tar.gz>样本数据 | geektime-mongodb-course</a></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tar -xvf dump.tar.gz
</span></span><span class=line><span class=cl>mongorestore --uri<span class=o>=</span><span class=s2>&#34;mongodb://root:root@10.130.0.12/?&amp;authMechanism=SCRAM-SHA-1&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 插入
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>fruit</span><span class=p>.</span><span class=nx>insertOne</span><span class=p>({</span><span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;apple&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>fruit</span><span class=p>.</span><span class=nx>insertMany</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;apple&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;pear&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;orange&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1>// 查询
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>customers</span><span class=p>.</span><span class=nx>find</span><span class=p>({</span><span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;fmiller&#34;</span><span class=p>,</span> <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Elizabeth Ray&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>customers</span><span class=p>.</span><span class=nx>find</span><span class=p>({</span><span class=nx>username</span><span class=o>:</span> <span class=sr>/^f/</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>customers</span><span class=p>.</span><span class=nx>find</span><span class=p>({</span><span class=nx>$or</span><span class=o>:</span> <span class=p>[{</span><span class=nx>username</span><span class=o>:</span> <span class=sr>/^f/</span><span class=p>},</span> <span class=p>{</span><span class=nx>name</span><span class=o>:</span> <span class=sr>/^E/</span><span class=p>}]})</span>
</span></span></code></pre></div><ul><li><code>a &lt;> 1</code> <code>{a: {$ne: 1}}</code></li><li><code>a > 1</code> <code>{a: {$gt: 1}}</code></li><li><code>a >= 1</code> <code>{a: {$gte: 1}}</code></li><li><code>a &lt; 1</code> <code>{a: {$lt: 1}}</code></li><li><code>a &lt;= 1</code> <code>{a: {$lte: 1}}</code></li><li><code>a=1 OR b=1</code> <code>{$or: [{a: 1}, {b: 1}]}</code></li><li><code>a IS NULL</code> <code>{a: {$exists: false}}</code></li><li><code>a IS (1,2,3)</code> <code>{a: {$in: [1, 2, 3]}}</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 同时满足
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span><span class=nx>$eleMatch</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;city&#34;</span><span class=o>:</span> <span class=s2>&#34;Rome&#34;</span><span class=p>,</span> <span class=s2>&#34;country&#34;</span><span class=o>:</span> <span class=s2>&#34;USA&#34;</span><span class=p>}}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 投影 projection
</span></span></span><span class=line><span class=cl><span class=c1>// like select
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>customers</span><span class=p>.</span><span class=nx>find</span><span class=p>({</span><span class=nx>username</span><span class=o>:</span> <span class=sr>/^f/</span><span class=p>},</span> <span class=p>{</span><span class=nx>name</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>email</span><span class=o>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>customers</span><span class=p>.</span><span class=nx>find</span><span class=p>({</span><span class=nx>username</span><span class=o>:</span> <span class=sr>/^f/</span><span class=p>},</span> <span class=p>{</span><span class=nx>_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>name</span><span class=o>:</span> <span class=mi>1</span><span class=p>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// remove
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>customers</span><span class=p>.</span><span class=nx>remove</span><span class=p>({</span><span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;abrown&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// update
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>customers</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>({</span><span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;fmiller&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>$set</span><span class=o>:</span> <span class=p>{</span><span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;China&#34;</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>customers</span><span class=p>.</span><span class=nx>updateMany</span><span class=p>({</span><span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;fmiller&#34;</span><span class=p>},</span> <span class=p>{</span><span class=nx>$set</span><span class=o>:</span> <span class=p>{</span><span class=nx>from</span><span class=o>:</span> <span class=s2>&#34;China&#34;</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=c1>// $set $unset
</span></span></span><span class=line><span class=cl><span class=c1>// $push $pushAll $pop 数组操作
</span></span></span><span class=line><span class=cl><span class=c1>// $pull $pullAll 如果匹配，从数组中删除相应的对象
</span></span></span><span class=line><span class=cl><span class=c1>// $addToSet 如果不存在则增加一个值到数组
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// drop
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>fruit</span><span class=p>.</span><span class=nx>drop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>show</span> <span class=nx>collections</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>db</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>dropDatabase</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>show</span> <span class=nx>dbs</span>
</span></span></code></pre></div><h2 id=08-聚合查询>08 聚合查询<a hidden class=anchor aria-hidden=true href=#08-聚合查询>#</a></h2><p>Aggregation Framework</p><ul><li>Pipeline</li><li>Stage</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>pipeline</span> <span class=o>=</span> <span class=p>[</span><span class=nx>stage1</span><span class=p>,</span> <span class=nx>stage2</span><span class=p>,</span> <span class=p>...]</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=o>&lt;</span><span class=nx>collection</span><span class=o>&gt;</span><span class=p>.</span><span class=nx>aggregate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>pipeline</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=nx>option</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><ul><li>$match 过滤</li><li>$project 投影</li><li>$sort 排序</li><li>$group 分组</li><li>$skip $limit 结果限制</li><li>$lookup 左外连接</li></ul><h2 id=09-聚合查询实验>09 聚合查询实验<a hidden class=anchor aria-hidden=true href=#09-聚合查询实验>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 计算总合计
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>orders</span><span class=p>.</span><span class=nx>aggregate</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$group</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>_id</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>total</span><span class=o>:</span> <span class=p>{</span><span class=nx>$sum</span><span class=o>:</span> <span class=s2>&#34;$total&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1>// {
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;_id&#34;: null,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;total&#34;: NumberDecimal(&#34;44019609&#34;)
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 查询 2019 第一季度，已完成订单（completed）总金额（金额+运费）和订单总数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>orders</span><span class=p>.</span><span class=nx>aggregate</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$match</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;completed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>orderDate</span><span class=o>:</span> <span class=p>{</span> <span class=nx>$gte</span><span class=o>:</span> <span class=nx>ISODate</span><span class=p>(</span><span class=s2>&#34;2019-01-01&#34;</span><span class=p>),</span> <span class=nx>$lt</span><span class=o>:</span> <span class=nx>ISODate</span><span class=p>(</span><span class=s2>&#34;2019-04-01&#34;</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$group</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>_id</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>total</span><span class=o>:</span> <span class=p>{</span> <span class=nx>$sum</span><span class=o>:</span> <span class=s2>&#34;$total&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>shippingFee</span><span class=o>:</span> <span class=p>{</span> <span class=nx>$sum</span><span class=o>:</span> <span class=s2>&#34;$shippingFee&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>count</span><span class=o>:</span> <span class=p>{</span> <span class=nx>$sum</span><span class=o>:</span> <span class=mi>1</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$project</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>grandTotal</span><span class=o>:</span> <span class=p>{</span> <span class=nx>$add</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;$total&#34;</span><span class=p>,</span> <span class=s2>&#34;$shippingFee&#34;</span><span class=p>]</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>count</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>_id</span><span class=o>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1>// {
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;count&#34;: 5875,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;grandTotal&#34;: NumberDecimal(&#34;2636376&#34;)
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span></code></pre></div><h2 id=10-复制集机制及原理>10 复制集机制及原理<a hidden class=anchor aria-hidden=true href=#10-复制集机制及原理>#</a></h2><p>由3个以上具有投票权的节点组成：</p><ul><li>1个主节点 PRIMARY：接收写入操作和选举时投票。</li><li>两个或多个从节点 SECONDARY：复制主节点上的新数据和选举时投票。</li></ul><p>数据是如何复制的：</p><ul><li>当一个修改操作，无论是插入、更新或删除，到达主节点时它对数据的操作将被记录下来(经过些必要的转换)，这些记录称为 oplog。</li><li>从节点通过在主节点上打开一个 tailable 游标不断获取新进入主节点的 oplog，并在自己的数据上回放，以此保持跟主节点的数据一致。</li></ul><p>通过选举完成故障恢复：</p><ul><li>具有投票权的节点之间两两互相发送心跳。</li><li>当5次心跳未收到时判断为节点失联。</li><li>如果失联的是主节点，从节点会发起选举，选出新的主节点。</li><li>如果失联的是从节点则不会产生新的选举。</li><li>选举基于RAFT一致性算法实现，选举成功的必要条件是大多数投票节点存活。</li><li>复制集中最多可以有50个节点，但具有投票权的节点最多7个。</li></ul><p>影响选举的因素：</p><ul><li>整个集群必须有大多数节点存活。</li><li>被选举为主节点的节点必须：<ul><li>能够与多数节点建立连接</li><li>具有较新的 oplog</li><li>具有较高的优先级(如果有配置)</li></ul></li></ul><p>复制集节点有以下常见的选配项：</p><ul><li>是否具有投票权（v 参数）：有则参与投票。</li><li>优先级（priority 参数）：优先级越高的节点越优先成为主节点。优先级为0的节点无法成为主节点。</li><li>隐藏（hidden 参数）：复制数据，但对应用不可见。隐藏节点可以具有投票仅，但优先级必须为0。</li><li>延迟（slaveDelay 参数）：复制 n 秒之前的数据，保持与主节点的时间差。</li></ul><p>复制集注意事项：</p><ul><li>关于硬件：<ul><li>因为正常的复制集节点都有可能成为主节点，它们的地位是一样的，因此硬件配置上必须致；</li><li>为了保证节点不会同时岩机，各节点使用的硬件必须具有独立性。</li></ul></li><li>关于软件：<ul><li>复制集各节点软件版本必须一致，以避免出现不可预知的问题。</li></ul></li><li>增加节点不会增加系统写性能！</li></ul><h2 id=11-搭建-mongodb-复制集>11 搭建 MongoDB 复制集<a hidden class=anchor aria-hidden=true href=#11-搭建-mongodb-复制集>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p runtime/data_db<span class=o>{</span>1,2,3<span class=o>}</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>mkdir -p runtime/data_configdb<span class=o>{</span>1,2,3<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>hostname -f
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rs.status<span class=o>()</span>
</span></span></code></pre></div><h2 id=12-全家桶>12 全家桶<a hidden class=anchor aria-hidden=true href=#12-全家桶>#</a></h2><ul><li><a href=https://www.mongodb.com/docs/launch-manage/>launch-manage | mongodb</a></li><li><a href=https://www.mongodb.com/docs/database-tools/>database-tools | mongodb</a></li></ul><h2 id=13-模型设计基础>13 模型设计基础<a hidden class=anchor aria-hidden=true href=#13-模型设计基础>#</a></h2><ul><li>Entity</li><li>Attribute</li><li>Relationship</li></ul><p>概念模型 CDM -> 逻辑模型 LDM -> 物理模型 PDM
对象 -> 实体、属性、关系 -> 表结构、字段列表、主外建</p><h2 id=14-json-文档模型设计>14 JSON 文档模型设计<a hidden class=anchor aria-hidden=true href=#14-json-文档模型设计>#</a></h2><p>无模式的由来：可以省略无论建模的具体过程，物理模型可省。</p><p>设计原则：</p><ul><li>性能 Performance</li><li>开发易用 Ease of Development</li></ul><h2 id=15-基础设计>15 基础设计<a hidden class=anchor aria-hidden=true href=#15-基础设计>#</a></h2><p>集合、字段、基础形状 -> 引用及关联 -> 最终模式</p><p>业务需求及逻辑模型 &ndash;逻辑导向-> 基础建模 &mdash;> 集合、字段、基础形状</p><p>一个文档 16MB max.</p><p>内嵌为主。</p><h2 id=16-工况细化>16 工况细化<a hidden class=anchor aria-hidden=true href=#16-工况细化>#</a></h2><p>技术需求、读写比例、方式及数据 &ndash;技术导向-> 工况细化 &mdash;> 引用及关联</p><p>引用模式 $lookup：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>contacts</span><span class=p>.</span><span class=nx>aggregate</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=nx>$lookup</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>form</span><span class=o>:</span> <span class=s2>&#34;groups&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>localField</span><span class=o>:</span> <span class=s2>&#34;groups_ids&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>foreignField</span><span class=o>:</span> <span class=s2>&#34;groups_id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;groups&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span></code></pre></div><p>使用引用方式：</p><ul><li>内嵌文档太大</li><li>内嵌文档或数组元素频繁修改</li><li>内嵌文档数组元素持续增长且没有封顶</li></ul><p>使用引用的设计：</p><ul><li>没有主外键的检查</li><li>$lookup 只支持 left outer join</li><li>$lookup 的关系目标（from）不能是分片表</li></ul><h2 id=17-模式套用>17 模式套用<a hidden class=anchor aria-hidden=true href=#17-模式套用>#</a></h2><p>经验和学习 &ndash;模式导向-> 套用设计模式 -> 优化的模型</p><p>时序数据，分桶设计：利用文档内嵌组，将一个时间段的数据聚合到一个文档里。大量减少文档数据量，大量减少索引占用空间。</p><h2 id=18-设计模式集锦>18 设计模式集锦<a hidden class=anchor aria-hidden=true href=#18-设计模式集锦>#</a></h2><p>大文档，很多字段，很多索引。列转行。列数据变化为数组。多语言多国家属性，类似字段需要建立很多索引。转化为数组，一个索引解决所有查询问题。</p><p>模型灵活了，如何管理文档不同版本？增加一个版本字段。schema_version。</p><p>统计网页点击流量。近似计算。if random(0,9)==0 increment by 10。</p><p>业绩排名、游戏排名等精确统计。消耗资源多，聚合计算时间长。用预聚合字段。模型中直接增加统计字段，每次更新数据时同时更新统计值。</p><h2 id=19-写操作事务-writeconcern>19 写操作事务 writeConcern<a hidden class=anchor aria-hidden=true href=#19-写操作事务-writeconcern>#</a></h2><p><a href=https://www.mongodb.com/docs/manual/reference/write-concern/>write-concern | mongodb</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>{ w: &lt;value&gt;, j: &lt;boolean&gt;, wtimeout: &lt;number&gt; }
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>rs</span><span class=p>.</span><span class=nx>status</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>drop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>2</span><span class=p>},</span> <span class=p>{</span><span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=nx>w</span><span class=o>:</span> <span class=s2>&#34;majority&#34;</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>2</span><span class=p>},</span> <span class=p>{</span><span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=nx>w</span><span class=o>:</span> <span class=mi>3</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>2</span><span class=p>},</span> <span class=p>{</span><span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=nx>w</span><span class=o>:</span> <span class=mi>1</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=c1>// WriteResult({ &#34;nInserted&#34; : 1, &#34;writeConcernError&#34; : [ ] })
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>2</span><span class=p>},</span> <span class=p>{</span><span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=nx>w</span><span class=o>:</span> <span class=mi>4</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=c1>// [Error] 100 - Not enough data-bearing nodes
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 配置延迟节点，模拟网络延迟
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conf</span><span class=o>=</span><span class=nx>rs</span><span class=p>.</span><span class=nx>conf</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// {
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;_id&#34;: 3,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;host&#34;: &#34;mongo3:27017&#34;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;arbiterOnly&#34;: false,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;buildIndexes&#34;: true,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;hidden&#34;: false,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;priority&#34;: 1,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;tags&#34;: { },
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;slaveDelay&#34;: NumberLong(&#34;0&#34;),
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;votes&#34;: 1
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conf</span><span class=p>.</span><span class=nx>members</span><span class=p>[</span><span class=mi>2</span><span class=p>].</span><span class=nx>slaveDelay</span><span class=o>=</span><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=c1>// 没有选举权
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>conf</span><span class=p>.</span><span class=nx>members</span><span class=p>[</span><span class=mi>2</span><span class=p>].</span><span class=nx>priority</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nx>rs</span><span class=p>.</span><span class=nx>reconfig</span><span class=p>(</span><span class=nx>conf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// {
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;_id&#34;: 3,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;host&#34;: &#34;mongo3:27017&#34;,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;arbiterOnly&#34;: false,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;buildIndexes&#34;: true,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;hidden&#34;: false,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;priority&#34;: 0,
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;tags&#34;: { },
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;slaveDelay&#34;: NumberLong(&#34;5&#34;),
</span></span></span><span class=line><span class=cl><span class=c1>//     &#34;votes&#34;: 1
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>2</span><span class=p>},</span> <span class=p>{</span><span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=nx>w</span><span class=o>:</span> <span class=mi>3</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=c1>// Result Time 5s
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 3s 超时
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>5</span><span class=p>},</span> <span class=p>{</span><span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=nx>w</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>wtimeout</span><span class=o>:</span><span class=mi>3000</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=c1>// writeResult({
</span></span></span><span class=line><span class=cl><span class=c1>//         &#34;nInserted&#34; : 1,
</span></span></span><span class=line><span class=cl><span class=c1>//         &#34;writeConcernError&#34; : {
</span></span></span><span class=line><span class=cl><span class=c1>//                 &#34;code&#34; : 64,
</span></span></span><span class=line><span class=cl><span class=c1>//                 &#34;codeName&#34; : &#34;WriteConcernFailed&#34;,
</span></span></span><span class=line><span class=cl><span class=c1>//                 &#34;errmsg&#34; : &#34;waiting for replication timed out&#34;,
</span></span></span><span class=line><span class=cl><span class=c1>//                 &#34;errInfo&#34; : {
</span></span></span><span class=line><span class=cl><span class=c1>//                         &#34;wtimeout&#34; : true,
</span></span></span><span class=line><span class=cl><span class=c1>//                         &#34;writeConcern&#34; : {
</span></span></span><span class=line><span class=cl><span class=c1>//                                 &#34;w&#34; : 3,
</span></span></span><span class=line><span class=cl><span class=c1>//                                 &#34;wtimeout&#34; : 3000,
</span></span></span><span class=line><span class=cl><span class=c1>//                                 &#34;provenance&#34; : &#34;clientSupplied&#34;
</span></span></span><span class=line><span class=cl><span class=c1>//                         }
</span></span></span><span class=line><span class=cl><span class=c1>//                 }
</span></span></span><span class=line><span class=cl><span class=c1>//         }
</span></span></span><span class=line><span class=cl><span class=c1>// })
</span></span></span></code></pre></div><h2 id=20-读操作事务-readpreference>20 读操作事务 readPreference<a hidden class=anchor aria-hidden=true href=#20-读操作事务-readpreference>#</a></h2><ul><li><a href=https://www.mongodb.com/docs/manual/core/read-preference/>Read Preference | mongodb</a></li><li><a href=https://www.mongodb.com/docs/v4.4/core/read-preference-tags/>Read Preference Tags | mongodb</a></li></ul><p>配置：</p><ul><li>mongodb://&mldr;/?replicaSet=rs&amp;readPrefence=secondary</li><li>通过驱动API，MongoCollection.withReadPrefence(ReadPrefence readPref)</li><li>Mongo Shell: db.collection.find({}).readPref(&ldquo;secondary&rdquo;)</li></ul><p>实验：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 主节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>drop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>2</span><span class=p>},</span> <span class=p>{</span><span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=nx>w</span><span class=o>:</span> <span class=mi>3</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>({})</span>
</span></span><span class=line><span class=cl><span class=c1>// 1 line
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>({}).</span><span class=nx>readPref</span><span class=p>(</span><span class=s2>&#34;secondary&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 1 line
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 从节点 1、2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>({})</span>
</span></span><span class=line><span class=cl><span class=c1>// 1 line
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>fsyncLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// now locked against writes, use db.fsyncUnlock() to unlock 锁住写入
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 主节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>({})</span>
</span></span><span class=line><span class=cl><span class=c1>// 2 line
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>().</span><span class=nx>readPref</span><span class=p>(</span><span class=s2>&#34;secondary&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 1 line
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 从节点 1、2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>fsyncUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// 主节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>().</span><span class=nx>readPref</span><span class=p>(</span><span class=s2>&#34;secondary&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=21-读操作事务-readconcern>21 读操作事务 readConcern<a hidden class=anchor aria-hidden=true href=#21-读操作事务-readconcern>#</a></h2><ul><li><a href=https://www.mongodb.com/docs/manual/reference/read-concern/>read-concern | mongodb</a></li></ul><p>enableMajorityReadConcern: true</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 从节点 1、2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>fsyncLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// 主节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>insert</span><span class=p>({</span><span class=nx>count</span><span class=o>:</span><span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>().</span><span class=nx>readConcern</span><span class=p>(</span><span class=s2>&#34;local&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 如果在一个写操作到达大多数节点前读取了这个写操作，然后因为系统故障该操作回滚了，则发生了脏读
</span></span></span><span class=line><span class=cl><span class=c1>// {readConcern: &#34;majority&#34;} 可以避免脏读
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>find</span><span class=p>().</span><span class=nx>readConcern</span><span class=p>(</span><span class=s2>&#34;majority&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>majority 约为：Read Committed。</p><h2 id=22-多文档事务>22 多文档事务<a hidden class=anchor aria-hidden=true href=#22-多文档事务>#</a></h2><ul><li>Atomocity 原子性</li><li>Consistency 一致性 writeConcern,readConcern</li><li>Isolation 隔离性 readConcern</li><li>Durability 持久性 Journal and Replication</li></ul><p>实验启用事务后的隔离性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>drop</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>insertMany</span><span class=p>([{</span><span class=nx>x</span><span class=o>:</span><span class=mi>1</span><span class=p>},{</span><span class=nx>x</span><span class=o>:</span><span class=mi>2</span><span class=p>}]);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>getMongo</span><span class=p>().</span><span class=nx>startSession</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>session</span><span class=p>.</span><span class=nx>startTransaction</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>coll</span> <span class=o>=</span> <span class=nx>session</span><span class=p>.</span><span class=nx>getDatabase</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>).</span><span class=nx>getCollection</span><span class=p>(</span><span class=s1>&#39;tx&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>coll</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>({</span><span class=nx>x</span><span class=o>:</span><span class=mi>2</span><span class=p>},</span> <span class=p>{</span><span class=nx>$set</span><span class=o>:</span> <span class=p>{</span><span class=nx>y</span><span class=o>:</span><span class=mi>1</span><span class=p>}});</span>
</span></span><span class=line><span class=cl><span class=c1>// {
</span></span></span><span class=line><span class=cl><span class=c1>//   acknowledged: true,
</span></span></span><span class=line><span class=cl><span class=c1>//   insertedId: null,
</span></span></span><span class=line><span class=cl><span class=c1>//   matchedCount: 1,
</span></span></span><span class=line><span class=cl><span class=c1>//   modifiedCount: 1,
</span></span></span><span class=line><span class=cl><span class=c1>//   upsertedCount: 0
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>coll</span><span class=p>.</span><span class=nx>find</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// [
</span></span></span><span class=line><span class=cl><span class=c1>//   { _id: ObjectId(&#34;64478074fcfac90fb90f1a65&#34;), x: 1 },
</span></span></span><span class=line><span class=cl><span class=c1>//   { _id: ObjectId(&#34;64478074fcfac90fb90f1a66&#34;), x: 2, y: 1 }
</span></span></span><span class=line><span class=cl><span class=c1>// ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>find</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// [
</span></span></span><span class=line><span class=cl><span class=c1>//   { _id: ObjectId(&#34;64478074fcfac90fb90f1a65&#34;), x: 1 },
</span></span></span><span class=line><span class=cl><span class=c1>//   { _id: ObjectId(&#34;64478074fcfac90fb90f1a66&#34;), x: 2 }
</span></span></span><span class=line><span class=cl><span class=c1>// ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>session</span><span class=p>.</span><span class=nx>commitTransaction</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>find</span><span class=p>();</span>
</span></span></code></pre></div><p>实验可重复读 Repeatable Read：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>drop</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>insertMany</span><span class=p>([{</span><span class=nx>x</span><span class=o>:</span><span class=mi>1</span><span class=p>},{</span><span class=nx>x</span><span class=o>:</span><span class=mi>2</span><span class=p>}]);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>getMongo</span><span class=p>().</span><span class=nx>startSession</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>session</span><span class=p>.</span><span class=nx>startTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>readConcern</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;level&#34;</span><span class=o>:</span> <span class=s2>&#34;snapshot&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;w&#34;</span><span class=o>:</span> <span class=s2>&#34;majority&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>coll</span> <span class=o>=</span> <span class=nx>session</span><span class=p>.</span><span class=nx>getDatabase</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>).</span><span class=nx>getCollection</span><span class=p>(</span><span class=s1>&#39;tx&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>coll</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span><span class=nx>x</span><span class=o>:</span> <span class=mi>1</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// 模拟事务之外的操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>({</span><span class=nx>x</span><span class=o>:</span><span class=mi>1</span><span class=p>},</span> <span class=p>{</span><span class=nx>$set</span><span class=o>:</span> <span class=p>{</span><span class=nx>y</span><span class=o>:</span><span class=mi>1</span><span class=p>}});</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>find</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// [
</span></span></span><span class=line><span class=cl><span class=c1>//   { _id: ObjectId(&#34;644782c3fcfac90fb90f1a69&#34;), x: 1, y: 1 },
</span></span></span><span class=line><span class=cl><span class=c1>//   { _id: ObjectId(&#34;644782c3fcfac90fb90f1a6a&#34;), x: 2 }
</span></span></span><span class=line><span class=cl><span class=c1>// ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>coll</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span><span class=nx>x</span><span class=o>:</span> <span class=mi>1</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// { _id: ObjectId(&#34;644782c3fcfac90fb90f1a69&#34;), x: 1 }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>session</span><span class=p>.</span><span class=nx>abortTransaction</span><span class=p>();</span>
</span></span></code></pre></div><p>实验写冲突：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>drop</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>tx</span><span class=p>.</span><span class=nx>insertMany</span><span class=p>([{</span><span class=nx>x</span><span class=o>:</span><span class=mi>1</span><span class=p>},{</span><span class=nx>x</span><span class=o>:</span><span class=mi>2</span><span class=p>}]);</span>
</span></span><span class=line><span class=cl><span class=c1>// shell 1、2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>getMongo</span><span class=p>().</span><span class=nx>startSession</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>session</span><span class=p>.</span><span class=nx>startTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>readConcern</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;level&#34;</span><span class=o>:</span> <span class=s2>&#34;snapshot&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>writeConcern</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;w&#34;</span><span class=o>:</span> <span class=s2>&#34;majority&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>coll</span> <span class=o>=</span> <span class=nx>session</span><span class=p>.</span><span class=nx>getDatabase</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>).</span><span class=nx>getCollection</span><span class=p>(</span><span class=s1>&#39;tx&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// shell 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>coll</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>({</span><span class=nx>x</span><span class=o>:</span><span class=mi>1</span><span class=p>},</span> <span class=p>{</span><span class=nx>$set</span><span class=o>:</span> <span class=p>{</span><span class=nx>y</span><span class=o>:</span><span class=mi>1</span><span class=p>}});</span>
</span></span><span class=line><span class=cl><span class=c1>// ok
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// shell 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>coll</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>({</span><span class=nx>x</span><span class=o>:</span><span class=mi>1</span><span class=p>},</span> <span class=p>{</span><span class=nx>$set</span><span class=o>:</span> <span class=p>{</span><span class=nx>y</span><span class=o>:</span><span class=mi>1</span><span class=p>}});</span>
</span></span><span class=line><span class=cl><span class=c1>// MongoServerError: WriteConflict error: this operation conflicted with another operation. Please retry your operation or multi-document transaction.
</span></span></span><span class=line><span class=cl><span class=c1>// session.abortTransaction();
</span></span></span></code></pre></div><ul><li>事务默认 60s 内完成。</li><li>多文档事务中的读操作必须使用主节点读。</li></ul><h2 id=23-change-stream>23 Change Stream<a hidden class=anchor aria-hidden=true href=#23-change-stream>#</a></h2><p>类似触发器。</p><ul><li>触发方式：异步 | 同步（事务保证）</li><li>触发位置：回调事件 | 数据库触发器</li><li>触发次数：每个订阅事件的客户端 | 1次</li><li>故障恢复：从上此断点重新触发 | 事务回滚</li></ul><p>基于 oplog 实现。被追踪的变更事件主要包括：</p><ul><li>insert/update/delete</li><li>drop</li><li>rename</li><li>dropDatabase</li><li>invalidate：drop/rename/dropDatabase 将导致 invalidate 被触发，并关闭 chage stream</li></ul><p>可重复读。未开启 majority readConcern 的集群无法使用 Change Stream。当集群无法满足 {w: &ldquo;majority&rdquo;} 时，不会触发 Change Stream。</p><p>可以使用集合管道的过滤步骤过滤事件。</p><h2 id=25-分片集群机制及原理>25 分片集群机制及原理<a hidden class=anchor aria-hidden=true href=#25-分片集群机制及原理>#</a></h2><ul><li>路由节点 mongos</li><li>配置节点 mongod</li><li>数据节点 mongod</li></ul><p>分片集群数据发布方式</p><ul><li>基于范围 查询性能好，数据分布可能不均匀</li><li>基于哈希 发布均匀，范围查询效率低；日志、物联网</li><li>Zone 数据天然分区</li></ul><h2 id=25-分片集群设计>25 分片集群设计<a hidden class=anchor aria-hidden=true href=#25-分片集群设计>#</a></h2><ul><li>片键 shard key 文档中的一个字段</li><li>文档 doc</li><li>块 chunk</li><li>分片 shard</li><li>集群 cluster</li></ul><p>片键：</p><ul><li>取值基数范围要大</li><li>取值范围应尽可能均匀</li><li>对主要查询要具有定向能力</li></ul><p>组合片键。{user_id:1, time:1}</p><h2 id=27-分片集群搭建及扩容>27 分片集群搭建及扩容<a hidden class=anchor aria-hidden=true href=#27-分片集群搭建及扩容>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1 配置域名解析</span>
</span></span><span class=line><span class=cl><span class=c1># 2 准备分片目录</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3 创建第1个分片复制集 member1:27010 member3:27010 member5:27010</span>
</span></span><span class=line><span class=cl>mongod --bind_ip_all --replSet shard1 --shardsvr --wiredTigerCacheSizeGB <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1># --shardsvr 标注为分片节点</span>
</span></span><span class=line><span class=cl><span class=c1># --wiredTigerCacheSizeGB 1 缓存大小</span>
</span></span><span class=line><span class=cl><span class=c1># 4 初始化分片复制集</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5 创建 config server 复制集 member1:27019 member3:27019 member5:27019</span>
</span></span><span class=line><span class=cl>mongod --bind_ip_all --replSet config --configsvr --wiredTigerCacheSizeGB <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1># --configsvr 标注为配置节点</span>
</span></span><span class=line><span class=cl><span class=c1># 6 创建 config server 复制集</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7 搭建 mongos member1:27017</span>
</span></span><span class=line><span class=cl>mongos --bind_ip_all --configdb config/member1:27019,member3:27019,member5:27019,
</span></span><span class=line><span class=cl><span class=c1># 连接到 mongos 添加分片</span>
</span></span><span class=line><span class=cl>sh.addShard<span class=o>(</span><span class=s2>&#34;shard1/member1:27010,member3:27010,member5:27010&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8 创建分片表</span>
</span></span><span class=line><span class=cl><span class=c1># 连接到 mongos member1:27017</span>
</span></span><span class=line><span class=cl>sh.enableSharding<span class=o>(</span><span class=s2>&#34;foo&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>sh.shardCollection<span class=o>(</span><span class=s2>&#34;foo.bar&#34;</span>, <span class=o>{</span>_id: <span class=s2>&#34;hashed&#34;</span><span class=o>})</span><span class=p>;</span>
</span></span><span class=line><span class=cl>sh.status<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1># 插入测试数据</span>
</span></span><span class=line><span class=cl>use foo
</span></span><span class=line><span class=cl><span class=k>for</span><span class=o>(</span>var <span class=nv>i</span><span class=o>=</span>0<span class=p>;</span>1&lt;10000<span class=p>;</span>i++<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  db.bar.insert<span class=o>({</span>i:i<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 9 创建第2个分片复制集  member2:27011 member4:27011 member6:27011</span>
</span></span><span class=line><span class=cl><span class=c1># 10 初始化第2个分片复制集</span>
</span></span><span class=line><span class=cl><span class=c1># 11 加入第2个分片</span>
</span></span><span class=line><span class=cl><span class=c1># 连接到 mongos 添加分片</span>
</span></span><span class=line><span class=cl>sh.addShard<span class=o>(</span><span class=s2>&#34;shard2/member2:27011,member4:27011,member6:27011&#34;</span><span class=o>)</span>
</span></span></code></pre></div><h2 id=28-监控最佳实践>28 监控最佳实践<a hidden class=anchor aria-hidden=true href=#28-监控最佳实践>#</a></h2><ul><li>MongoDB Ops Manager</li><li>Percona</li><li>程序脚本</li></ul><p>如何获取监控数据：</p><ul><li>db.serverStatus() 从上次开机到现在为止</li><li>db.isMaster()</li><li>monogostats</li><li>db.serverStatus().opcounters</li></ul><h2 id=29-备份与恢复>29 备份与恢复<a hidden class=anchor aria-hidden=true href=#29-备份与恢复>#</a></h2><ul><li>延迟节点备份</li><li>全量备份+Oplog增量，Oplog 幂等性 支持重放</li><li>mongodump &ndash;oplog；不遗漏 dump 时的数据</li><li>mongorestore &ndash;oplogReplay</li></ul><h2 id=31-安全架构>31 安全架构<a hidden class=anchor aria-hidden=true href=#31-安全架构>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>createRole</span><span class=p>({</span>
</span></span><span class=line><span class=cl>   <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;readWriteRole&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nx>privileges</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>resource</span><span class=o>:</span> <span class=p>{</span> <span class=nx>db</span><span class=o>:</span> <span class=s2>&#34;myDatabase&#34;</span><span class=p>,</span> <span class=nx>collection</span><span class=o>:</span> <span class=s2>&#34;sample&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>actions</span><span class=o>:</span> <span class=p>[</span> <span class=s2>&#34;find&#34;</span><span class=p>,</span> <span class=s2>&#34;insert&#34;</span><span class=p>,</span> <span class=s2>&#34;update&#34;</span><span class=p>,</span> <span class=s2>&#34;remove&#34;</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>],</span>
</span></span><span class=line><span class=cl>   <span class=nx>roles</span><span class=o>:</span> <span class=p>[{</span>
</span></span><span class=line><span class=cl>      <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;read&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>db</span><span class=o>:</span> <span class=s1>&#39;sampledb&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>}]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>createUser</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>user</span><span class=o>:</span> <span class=s1>&#39;sampleUser&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>pwd</span><span class=o>:</span> <span class=s1>&#39;pwd&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>roles</span><span class=o>:</span> <span class=p>[{</span>
</span></span><span class=line><span class=cl>      <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;readWriteRole&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>db</span><span class=o>:</span> <span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>}]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h2 id=32-安全加固实践>32 安全加固实践<a hidden class=anchor aria-hidden=true href=#32-安全加固实践>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 禁止脚本执行</span>
</span></span><span class=line><span class=cl>--noscripting
</span></span><span class=line><span class=cl><span class=c1># 必须鉴权</span>
</span></span><span class=line><span class=cl>--auth
</span></span></code></pre></div><h2 id=33-索引机制一>33 索引机制（一）<a hidden class=anchor aria-hidden=true href=#33-索引机制一>#</a></h2><ul><li>Index、Key、DataPage</li><li>Covered Query/FETCH</li><li>IXSCAN/COLLSCAN 索引扫描/集合扫描</li><li>Big O Notation 时间复杂度</li><li>Query Shape 查询的形状</li><li>Index Prefix 索引前缀</li><li>Selectivity 过滤器 选择区别度大的</li><li>B-数结构</li></ul><p>B-树和B+树都是常见的多路搜索树结构，常用于数据库索引和文件系统中。它们的主要区别在于如何存储和检索数据。</p><p>B-树是一种自平衡的搜索树，其中每个节点可以存储多个键和对应的值，并支持在O(log n)时间内进行搜索、插入和删除操作。B-树的每个节点都包含了一个子节点数组，可以用来搜索和遍历树。在B-树中，所有节点都可以存储键和值，而非仅仅是叶子节点。</p><p>B+树与B-树非常相似，但是只有叶节点包含了所有的键和值，而且所有叶节点都通过指针链接在一起。这意味着在B+树上进行查找只需要搜索一条从根节点到叶节点的路径，而在B-树中可能需要搜索多个节点。B+树的非叶子节点只包含键，而不包含值，这使得B+树在维护索引时更加高效。</p><p>因此，B+树比B-树更适用于存储和检索大量数据，尤其是数据库和文件系统中的索引。B+树的叶子节点形成了一个有序链表，可以方便地进行区间查找和遍历。而B-树则更适合内存较小的情况下，例如缓存。</p><h2 id=34-索引机制二>34 索引机制（二）<a hidden class=anchor aria-hidden=true href=#34-索引机制二>#</a></h2><p>.explain(true) 查看：</p><ul><li><code>executionTimeMillis</code></li><li><code>totalDocsExamined</code></li><li><code>executionStages.docsExamined</code></li><li><code>executionStages.inputStage.stage</code></li></ul><p>组合索引 ESR 原则，Equal(最前) Sort(中间) Range(最后)</p><p>db.member.createIndex({city:1}, {background: true})</p><h2 id=36-性能诊断工具>36 性能诊断工具<a hidden class=anchor aria-hidden=true href=#36-性能诊断工具>#</a></h2><p>mongostat 了解 MongoDB 运行状态的工具。</p><ul><li>dirty 没有刷盘的比例 &lt;5%</li><li>used</li><li>qrw 排队的请求</li><li>con 连接数量</li></ul><p>mongotop 了解集合压力状态</p><p><a href=https://github.com/rueckstiess/mtools>mtools</a></p><h2 id=41-应用场景及选型>41 应用场景及选型<a hidden class=anchor aria-hidden=true href=#41-应用场景及选型>#</a></h2><p>优点：</p><ul><li>横向扩展能力，数据量或并发量增加时候架构可以自动扩容</li><li>灵活模型，适合迭代开发，数据模型多变场景</li><li>JSON 数据结构，适合微服务/REST API</li></ul><h2 id=44-关系型数据库迁移>44 关系型数据库迁移<a hidden class=anchor aria-hidden=true href=#44-关系型数据库迁移>#</a></h2><p>从基于关系型数据库应用迁移到 MongoDB 的理由：</p><ul><li>高并发需求（数千 - 数十万 ops），关系型数据库不容易扩展</li><li>快速迭代 - 关系型模式太严谨</li><li>灵活的 JSON 模式</li><li>大数据量需求</li><li>地理位置查询</li><li>多数据中心跨地域部署</li></ul><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://time.geekbang.org/course/intro/100040001>MongoDB 高手课</a></li><li><a href=https://github.com/minhhungit/mongodb-cluster-docker-compose>mongodb-cluster-docker-compose</a></li></ul><p>&ndash; EOF &ndash;</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zyf.im/tags/mongodb/>Mongodb</a></li></ul><nav class=paginav><a class=prev href=https://zyf.im/2024/07/01/php-migrating-81-to-82/><span class=title>« Prev</span><br><span>PHP Migrating 8.1 to 8.2</span>
</a><a class=next href=https://zyf.im/2023/03/09/hands-on-ddd-part1/><span class=title>Next »</span><br><span>手把手教你落地 DDD Part1</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://zyf.im/>ZYF.IM BLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>