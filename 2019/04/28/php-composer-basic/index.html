<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="PHP composer 基本原理">




  <meta name="keywords" content="php, composer, Yifans_Z Blog">










  <link rel="alternate" href="/atom.xml" title="Yifans_Z Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.3">



<link rel="canonical" href="https://zyf.im/2019/04/28/php-composer-basic/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">






<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.3">



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-84666938-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-84666938-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "er5hlK0M8mWKUTrVtqnHl97N-gzGzoHsz",
      appKey: "a6lIOEoJs3ijGvj3eP2rkFGG"
    });
  </script>





<script>
  window.config = {"leancloud":{"app_id":"er5hlK0M8mWKUTrVtqnHl97N-gzGzoHsz","app_key":"a6lIOEoJs3ijGvj3eP2rkFGG"},"toc":true,"fancybox":true,"pjax":false};
</script>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-2330747317815601",
    enable_page_level_ads: true
  });
</script>

    <title> PHP composer 基本原理 - Yifans_Z Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Yifans_Z Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Yifans_Z Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          PHP composer 基本原理
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-04-28
        </span>
        
        
        <span class="post-visits" data-url="/2019/04/28/php-composer-basic/" data-title="PHP composer 基本原理">
          阅读次数 0
        </span>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#启动"><span class="toc-text">启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#autoload-real-php"><span class="toc-text">autoload_real.php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单例模式-1"><span class="toc-text">单例模式 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构造-ClassLoader-核心类-2"><span class="toc-text">构造 ClassLoader 核心类 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化核心类对象-3"><span class="toc-text">初始化核心类对象 3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#autoload-static-静态初始化"><span class="toc-text">autoload_static 静态初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#classMap"><span class="toc-text">classMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PSR0-顶级命名空间映射"><span class="toc-text">PSR0 顶级命名空间映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PSR4-标准顶级命名空间映射"><span class="toc-text">PSR4 标准顶级命名空间映射</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用接口初始化"><span class="toc-text">调用接口初始化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注册核心类对象-4"><span class="toc-text">注册核心类对象 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自动加载全局函数-5"><span class="toc-text">自动加载全局函数 5</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题-1"><span class="toc-text">问题 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题-2"><span class="toc-text">问题 2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行"><span class="toc-text">运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PSR4"><span class="toc-text">PSR4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PSR0"><span class="toc-text">PSR0</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Q-amp-A"><span class="toc-text">Q&amp;A</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#防止用户自定义与-ClassLoader-命名空间冲突"><span class="toc-text">防止用户自定义与 ClassLoader 命名空间冲突</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#composer-StaticLoader-有什么优势"><span class="toc-text">composer StaticLoader 有什么优势</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-text">References</span></a></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <p><img src="https://cdn-qn.yifans.com/imzyf/dayne-topkin-60559-unsplash.jpg" alt="php-composer-basic"></p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p><code>public/index.php</code>：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Register The Auto Loader</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../vendor/autoload.php'</span>;</span><br></pre></td></tr></table></figure>
<p><code>autoload.php</code> 不负责具体功能逻辑，只做了两件事：初始化自动加载类、注册自动加载类。</p>
<p><code>autoload_real.php</code> 中的类名为 <code>ComposerAutoloaderInit...</code> 这可能是为防止与用户自定义类名跟这个类重复冲突，加上了哈希值。</p>
<p>其实还有一个做法我们更加熟悉，是定义一个命名空间。这里为什么不定义一个命名空间呢？一种理解：命名空间一般都是为了复用，而这个类只需要运行一次即可，以后也不会用得到，用哈希值更加合适。</p>
<a id="more"></a>
<h2 id="autoload-real-php"><a href="#autoload-real-php" class="headerlink" title="autoload_real.php"></a>autoload_real.php</h2><p><code>autoload.php</code> 主要调用了 <code>getLoader()</code>：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 单例模式，自动加载类只能有一个 1</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得自动加载核心类对象 2</span></span><br><span class="line">    spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit76e88f0b305cd64c7c84b90b278c31db'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br><span class="line">    spl_autoload_unregister(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit76e88f0b305cd64c7c84b90b278c31db'</span>, <span class="string">'loadClassLoader'</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化自动加载核心类对象 3</span></span><br><span class="line">    $useStaticLoader = PHP_VERSION_ID &gt;= <span class="number">50600</span> &amp;&amp; !defined(<span class="string">'HHVM_VERSION'</span>) &amp;&amp; (!function_exists(<span class="string">'zend_loader_file_encoded'</span>) || !zend_loader_file_encoded());</span><br><span class="line">    <span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">        <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_static.php'</span>;</span><br><span class="line"></span><br><span class="line">        call_user_func(\Composer\Autoload\ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db::getInitializer($loader));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">            $loader-&gt;set($namespace, $path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">            $loader-&gt;setPsr4($namespace, $path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</span><br><span class="line">        <span class="keyword">if</span> ($classMap) &#123;</span><br><span class="line">            $loader-&gt;addClassMap($classMap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册自动加载核心类对象 4</span></span><br><span class="line">    $loader-&gt;register(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动加载全局函数 5</span></span><br><span class="line">    <span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">        $includeFiles = Composer\Autoload\ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db::$files;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $includeFiles = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_files.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</span><br><span class="line">        composerRequire76e88f0b305cd64c7c84b90b278c31db($fileIdentifier, $file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $loader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="单例模式-1"><a href="#单例模式-1" class="headerlink" title="单例模式 1"></a>单例模式 1</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="构造-ClassLoader-核心类-2"><a href="#构造-ClassLoader-核心类-2" class="headerlink" title="构造 ClassLoader 核心类 2"></a>构造 ClassLoader 核心类 2</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit76e88f0b305cd64c7c84b90b278c31db'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br><span class="line">spl_autoload_unregister(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit76e88f0b305cd64c7c84b90b278c31db'</span>, <span class="string">'loadClassLoader'</span>));</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClassLoader</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'Composer\Autoload\ClassLoader'</span> === $class) &#123;</span><br><span class="line">        <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/ClassLoader.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>composer</code> 先向 <code>PHP</code> 自动加载机制注册了一个函数，这个函数 <code>require</code> 了 <code>ClassLoader</code> 文件。成功 <code>new</code> 出该文件中核心类 <code>ClassLoader()</code> 后，又销毁了该函数。</p>
<p>为什么不直接 <code>require</code>？原因是：怕有的用户也定义了个 <code>\Composer\Autoload\ClassLoader</code> 命名空间，导致自动加载错误文件。</p>
<p>那为什么不跟引导类一样用个哈希值呢？原因是：这个类是可以复用的，框架允许用户使用这个类。</p>
<h2 id="初始化核心类对象-3"><a href="#初始化核心类对象-3" class="headerlink" title="初始化核心类对象 3"></a>初始化核心类对象 3</h2><p>对自动加载类的初始化，主要是给自动加载核心类初始化顶级命名空间映射。初始化的方法有两种：</p>
<ol>
<li>使用 <code>autoload_static</code> 进行静态初始化</li>
<li>调用核心类接口初始化</li>
</ol>
<h3 id="autoload-static-静态初始化"><a href="#autoload-static-静态初始化" class="headerlink" title="autoload_static 静态初始化"></a>autoload_static 静态初始化</h3><p>静态初始化只支持 <code>PHP 5.6</code> 以上版本、不支持 <code>HHVM</code> 虚拟机、不存在 <code>Zend-encoded file</code>。</p>
<p><code>autoload_static.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// autoload_static.php @generated by Composer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Composer</span>\<span class="title">Autoload</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hash 防止冲突</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $files = <span class="keyword">array</span> (...);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $prefixLengthsPsr4 = <span class="keyword">array</span> (...);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $prefixDirsPsr4 = <span class="keyword">array</span> (...);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $fallbackDirsPsr4 = <span class="keyword">array</span> (...);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $prefixesPsr0 = <span class="keyword">array</span> (...);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $classMap = <span class="keyword">array</span> <span class="keyword">array</span> (...);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInitializer</span><span class="params">(ClassLoader $loader)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> \Closure::bind(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($loader)</span> </span>&#123;</span><br><span class="line">            $loader-&gt;prefixLengthsPsr4 = ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db::$prefixLengthsPsr4;</span><br><span class="line">            $loader-&gt;prefixDirsPsr4 = ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db::$prefixDirsPsr4;</span><br><span class="line">            $loader-&gt;fallbackDirsPsr4 = ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db::$fallbackDirsPsr4;</span><br><span class="line">            $loader-&gt;prefixesPsr0 = ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db::$prefixesPsr0;</span><br><span class="line">            $loader-&gt;classMap = ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db::$classMap;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="keyword">null</span>, ClassLoader::class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个静态初始化类的核心就是 <code>getInitializer()</code> 函数，它将自己类中的顶级命名空间映射给了 ClassLoader 类。</p>
<p>值得注意的是这个函数返回的是一个匿名函数，为什么呢？原因就是 <code>ClassLoader</code> 中的 <code>prefixLengthsPsr4</code> 、<code>prefixDirsPsr4</code> 等等方法都是 <code>private</code> 的。普通的函数没办法给类的 <code>private</code> 成员变量赋值。利用匿名函数的绑定功能就可以将把匿名函数转为 <code>ClassLoader</code> 类的成员函数。</p>
<p>关于匿名函数的 <a href="http://www.cnblogs.com/yjf512/p/4421289.html" target="_blank" rel="noopener">绑定功能</a>。</p>
<p>接下来就是 顶级命名空间 初始化的关键了。</p>
<h4 id="classMap"><a href="#classMap" class="headerlink" title="classMap"></a>classMap</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $classMap = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'App\\Api\\Middleware\\DeviceRecord'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Api/Middleware/DeviceRecord.php'</span>,</span><br><span class="line">    <span class="string">'App\\Api\\Middleware\\HeaderCheck'</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/../..'</span> . <span class="string">'/app/Api/Middleware/HeaderCheck.php'</span>,</span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>直接命名空间全名与目录的映射，没有顶级命名空间。简单粗暴，也导致这个数组相当的大。</p>
<h4 id="PSR0-顶级命名空间映射"><a href="#PSR0-顶级命名空间映射" class="headerlink" title="PSR0 顶级命名空间映射"></a>PSR0 顶级命名空间映射</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $prefixesPsr0 = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'P'</span> =&gt;</span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="string">'Prophecy\\'</span> =&gt;</span><br><span class="line">        <span class="keyword">array</span> (</span><br><span class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpspec/prophecy/src'</span>,</span><br><span class="line">        ),</span><br><span class="line">        <span class="string">'Parsedown'</span> =&gt;</span><br><span class="line">        <span class="keyword">array</span> (</span><br><span class="line">            <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/erusev/parsedown'</span>,</span><br><span class="line">        ),</span><br><span class="line">    ),</span><br><span class="line">    ...</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>为了快速找到顶级命名空间，这里使用命名空间第一个字母作为前缀索引。这个映射的用法比较明显，假如我们有 <code>Parsedown/example</code> 这样的命名空间，首先通过首字母 <code>P</code>，找到：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">'P'</span> =&gt; <span class="keyword">array</span> (...)</span><br></pre></td></tr></table></figure>
<p>这个数组，然后就会遍历这个数组来和 <code>Parsedown/example</code> 比较，发现第一个 <code>Prophecy</code> 不符合，第二个 <code>Parsedown</code> 符合，然后得到了映射目录（映射目录可能不止一个）：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/erusev/parsedown'</span>,</span><br></pre></td></tr></table></figure>
<p>接着遍历这个数组，尝试 <code>__DIR__ . &#39;/..&#39; . &#39;/erusev/parsedown/Parsedown/example.php&#39;</code> 是否存在，如果不存在接着遍历数组（这个例子数组只有一个元素），如果数组遍历完都没有，就会加载失败。</p>
<h4 id="PSR4-标准顶级命名空间映射"><a href="#PSR4-标准顶级命名空间映射" class="headerlink" title="PSR4 标准顶级命名空间映射"></a>PSR4 标准顶级命名空间映射</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $prefixLengthsPsr4 = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'p'</span> =&gt;</span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="string">'phpDocumentor\\Reflection\\'</span> =&gt; <span class="number">25</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'Z'</span> =&gt;</span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="string">'Zend\\Diactoros\\'</span> =&gt; <span class="number">15</span>,</span><br><span class="line">    ),</span><br><span class="line">    ...</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $prefixDirsPsr4 = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'phpDocumentor\\Reflection\\'</span> =&gt;</span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-common/src'</span>,</span><br><span class="line">        <span class="number">1</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/reflection-docblock/src'</span>,</span><br><span class="line">        <span class="number">2</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/phpdocumentor/type-resolver/src'</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'Zend\\Diactoros\\'</span> =&gt;</span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/zendframework/zend-diactoros/src'</span>,</span><br><span class="line">    ),</span><br><span class="line">    ...</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><code>PSR4</code> 标准 <code>顶级命名空间</code> 映射用了两个数组，第一个和 <code>PSR0</code> 一样用命名空间第一个字母作为前缀索引，然后是 <code>顶级命名空间</code>，但是最终并不是文件路径，而是 <code>顶级命名空间</code> 的长度。为什么呢？因为 <code>PSR4</code> 的文件目录更加灵活，更加简洁。</p>
<p><code>PSR0</code> 中 <code>顶级命名空间</code> 目录 <strong>直接加</strong> 到命名空间前面就可以得到路径：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                                        ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span><br><span class="line">Parsedown/example =&gt; __DIR__ . &apos;/..&apos; . &apos;/erusev/parsedown/Parsedown/example.php</span><br><span class="line">                                                         ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span><br></pre></td></tr></table></figure>
<p>而 <code>PSR4</code> 却是用顶级命名空间目录 <strong>替换</strong> 顶级命名空间，所以获得顶级命名空间的 <strong>长度</strong> 很重要：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                                        ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span><br><span class="line">Parsedown/example =&gt; __DIR__ . &apos;/..&apos; . &apos;/erusev/parsedown/example.php</span><br><span class="line">                                                ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑</span><br></pre></td></tr></table></figure>
<p>举例：假如我们找 <code>Symfony\\Polyfill\\Mbstring\\example</code> 这个类，和 <code>PSR0</code> 一样通过前缀索引和字符串匹配我们得到了:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&apos;Symfony\\Polyfill\\Mbstring\\&apos; =&gt; 26,</span><br></pre></td></tr></table></figure>
<p>这条记录，键是顶级命名空间，值是命名空间的长度。拿到顶级命名空间后去 <code>$prefixDirsPsr4</code> 获取它的映射目录数组（注意映射目录可能不止一条）：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">'Symfony\\Polyfill\\Mbstring\\'</span> =&gt;</span><br><span class="line"><span class="keyword">array</span> (</span><br><span class="line">    <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">'/..'</span> . <span class="string">'/symfony/polyfill-mbstring'</span>,</span><br><span class="line">),</span><br></pre></td></tr></table></figure>
<p>将 <code>Symfony\\Polyfill\\Mbstring\\example</code> 前 26 个字母替换为 <code>__DIR__ . &#39;/..&#39; . &#39;/symfony/polyfill-mbstring</code> 也就是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">__DIR__ . &apos;/..&apos; . &apos;/symfony/polyfill-mbstring/example.php</span><br></pre></td></tr></table></figure>
<p>先验证磁盘上这个文件是否存在，如果不存在接着遍历。如果遍历后没有找到，则加载失败。</p>
<p>自动加载核心类 <code>ClassLoader</code> 的静态初始化完成！</p>
<blockquote>
<p>其实还有 <code>$fallbackDirsPsr4</code>，暂未研究</p>
</blockquote>
<h3 id="调用接口初始化"><a href="#调用接口初始化" class="headerlink" title="调用接口初始化"></a>调用接口初始化</h3><p>如果 <code>PHP</code> 版本低于 <code>5.6</code> 或者使用 <code>HHVM</code> 虚拟机环境或者存在 <code>zend_loader_file_encoded</code>，那么就要使用核心类的接口进行初始化。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">PSR0 取出命名空间的第一个字母作为索引，一个索引对应多个顶级命名空间，一个顶级命名空间对应多个目录路径，具体形式可以查看上面的 autoload_static 的 $prefixesPsr0。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">如果没有顶级命名空间，就只存储一个路径名，以便在后面尝试加载。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">$map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_namespaces.php'</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">    $loader-&gt;set($namespace, $path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">PSR4 如果没有顶级命名空间，就直接保存目录。</span></span><br><span class="line"><span class="comment">如果有命名空间的话，要保证顶级命名空间最后是 \，然后分别保存</span></span><br><span class="line"><span class="comment">( 前缀 -&gt; 顶级命名空间，顶级命名空间 -&gt; 顶级命名空间长度 )</span></span><br><span class="line"><span class="comment">( 顶级命名空间 -&gt; 目录 )</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">这两个映射数组。具体形式可以查看上面我们讲的 autoload_static 的 prefixLengthsPsr4、$prefixDirsPsr4 。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">$map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">    $loader-&gt;setPsr4($namespace, $path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">整个命名空间与目录之间的映射</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">$classMap = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_classmap.php'</span>;</span><br><span class="line"><span class="keyword">if</span> ($classMap) &#123;</span><br><span class="line">    $loader-&gt;addClassMap($classMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注册核心类对象-4"><a href="#注册核心类对象-4" class="headerlink" title="注册核心类对象 4"></a>注册核心类对象 4</h2><p>Composer 自动加载功能的启动与初始化，经过启动与初始化，自动加载核心类对象已经获得了顶级命名空间与相应目录的映射，换句话说，如果有命名空间 <code>App\Console\Kernel</code>，我们已经知道了 <code>App\</code> 对应的目录，接下来我们就要解决下面的就是 <code>\Console\Kernel</code> 这一段。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers this instance as an autoloader.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $prepend Whether to prepend the autoloader or not</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($prepend = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    spl_autoload_register(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'loadClass'</span>), <span class="keyword">true</span>, $prepend);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一行代码实现自动加载。核心在 <code>ClassLoader</code> 的 <code>loadClass()</code> 函数上，这个函数负责按照 <code>PSR</code> 标准将顶层命名空间以下的内容转为对应的目录，也就是上面所说的将 <code>App\Console\Kernel</code> 中 <code>Console\Kernel</code> 这一段转为目录。</p>
<h2 id="自动加载全局函数-5"><a href="#自动加载全局函数-5" class="headerlink" title="自动加载全局函数 5"></a>自动加载全局函数 5</h2><p><code>Composer</code> 不止可以自动加载命名空间，还可以加载全局函数。就是把全局函数写到特定的文件里面去，在程序运行前挨个 <code>require</code> 就行了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ($useStaticLoader) &#123;</span><br><span class="line">    <span class="comment">// 静态初始化</span></span><br><span class="line">    $includeFiles = Composer\Autoload\ComposerStaticInit76e88f0b305cd64c7c84b90b278c31db::$files;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 普通初始化</span></span><br><span class="line">    $includeFiles = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_files.php'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> ($includeFiles <span class="keyword">as</span> $fileIdentifier =&gt; $file) &#123;</span><br><span class="line">    composerRequire76e88f0b305cd64c7c84b90b278c31db($fileIdentifier, $file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">composerRequire76e88f0b305cd64c7c84b90b278c31db</span><span class="params">($fileIdentifier, $file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($GLOBALS[<span class="string">'__composer_autoload_files'</span>][$fileIdentifier])) &#123;</span><br><span class="line">        <span class="keyword">require</span> $file;</span><br><span class="line"></span><br><span class="line">        $GLOBALS[<span class="string">'__composer_autoload_files'</span>][$fileIdentifier] = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="问题-1"><a href="#问题-1" class="headerlink" title="问题 1"></a>问题 1</h3><p>为什么不直接 <code>require</code> <code>$includeFiles</code> 里面的每个文件名，而要用类外面的函数 <code>composerRequire...</code> ？</p>
<ul>
<li>避免和用户定义函数冲突</li>
<li>防止有人在全局函数所在的文件写 <code>$this</code> 或者 <code>self</code></li>
</ul>
<p>假如 <code>$includeFiles</code> 有个 <code>app/helper.php</code> 文件，这个 <code>helper.php</code> 文件的函数外有一行代码： <code>$this-&gt;foo()</code>，如果引导类在 <code>getLoader()</code> 函数直接 <code>require($file)</code>，那么引导类就会运行这句代码，调用自己的 <code>foo()</code> 函数，这显然是错的。</p>
<p>事实上 <code>helper.php</code> 就不应该出现 <code>$this</code> 或 <code>self</code> 这样的代码，这样写一般都是用户写错了的，一旦这样的事情发生：</p>
<ul>
<li>第一种情况：引导类恰好有 <code>foo()</code> 函数，那么就会莫名其妙执行了引导类的 <code>foo()</code>。</li>
<li>第二种情况：引导类没有 <code>foo()</code> 函数，但是却甩出来引导类没有 <code>foo()</code> 方法这样的错误提示，用户不知道自己哪里错了。把 <code>require</code> 语句放到 <strong>引导类的外面</strong>，遇到 <code>$this</code> 或者 <code>self</code> ，程序就会告诉用户根本没有类， <code>$this</code> 或 <code>self</code> 无效，错误信息更加明朗。</li>
</ul>
<h3 id="问题-2"><a href="#问题-2" class="headerlink" title="问题 2"></a>问题 2</h3><p>为什么要用 <code>hash</code> 作为 <code>$fileIdentifier</code>？</p>
<p>这个变量是用来控制全局函数只被 <code>require</code> 一次的，那为什么不用 <code>require_once</code> 呢？事实上 <code>require_once</code> 比 <code>require</code> 效率低很多，使用全局变量 <code>$GLOBALS</code> 这样控制加载会更快。猜测另一个原因应该是 <code>require_once</code> 对相对路径的支持并不理想，所以 <code>composer</code> 尽量少用 <code>require_once</code>。</p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p><code>ClassLoader</code> 将 <code>loadClass()</code> 函数注册到 <code>PHP SPL</code> 中的 <code>spl_autoload_register()</code> 里面去。这样，每当 PHP 遇到一个不认识的命名空间的时候，PHP 会自动调用注册到 <code>spl_autoload_register()</code> 里面的函数堆栈，运行其中的每个函数，直到找到命名空间对应的文件。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Loads the given class or interface.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string    $class The name of the class</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> bool|null True if loaded, null otherwise</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClass</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($file = <span class="keyword">$this</span>-&gt;findFile($class)) &#123;</span><br><span class="line">        includeFile($file); <span class="comment">// include $file; Prevents access to $this/self from included files.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finds the path to the file where the class is defined.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $class The name of the class</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string|false The path if found, false otherwise</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findFile</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// class map lookup</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;classMap[$class])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;classMap[$class];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// classMapAuthoritative 关闭搜索未在类映射中注册的类的 prefix and fallback directories。- 不清楚干啥的 暂没研究</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;classMapAuthoritative || <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;missingClasses[$class])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果启用扩展名，则使用 APCu 前缀来缓存已找到/未找到的类。 - 不清楚干啥的 暂没研究</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">$this</span>-&gt;apcuPrefix) &#123;</span><br><span class="line">        $file = apcu_fetch(<span class="keyword">$this</span>-&gt;apcuPrefix.$class, $hit);</span><br><span class="line">        <span class="keyword">if</span> ($hit) &#123;</span><br><span class="line">            <span class="keyword">return</span> $file;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $file = <span class="keyword">$this</span>-&gt;findFileWithExtension($class, <span class="string">'.php'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Search for Hack files if we are running on HHVM</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $file &amp;&amp; defined(<span class="string">'HHVM_VERSION'</span>)) &#123;</span><br><span class="line">        $file = <span class="keyword">$this</span>-&gt;findFileWithExtension($class, <span class="string">'.hh'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">$this</span>-&gt;apcuPrefix) &#123;</span><br><span class="line">        apcu_add(<span class="keyword">$this</span>-&gt;apcuPrefix.$class, $file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $file) &#123;</span><br><span class="line">        <span class="comment">// Remember that this class does not exist.</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;missingClasses[$class] = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>loadClass()</code> 主要调用 <code>findFile()</code> 函数。<code>findFile()</code> 在解析命名空间的时候主要分为两部分：</p>
<ul>
<li><code>classMap</code> 直接看命名空间是否在映射数组</li>
<li><code>findFileWithExtension()</code> 包含了 <code>PSR0</code>、<code>PSR4</code></li>
</ul>
<p>如果我们在代码中写 <code>&#39;phpDocumentor\Reflection\example</code>，PHP 会通过 SPL 调用 <code>loadClass</code> -&gt; <code>findFile</code> -&gt; <code>findFileWithExtension</code>。</p>
<ul>
<li>首先默认用 <code>.php</code> 后缀名调用 <code>findFileWithExtension</code> 函数里，利用 <code>PSR4</code> 标准尝试解析目录文件，如果文件不存在则继续用 <code>PSR0</code> 标准解析</li>
<li>如果解析出来的目录文件仍然不存在，但是环境是 <code>HHVM</code> 虚拟机，继续用后缀名 <code>.hh</code> 再次调用 <code>findFileWithExtension</code> 函数，如果不存在，说明此命名空间无法加载，放到 <code>classMap</code> 中设为 <code>false</code>，以便以后更快地加载</li>
</ul>
<h3 id="PSR4"><a href="#PSR4" class="headerlink" title="PSR4"></a>PSR4</h3><p>对于 <code>phpDocumentor\Reflection\example</code>，当尝试利用 <code>PSR4</code> 标准映射目录时，步骤如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// $class: phpDocumentor\Reflection\example</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PSR-4 lookup</span></span><br><span class="line">$logicalPathPsr4 = strtr($class, <span class="string">'\\'</span>, DIRECTORY_SEPARATOR) . $ext;</span><br><span class="line"><span class="comment">// $logicalPathPsr4: phpDocumentor/Reflection/example.php(hh)`</span></span><br><span class="line"></span><br><span class="line">$first = $class[<span class="number">0</span>];</span><br><span class="line"><span class="comment">// $first: p</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;prefixLengthsPsr4[$first])) &#123;</span><br><span class="line">    <span class="comment">/* 'p' =&gt;</span></span><br><span class="line"><span class="comment">    array (</span></span><br><span class="line"><span class="comment">        'phpDocumentor\\Reflection\\' =&gt; 25,</span></span><br><span class="line"><span class="comment">    ),</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    $subPath = $class;</span><br><span class="line">    <span class="comment">// $subPath: phpDocumentor\Reflection\example</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">false</span> !== $lastPos = strrpos($subPath, <span class="string">'\\'</span>)) &#123;</span><br><span class="line">        <span class="comment">// $lastPos 13</span></span><br><span class="line">        $subPath = substr($subPath, <span class="number">0</span>, $lastPos);</span><br><span class="line">        $search = $subPath.<span class="string">'\\'</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;prefixDirsPsr4[$search])) &#123;</span><br><span class="line">            <span class="comment">// search phpDocumentor\\Reflection\\</span></span><br><span class="line">            <span class="comment">// $lastPos 25</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 'phpDocumentor\\Reflection\\' =&gt;</span></span><br><span class="line"><span class="comment">                array (</span></span><br><span class="line"><span class="comment">                    0 =&gt; __DIR__ . '/..' . '/phpdocumentor/reflection-common/src',</span></span><br><span class="line"><span class="comment">                    1 =&gt; __DIR__ . '/..' . '/phpdocumentor/reflection-docblock/src',</span></span><br><span class="line"><span class="comment">                    2 =&gt; __DIR__ . '/..' . '/phpdocumentor/type-resolver/src',</span></span><br><span class="line"><span class="comment">                ),</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            $pathEnd = DIRECTORY_SEPARATOR . substr($logicalPathPsr4, $lastPos + <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// $pathEnd /example.php(hh)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;prefixDirsPsr4[$search] <span class="keyword">as</span> $dir) &#123;</span><br><span class="line">                <span class="comment">// 遍历 3 个</span></span><br><span class="line">                <span class="keyword">if</span> (file_exists($file = $dir . $pathEnd)) &#123;</span><br><span class="line">                    <span class="comment">// $file __DIR__ . '/..' . /phpdocumentor/type-resolver/src/example.php(hh)`</span></span><br><span class="line">                    <span class="keyword">return</span> $file;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PSR0"><a href="#PSR0" class="headerlink" title="PSR0"></a>PSR0</h3><p>如果 <code>PSR4</code> 标准加载失败，则要进行 <code>PSR0</code> 标准加载。对于 <code>phpDocumentor\Reflection\example</code>，当尝试利用 <code>PSR0</code> 标准映射目录时，步骤如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// $class: phpDocumentor\Reflection\example</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PSR-0 lookup</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span> !== $pos = strrpos($class, <span class="string">'\\'</span>)) &#123;</span><br><span class="line">    <span class="comment">// namespaced class name</span></span><br><span class="line">    $logicalPathPsr0 = substr($logicalPathPsr4, <span class="number">0</span>, $pos + <span class="number">1</span>)</span><br><span class="line">        . strtr(substr($logicalPathPsr4, $pos + <span class="number">1</span>), <span class="string">'_'</span>, DIRECTORY_SEPARATOR);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// PEAR-like class name</span></span><br><span class="line">    $logicalPathPsr0 = strtr($class, <span class="string">'_'</span>, DIRECTORY_SEPARATOR) . $ext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $logicalPathPsr0: phpDocumentor/Reflection/example.php(hh)`</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;prefixesPsr0[$first])) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;prefixesPsr0[$first] <span class="keyword">as</span> $prefix =&gt; $dirs) &#123;</span><br><span class="line">        <span class="comment">/* 'P' =&gt;</span></span><br><span class="line"><span class="comment">        array (</span></span><br><span class="line"><span class="comment">            'Prophecy\\' =&gt;</span></span><br><span class="line"><span class="comment">            array (</span></span><br><span class="line"><span class="comment">                0 =&gt; __DIR__ . '/..' . '/phpspec/prophecy/src',</span></span><br><span class="line"><span class="comment">            ),</span></span><br><span class="line"><span class="comment">            'Parsedown' =&gt;</span></span><br><span class="line"><span class="comment">            array (</span></span><br><span class="line"><span class="comment">                0 =&gt; __DIR__ . '/..' . '/erusev/parsedown',</span></span><br><span class="line"><span class="comment">            ),</span></span><br><span class="line"><span class="comment">        ), */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> === strpos($class, $prefix)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($dirs <span class="keyword">as</span> $dir) &#123;</span><br><span class="line">                <span class="keyword">if</span> (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr0)) &#123;</span><br><span class="line">                    <span class="comment">// $file __DIR__ . '/..' . '/phpspec/prophecy/src' . phpDocumentor/Reflection/example.php(hh)</span></span><br><span class="line">                    <span class="keyword">return</span> $file;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><p>个人一些疑问：</p>
<h3 id="防止用户自定义与-ClassLoader-命名空间冲突"><a href="#防止用户自定义与-ClassLoader-命名空间冲突" class="headerlink" title="防止用户自定义与 ClassLoader 命名空间冲突"></a>防止用户自定义与 ClassLoader 命名空间冲突</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit76e88f0b305cd64c7c84b90b278c31db'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br><span class="line">spl_autoload_unregister(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit76e88f0b305cd64c7c84b90b278c31db'</span>, <span class="string">'loadClassLoader'</span>));</span><br></pre></td></tr></table></figure>
<p>为什么这样可以解决：与用户也定义了个 <code>\Composer\Autoload\ClassLoader</code> 命名空间，导致自动加载错误文件。</p>
<p>与第四个参数 <code>$prepend</code> <code>true</code> 有关吗？</p>
<h3 id="composer-StaticLoader-有什么优势"><a href="#composer-StaticLoader-有什么优势" class="headerlink" title="composer StaticLoader 有什么优势"></a>composer StaticLoader 有什么优势</h3><p><code>composer</code> 在加载类和加载全局方法时，都有两种方式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$useStaticLoader = PHP_VERSION_ID &gt;= 50600 &amp;&amp; !defined(&apos;HHVM_VERSION&apos;) &amp;&amp; (!function_exists(&apos;zend_loader_file_encoded&apos;) || !zend_loader_file_encoded());</span><br></pre></td></tr></table></figure>
<p>以 <code>$useStaticLoader</code> 的值进行选择，为什么一定分两种，静态方法是有什么优势吗？</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><blockquote>
<ul>
<li><a href="https://github.com/imzyf/reboot-php" target="_blank" rel="noopener">imzyf/reboot-php - relearning PHP</a></li>
<li><a href="https://github.com/LeoYang90/laravel-source-analysis/blob/master/PHP%20Composer%E2%80%94%E2%80%94%20%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md" target="_blank" rel="noopener">PHP Composer - 初始化源码分析</a></li>
</ul>
</blockquote>
<p>– EOF –</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://zyf.im">Yifans_Z</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://zyf.im/2019/04/28/php-composer-basic/">https://zyf.im/2019/04/28/php-composer-basic/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden>
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="https://cdn-qn.yifans.com/imzyf/reward_wechat.jpg" title="wechat">
        </label>
      
      
    </div>
  </div>


    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/php/">php</a>
            
              <a href="/tags/composer/">composer</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2019/05/20/my-macbook/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">My MacBook</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2019/04/10/php-strpos-warning/">
        <span class="next-text nav-default">PHP 请小心判断 strpos</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:168@yifans.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
        
          <a href="https://github.com/imzyf" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="https://stackoverflow.com/users/5958443/yifan" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" rel="nofollow" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" rel="nofollow" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    &copy;
    
      2016 -
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Yifans_Z</span>
  </span>
</div>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=11262529;
var sc_invisible=1;
var sc_security="476b93ef";
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="web analytics" href="http://statcounter.com/" target="_blank"><img class="statcounter" src="//c.statcounter.com/11262529/0/476b93ef/1/" alt="web
analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://zyf.im/2019/04/28/php-composer-basic/';
        this.page.identifier = '2019/04/28/php-composer-basic/';
        this.page.title = 'PHP composer 基本原理';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//yifans.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  







  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.3"></script>

  </body>
</html>
