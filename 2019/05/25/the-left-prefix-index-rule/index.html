<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>最左前缀原理与相关优化 | ZYF.IM BLOG</title><meta name=keywords content="mysql"><meta name=description content="MySQL 中的索引可以以一定顺序引用多个列，这种索引叫做联合索引，一般的，一个联合索引是一个有序元组 <a1, a2, …, an>，其中各个元素均为数据表的一列。另外，单列索引可以看成联合索引元素数为 1 的特例。
我们在 Employees Sample Database 中实验，MySQL 版本 5.7。

以 employees.titles 为例，查看其索引：
SHOW INDEX FROM employees.titles;

+--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table  | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| titles |          0 | PRIMARY  |            1 | emp_no      | A         |      301292 |     NULL | NULL   |      | BTREE      |         |               |
| titles |          0 | PRIMARY  |            2 | title       | A         |      442605 |     NULL | NULL   |      | BTREE      |         |               |
| titles |          0 | PRIMARY  |            3 | from_date   | A         |      442605 |     NULL | NULL   |      | BTREE      |         |               |
+--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
全列匹配
EXPLAIN SELECT * FROM employees.titles
WHERE
 emp_no = '10009'
 AND title = 'Senior Engineer'
 AND from_date = '1995-02-18';

+----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
| id | select_type | table  | partitions | type  | possible_keys | key     | key_len | ref               | rows | filtered | Extra |
+----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
|  1 | SIMPLE      | titles | NULL       | const | PRIMARY       | PRIMARY | 159     | const,const,const |    1 |   100.00 | NULL  |
+----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
当按照索引中所有列进行精确匹配（这里精确匹配指 = 或 IN 匹配）时，索引可以被用到。"><meta name=author content="Me"><link rel=canonical href=https://zyf.im/2019/05/25/the-left-prefix-index-rule/><link crossorigin=anonymous href=/assets/css/stylesheet.63618a0fd0c7dd946ad6f368012c097fc6e5a8464cefd289c140dd28c01ec58d.css integrity="sha256-Y2GKD9DH3ZRq1vNoASwJf8blqEZM79KJwUDdKMAexY0=" rel="preload stylesheet" as=style><link rel=icon href=https://zyf.im/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zyf.im/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zyf.im/favicon-32x32.png><link rel=apple-touch-icon href=https://zyf.im/apple-touch-icon.png><link rel=mask-icon href=https://zyf.im/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zyf.im/2019/05/25/the-left-prefix-index-rule/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6DVZ6E58DG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6DVZ6E58DG")}</script><meta property="og:url" content="https://zyf.im/2019/05/25/the-left-prefix-index-rule/"><meta property="og:site_name" content="ZYF.IM BLOG"><meta property="og:title" content="最左前缀原理与相关优化"><meta property="og:description" content="MySQL 中的索引可以以一定顺序引用多个列，这种索引叫做联合索引，一般的，一个联合索引是一个有序元组 <a1, a2, …, an>，其中各个元素均为数据表的一列。另外，单列索引可以看成联合索引元素数为 1 的特例。
我们在 Employees Sample Database 中实验，MySQL 版本 5.7。
以 employees.titles 为例，查看其索引：
SHOW INDEX FROM employees.titles; +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ | titles | 0 | PRIMARY | 1 | emp_no | A | 301292 | NULL | NULL | | BTREE | | | | titles | 0 | PRIMARY | 2 | title | A | 442605 | NULL | NULL | | BTREE | | | | titles | 0 | PRIMARY | 3 | from_date | A | 442605 | NULL | NULL | | BTREE | | | +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ 全列匹配 EXPLAIN SELECT * FROM employees.titles WHERE emp_no = '10009' AND title = 'Senior Engineer' AND from_date = '1995-02-18'; +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ | 1 | SIMPLE | titles | NULL | const | PRIMARY | PRIMARY | 159 | const,const,const | 1 | 100.00 | NULL | +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ 当按照索引中所有列进行精确匹配（这里精确匹配指 = 或 IN 匹配）时，索引可以被用到。"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-25T11:05:46+08:00"><meta property="article:modified_time" content="2019-05-25T11:05:46+08:00"><meta property="article:tag" content="Mysql"><meta property="og:image" content="https://images.unsplash.com/photo-1525081905268-fc0b46e9d786?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=960&amp;q=80"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1525081905268-fc0b46e9d786?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=960&amp;q=80"><meta name=twitter:title content="最左前缀原理与相关优化"><meta name=twitter:description content="MySQL 中的索引可以以一定顺序引用多个列，这种索引叫做联合索引，一般的，一个联合索引是一个有序元组 <a1, a2, …, an>，其中各个元素均为数据表的一列。另外，单列索引可以看成联合索引元素数为 1 的特例。
我们在 Employees Sample Database 中实验，MySQL 版本 5.7。

以 employees.titles 为例，查看其索引：
SHOW INDEX FROM employees.titles;

+--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table  | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| titles |          0 | PRIMARY  |            1 | emp_no      | A         |      301292 |     NULL | NULL   |      | BTREE      |         |               |
| titles |          0 | PRIMARY  |            2 | title       | A         |      442605 |     NULL | NULL   |      | BTREE      |         |               |
| titles |          0 | PRIMARY  |            3 | from_date   | A         |      442605 |     NULL | NULL   |      | BTREE      |         |               |
+--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
全列匹配
EXPLAIN SELECT * FROM employees.titles
WHERE
 emp_no = '10009'
 AND title = 'Senior Engineer'
 AND from_date = '1995-02-18';

+----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
| id | select_type | table  | partitions | type  | possible_keys | key     | key_len | ref               | rows | filtered | Extra |
+----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
|  1 | SIMPLE      | titles | NULL       | const | PRIMARY       | PRIMARY | 159     | const,const,const |    1 |   100.00 | NULL  |
+----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
当按照索引中所有列进行精确匹配（这里精确匹配指 = 或 IN 匹配）时，索引可以被用到。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zyf.im/posts/"},{"@type":"ListItem","position":2,"name":"最左前缀原理与相关优化","item":"https://zyf.im/2019/05/25/the-left-prefix-index-rule/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"最左前缀原理与相关优化","name":"最左前缀原理与相关优化","description":"MySQL 中的索引可以以一定顺序引用多个列，这种索引叫做联合索引，一般的，一个联合索引是一个有序元组 \u0026lt;a1, a2, …, an\u0026gt;，其中各个元素均为数据表的一列。另外，单列索引可以看成联合索引元素数为 1 的特例。\n我们在 Employees Sample Database 中实验，MySQL 版本 5.7。\n以 employees.titles 为例，查看其索引：\nSHOW INDEX FROM employees.titles; +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ | titles | 0 | PRIMARY | 1 | emp_no | A | 301292 | NULL | NULL | | BTREE | | | | titles | 0 | PRIMARY | 2 | title | A | 442605 | NULL | NULL | | BTREE | | | | titles | 0 | PRIMARY | 3 | from_date | A | 442605 | NULL | NULL | | BTREE | | | +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ 全列匹配 EXPLAIN SELECT * FROM employees.titles WHERE emp_no = \u0026#39;10009\u0026#39; AND title = \u0026#39;Senior Engineer\u0026#39; AND from_date = \u0026#39;1995-02-18\u0026#39;; +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ | 1 | SIMPLE | titles | NULL | const | PRIMARY | PRIMARY | 159 | const,const,const | 1 | 100.00 | NULL | +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ 当按照索引中所有列进行精确匹配（这里精确匹配指 = 或 IN 匹配）时，索引可以被用到。\n","keywords":["mysql"],"articleBody":"MySQL 中的索引可以以一定顺序引用多个列，这种索引叫做联合索引，一般的，一个联合索引是一个有序元组 ，其中各个元素均为数据表的一列。另外，单列索引可以看成联合索引元素数为 1 的特例。\n我们在 Employees Sample Database 中实验，MySQL 版本 5.7。\n以 employees.titles 为例，查看其索引：\nSHOW INDEX FROM employees.titles; +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ | titles | 0 | PRIMARY | 1 | emp_no | A | 301292 | NULL | NULL | | BTREE | | | | titles | 0 | PRIMARY | 2 | title | A | 442605 | NULL | NULL | | BTREE | | | | titles | 0 | PRIMARY | 3 | from_date | A | 442605 | NULL | NULL | | BTREE | | | +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+ 全列匹配 EXPLAIN SELECT * FROM employees.titles WHERE emp_no = '10009' AND title = 'Senior Engineer' AND from_date = '1995-02-18'; +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ | 1 | SIMPLE | titles | NULL | const | PRIMARY | PRIMARY | 159 | const,const,const | 1 | 100.00 | NULL | +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ 当按照索引中所有列进行精确匹配（这里精确匹配指 = 或 IN 匹配）时，索引可以被用到。\n这里有一点需要注意，理论上索引对顺序是敏感的，但是由于 MySQL 的 查询优化器会自动调整 where 子句的条件顺序 以使用适合的索引，例如我们将 where 中的条件顺序颠倒：\nEXPLAIN SELECT * FROM employees.titles WHERE from_date = '1995-02-18' AND emp_no IN ( '10009' ) AND title = 'Senior Engineer'; +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ | 1 | SIMPLE | titles | NULL | const | PRIMARY | PRIMARY | 159 | const,const,const | 1 | 100.00 | NULL | +----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+ 和上面是一样的。\n最左前缀匹配 EXPLAIN SELECT * FROM employees.titles WHERE emp_no = '10009'; +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------+ | 1 | SIMPLE | titles | NULL | ref | PRIMARY | PRIMARY | 4 | const | 3 | 100.00 | NULL | +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------+ 当查询条件精确匹配索引的 左边连续一个或几个列 时，如 或 ，所以可以被用到，但是只能用到一部分，即条件所组成的最左前缀。\n上面的查询从分析结果看用到了 PRIMARY 索引，但是 key_len 为 4，说明只用到了索引的第一列前缀。\n中间某个条件未提供 查询条件用到了索引中列的精确匹配，但是中间某个条件未提供。\nEXPLAIN SELECT * FROM employees.titles WHERE emp_no='10009' AND from_date='1995-02-18'; +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | ref | PRIMARY | PRIMARY | 4 | const | 1 | 10.00 | Using where | +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+ 此时索引使用情况和情况二相同，因为 title 未提供，所以查询只用到了索引的第一列，而后面的 from_date 虽然也在索引中，但是由于 title 不存在而无法和左前缀连接，因此需要对结果进行扫描过滤 from_date（这里由于 emp_no 唯一，所以不存在扫描）。\n如果想让 from_date 也使用索引而不是 where 过滤，可以增加一个 辅助索引 ，此时上面的查询会使用这个索引。\n除此之外，还可以使用一种称之为 隔离列 的优化方法，将 emp_no 与 from_date 之间的 坑 填上。\n首先我们看下 title 有几种不同的值：\nSELECT DISTINCT(title) FROM employees.titles; 只有 7 种。在这种成为 坑 的列值比较少的情况下，可以考虑用 IN 来填补这个 坑 从而形成最左前缀：\nEXPLAIN SELECT * FROM employees.titles WHERE emp_no='10009' AND title IN ('Senior Engineer', 'Staff', 'Engineer', 'Senior Staff', 'Assistant Engineer', 'Technique Leader', 'Manager') AND from_date='1995-02-18'; +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | range | PRIMARY | PRIMARY | 159 | NULL | 7 | 100.00 | Using where | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ 这次 key_len 为 159，说明索引被用全了，但是从 type 和 rows 看出 IN 实际上执行了一个 range 查询，这里检查了 7 个 key。看下两种查询的性能比较：\nSET profiling = 1; SELECT * FROM... -- 1 SELECT * FROM... -- 2 SHOW PROFILES; | Query_ID | Duration | Query | +----------+------------+---------+ | 1 | 0.00083950 | SELECT * ..| | 2 | 0.00063700 | SELECT * ..| “填坑” 后性能提升了一点。如果经过 emp_no 筛选后余下很多数据，则后者性能优势会更加明显。当然，如果 title 的值很多，用填坑就不合适了，必须建立辅助索引。（笔者：多次测试后发现是有快有慢，可能是数据的原因，效果并不明显）\n查询条件没有指定索引第一列 EXPLAIN SELECT * FROM employees.titles WHERE from_date='1995-02-18'; +----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | 1 | SIMPLE | titles | NULL | ALL | NULL | NULL | NULL | NULL | 442605 | 10.00 | Using where | +----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+ 由于不是最左前缀，索引这样的查询显然用不到索引。\n匹配某列的前缀字符串 EXPLAIN SELECT * FROM employees.titles WHERE emp_no=10009 AND title LIKE 'Senior%'; +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | range | PRIMARY | PRIMARY | 156 | NULL | 1 | 100.00 | Using where | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ 此时可以用到索引，如果通配符 % 不出现在开头，则可以用到索引，但根据具体情况不同可能只会用其中一个前缀。\n范围查询 EXPLAIN SELECT * FROM employees.titles WHERE emp_no \u003c '10010' and title = 'Senior Engineer'; +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | range | PRIMARY | PRIMARY | 4 | NULL | 14 | 10.00 | Using where | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ 范围列可以用到索引（必须是最左前缀），但是范围列后面的列无法用到索引。同时，索引最多用于一个范围列，因此如果查询条件中有两个范围列则无法全用到索引。\nEXPLAIN SELECT * FROM employees.titles WHERE emp_no \u003c '10010' AND title = 'Senior Engineer' AND from_date BETWEEN '1986-01-01' AND '1986-12-31'; +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | range | PRIMARY | PRIMARY | 4 | NULL | 14 | 1.11 | Using where | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ 可以看到索引对第二个范围索引无能为力。这里特别要说明 MySQL 一个有意思的地方，那就是仅用 explain 可能无法区分 范围索引 和 多值匹配，因为在 type 中这两者都显示为 range。\n同时，用了 between 并不意味着就是范围查询，例如下面的查询：\nEXPLAIN SELECT * FROM employees.titles WHERE emp_no BETWEEN '10001' AND '10010' AND title='Senior Engineer' AND from_date BETWEEN '1986-01-01' AND '1986-12-31'; +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | range | PRIMARY | PRIMARY | 159 | NULL | 15 | 1.11 | Using where | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ 看起来是用了两个范围查询，但作用于 emp_no 上的 BETWEEN 实际上相当于 IN，也就是说 emp_no 实际是多值精确匹配。可以看到这个查询用到了索引全部三个列。因此在 MySQL 中要谨慎地区分多值匹配和范围匹配，否则会对 MySQL 的行为产生困惑。\n还有个值得注意的事情：\nEXPLAIN SELECT * FROM employees.titles where emp_no \u003e 10000 AND emp_no \u003c 10011 AND title='Senior Engineer' AND from_date BETWEEN '1986-01-01' AND '1986-12-31'; +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | range | PRIMARY | PRIMARY | 4 | NULL | 15 | 1.11 | Using where | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ EXPLAIN SELECT * FROM employees.titles where emp_no \u003e= 10001 and emp_no \u003c= 10010 AND title='Senior Engineer' AND from_date BETWEEN '1986-01-01' AND '1986-12-31'; +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | range | PRIMARY | PRIMARY | 159 | NULL | 15 | 1.11 | Using where | +----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+ 疑问：= 影响 范围索引 还是 多值匹配？\n查询条件中含有函数或表达式 很不幸，如果查询条件中含有函数或表达式，则 MySQL 不会为这列使用索引（虽然某些在数学意义上可以使用）。例如：\nEXPLAIN SELECT * FROM employees.titles WHERE emp_no='10009' AND left(title, 6)='Senior'; +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+ | 1 | SIMPLE | titles | NULL | ref | PRIMARY | PRIMARY | 4 | const | 3 | 100.00 | Using where | +----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+ 虽然这个查询和情况五中功能相同，但是由于使用了函数 left，则无法为 title 列应用索引，而情况五中用 LIKE 则可以。\nEXPLAIN SELECT * FROM employees.titles WHERE emp_no - 1 = 10000; +----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | 1 | SIMPLE | titles | NULL | ALL | NULL | NULL | NULL | NULL | 442605 | 100.00 | Using where | +----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+ 显然这个查询等价于查询 emp_no 为 10001 的函数，但是由于查询条件是一个表达式，MySQL 无法为其使用索引。看来 MySQL 还没有智能到自动优化常量表达式的程度，因此在写查询语句时尽量避免表达式出现在查询中，而是先手工私下代数运算，转换为无表达式的查询语句。\nReferences MySQL 索引背后的数据结构及算法原理 13.7.5.30 SHOW PROFILE Syntax – EOF –\n","wordCount":"1297","inLanguage":"en","image":"https://images.unsplash.com/photo-1525081905268-fc0b46e9d786?ixlib=rb-1.2.1\u0026ixid=eyJhcHBfaWQiOjEyMDd9\u0026auto=format\u0026fit=crop\u0026w=960\u0026q=80","datePublished":"2019-05-25T11:05:46+08:00","dateModified":"2019-05-25T11:05:46+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zyf.im/2019/05/25/the-left-prefix-index-rule/"},"publisher":{"@type":"Organization","name":"ZYF.IM BLOG","logo":{"@type":"ImageObject","url":"https://zyf.im/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zyf.im/ accesskey=h title="ZYF.IM (Alt + H)"><img src=https://zyf.im/apple-touch-icon.png alt aria-label=logo height=35>ZYF.IM</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zyf.im/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://zyf.im/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zyf.im/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://zyf.im/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zyf.im/>Home</a>&nbsp;»&nbsp;<a href=https://zyf.im/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">最左前缀原理与相关优化</h1><div class=post-meta><span title='2019-05-25 11:05:46 +0800 CST'>May 25, 2019</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1297 words&nbsp;·&nbsp;Me</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#全列匹配>全列匹配</a></li><li><a href=#最左前缀匹配>最左前缀匹配</a></li><li><a href=#中间某个条件未提供>中间某个条件未提供</a></li><li><a href=#查询条件没有指定索引第一列>查询条件没有指定索引第一列</a></li><li><a href=#匹配某列的前缀字符串>匹配某列的前缀字符串</a></li><li><a href=#范围查询>范围查询</a></li><li><a href=#查询条件中含有函数或表达式>查询条件中含有函数或表达式</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><p>MySQL 中的索引可以以一定顺序引用多个列，这种索引叫做联合索引，一般的，一个联合索引是一个有序元组 <code>&lt;a1, a2, …, an></code>，其中各个元素均为数据表的一列。另外，单列索引可以看成联合索引元素数为 1 的特例。</p><p>我们在 <a href=https://dev.mysql.com/doc/employee/en/employees-installation.html>Employees Sample Database</a> 中实验，MySQL 版本 5.7。</p><p>以 employees.titles 为例，查看其索引：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SHOW</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=k>Table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>Non_unique</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Key_name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Seq_in_index</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Column_name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Collation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Cardinality</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Sub_part</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Packed</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Null</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Index_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Comment</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Index_comment</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w>          </span><span class=mi>0</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>  </span><span class=o>|</span><span class=w>            </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>emp_no</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>A</span><span class=w>         </span><span class=o>|</span><span class=w>      </span><span class=mi>301292</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>   </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>BTREE</span><span class=w>      </span><span class=o>|</span><span class=w>         </span><span class=o>|</span><span class=w>               </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w>          </span><span class=mi>0</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>  </span><span class=o>|</span><span class=w>            </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>title</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>A</span><span class=w>         </span><span class=o>|</span><span class=w>      </span><span class=mi>442605</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>   </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>BTREE</span><span class=w>      </span><span class=o>|</span><span class=w>         </span><span class=o>|</span><span class=w>               </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w>          </span><span class=mi>0</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>  </span><span class=o>|</span><span class=w>            </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>from_date</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>A</span><span class=w>         </span><span class=o>|</span><span class=w>      </span><span class=mi>442605</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>   </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>BTREE</span><span class=w>      </span><span class=o>|</span><span class=w>         </span><span class=o>|</span><span class=w>               </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span></span></code></pre></div><h2 id=全列匹配>全列匹配<a hidden class=anchor aria-hidden=true href=#全列匹配>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;10009&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Senior Engineer&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>from_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;1995-02-18&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>               </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>const</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>159</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>const</span><span class=p>,</span><span class=n>const</span><span class=p>,</span><span class=n>const</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>100</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
</span></span></span></code></pre></div><p>当按照索引中所有列进行精确匹配（这里精确匹配指 <code>=</code> 或 <code>IN</code> 匹配）时，索引可以被用到。</p><p>这里有一点需要注意，理论上索引对顺序是敏感的，但是由于 MySQL 的 <strong>查询优化器会自动调整 where 子句的条件顺序</strong> 以使用适合的索引，例如我们将 <code>where</code> 中的条件顺序颠倒：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>from_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;1995-02-18&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=s1>&#39;10009&#39;</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Senior Engineer&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>               </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>const</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>159</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>const</span><span class=p>,</span><span class=n>const</span><span class=p>,</span><span class=n>const</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>100</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+-------------------+------+----------+-------+
</span></span></span></code></pre></div><p>和上面是一样的。</p><h2 id=最左前缀匹配>最左前缀匹配<a hidden class=anchor aria-hidden=true href=#最左前缀匹配>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;10009&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>4</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>const</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>100</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------+
</span></span></span></code></pre></div><p>当查询条件精确匹配索引的 <strong>左边连续一个或几个列</strong> 时，如 <code>&lt;emp_no></code> 或 <code>&lt;emp_no, title></code>，所以可以被用到，但是只能用到一部分，即条件所组成的最左前缀。</p><p>上面的查询从分析结果看用到了 <code>PRIMARY</code> 索引，但是 <code>key_len</code> 为 4，说明只用到了索引的第一列前缀。</p><h2 id=中间某个条件未提供>中间某个条件未提供<a hidden class=anchor aria-hidden=true href=#中间某个条件未提供>#</a></h2><p>查询条件用到了索引中列的精确匹配，但是中间某个条件未提供。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>emp_no</span><span class=o>=</span><span class=s1>&#39;10009&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>from_date</span><span class=o>=</span><span class=s1>&#39;1995-02-18&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>4</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>const</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>10</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+
</span></span></span></code></pre></div><p>此时索引使用情况和情况二相同，因为 <code>title</code> 未提供，所以查询只用到了索引的第一列，而后面的 <code>from_date</code> 虽然也在索引中，但是由于 <code>title</code> 不存在而无法和左前缀连接，因此需要对结果进行扫描过滤 <code>from_date</code>（这里由于 <code>emp_no</code> 唯一，所以不存在扫描）。</p><p>如果想让 <code>from_date</code> 也使用索引而不是 <code>where</code> 过滤，可以增加一个 <em>辅助索引</em> <code>&lt;emp_no, from_date></code>，此时上面的查询会使用这个索引。</p><p>除此之外，还可以使用一种称之为 <strong>隔离列</strong> 的优化方法，将 <code>emp_no</code> 与 <code>from_date</code> 之间的 <em>坑</em> 填上。</p><p>首先我们看下 <code>title</code> 有几种不同的值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=p>(</span><span class=n>title</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>只有 7 种。在这种成为 <em>坑</em> 的列值比较少的情况下，可以考虑用 <code>IN</code> 来填补这个 <em>坑</em> 从而形成最左前缀：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>emp_no</span><span class=o>=</span><span class=s1>&#39;10009&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Senior Engineer&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Staff&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Engineer&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Senior Staff&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Assistant Engineer&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Technique Leader&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Manager&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>from_date</span><span class=o>=</span><span class=s1>&#39;1995-02-18&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>159</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>7</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>100</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span></code></pre></div><p>这次 <code>key_len</code> 为 <code>159</code>，说明索引被用全了，但是从 <code>type</code> 和 <code>rows</code> 看出 <code>IN</code> 实际上执行了一个 <code>range</code> 查询，这里检查了 7 个 key。看下两种查询的性能比较：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=n>profiling</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=p>...</span><span class=w>  </span><span class=c1>-- 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=p>...</span><span class=w> </span><span class=c1>-- 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SHOW</span><span class=w> </span><span class=n>PROFILES</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>Query_ID</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Duration</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>Query</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----------+------------+---------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>00083950</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>..</span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>        </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>00063700</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>..</span><span class=o>|</span><span class=w>
</span></span></span></code></pre></div><p>“填坑” 后性能提升了一点。如果经过 <code>emp_no</code> 筛选后余下很多数据，则后者性能优势会更加明显。当然，如果 <code>title</code> 的值很多，用填坑就不合适了，必须建立辅助索引。（笔者：多次测试后发现是有快有慢，可能是数据的原因，效果并不明显）</p><h2 id=查询条件没有指定索引第一列>查询条件没有指定索引第一列<a hidden class=anchor aria-hidden=true href=#查询条件没有指定索引第一列>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>from_date</span><span class=o>=</span><span class=s1>&#39;1995-02-18&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>ALL</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>442605</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>10</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+
</span></span></span></code></pre></div><p>由于不是最左前缀，索引这样的查询显然用不到索引。</p><h2 id=匹配某列的前缀字符串>匹配某列的前缀字符串<a hidden class=anchor aria-hidden=true href=#匹配某列的前缀字符串>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>emp_no</span><span class=o>=</span><span class=mi>10009</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;Senior%&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>156</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>100</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span></code></pre></div><p>此时可以用到索引，如果通配符 <code>%</code> 不出现在开头，则可以用到索引，但根据具体情况不同可能只会用其中一个前缀。</p><h2 id=范围查询>范围查询<a hidden class=anchor aria-hidden=true href=#范围查询>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=s1>&#39;10010&#39;</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Senior Engineer&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>4</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>14</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>10</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span></code></pre></div><p>范围列可以用到索引（必须是最左前缀），但是范围列后面的列无法用到索引。同时，索引最多用于一个范围列，因此如果查询条件中有两个范围列则无法全用到索引。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=s1>&#39;10010&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Senior Engineer&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>from_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;1986-01-01&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;1986-12-31&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>4</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>14</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=mi>1</span><span class=p>.</span><span class=mi>11</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span></code></pre></div><p>可以看到索引对第二个范围索引无能为力。这里特别要说明 MySQL 一个有意思的地方，那就是仅用 explain 可能无法区分 范围索引 和 多值匹配，因为在 <code>type</code> 中这两者都显示为 <code>range</code>。</p><p>同时，用了 <code>between</code> 并不意味着就是范围查询，例如下面的查询：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;10001&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;10010&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>title</span><span class=o>=</span><span class=s1>&#39;Senior Engineer&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>from_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;1986-01-01&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;1986-12-31&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>159</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>15</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=mi>1</span><span class=p>.</span><span class=mi>11</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span></code></pre></div><p>看起来是用了两个范围查询，但作用于 <code>emp_no</code> 上的 <code>BETWEEN</code> 实际上相当于 <code>IN</code>，也就是说 <code>emp_no</code> 实际是多值精确匹配。可以看到这个查询用到了索引全部三个列。因此在 MySQL 中要谨慎地区分多值匹配和范围匹配，否则会对 MySQL 的行为产生困惑。</p><p>还有个值得注意的事情：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10000</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10011</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>title</span><span class=o>=</span><span class=s1>&#39;Senior Engineer&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>from_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;1986-01-01&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;1986-12-31&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>4</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>15</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=mi>1</span><span class=p>.</span><span class=mi>11</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>10001</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>10010</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>title</span><span class=o>=</span><span class=s1>&#39;Senior Engineer&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>from_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;1986-01-01&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;1986-12-31&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>range</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>159</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>15</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=mi>1</span><span class=p>.</span><span class=mi>11</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span></code></pre></div><blockquote><p>疑问：<code>=</code> 影响 范围索引 还是 多值匹配？</p></blockquote><h2 id=查询条件中含有函数或表达式>查询条件中含有函数或表达式<a hidden class=anchor aria-hidden=true href=#查询条件中含有函数或表达式>#</a></h2><p>很不幸，如果查询条件中含有函数或表达式，则 MySQL 不会为这列使用索引（虽然某些在数学意义上可以使用）。例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>emp_no</span><span class=o>=</span><span class=s1>&#39;10009&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>left</span><span class=p>(</span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=mi>6</span><span class=p>)</span><span class=o>=</span><span class=s1>&#39;Senior&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>4</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=n>const</span><span class=w> </span><span class=o>|</span><span class=w>    </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>100</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+---------+---------+-------+------+----------+-------------+
</span></span></span></code></pre></div><p>虽然这个查询和情况五中功能相同，但是由于使用了函数 left，则无法为 title 列应用索引，而情况五中用 LIKE 则可以。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXPLAIN</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>.</span><span class=n>titles</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>emp_no</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>select_type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>table</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>possible_keys</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>key</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>key_len</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ref</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>rows</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Extra</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SIMPLE</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>titles</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=k>ALL</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>442605</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>100</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Using</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=c1>----+-------------+--------+------------+------+---------------+------+---------+------+--------+----------+-------------+
</span></span></span></code></pre></div><p>显然这个查询等价于查询 <code>emp_no</code> 为 <code>10001</code> 的函数，但是由于查询条件是一个表达式，MySQL 无法为其使用索引。看来 MySQL 还没有智能到自动优化常量表达式的程度，因此在写查询语句时尽量避免表达式出现在查询中，而是先手工私下代数运算，转换为无表达式的查询语句。</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=http://blog.codinglabs.org/articles/theory-of-mysql-index.html>MySQL 索引背后的数据结构及算法原理</a></li><li><a href=https://dev.mysql.com/doc/refman/5.7/en/show-profile.html>13.7.5.30 SHOW PROFILE Syntax</a></li></ul><p>&ndash; EOF &ndash;</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zyf.im/tags/mysql/>Mysql</a></li></ul><nav class=paginav><a class=prev href=https://zyf.im/2019/06/04/git-commit-message-style-guide/><span class=title>« Prev</span><br><span>Git 提交 message 规范</span>
</a><a class=next href=https://zyf.im/2019/05/23/merge-sort/><span class=title>Next »</span><br><span>归并排序</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://zyf.im/>ZYF.IM BLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>